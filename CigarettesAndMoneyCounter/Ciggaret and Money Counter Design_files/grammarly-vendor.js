function emitter(obj){var topics={};obj=obj||{};obj.emit=function(topic,data){topic=processTopic(topic);var listeners=topics[topic];if(!listeners)return;var _listeners=listeners.concat();for(var i=0;i<_listeners.length;i++){_listeners[i](data)}};obj.emitArgs=function(topic){topic=processTopic(topic);var listeners=topics[topic],args=[].slice.call(arguments,1);if(!listeners)return;var _listeners=listeners.concat();for(var i=0;i<_listeners.length;i++){_listeners[i].apply(null,args)}};obj.on=function(topic,cb){topic=processTopic(topic);topics[topic]=topics[topic]||[];topics[topic].push(cb);return{un:function(){obj.un(topic,cb)}}};obj.off=obj.un=function(topic,cb){topic=processTopic(topic);var listeners=topics[topic];if(!listeners)return;var index=listeners.indexOf(cb);if(index>-1){listeners.splice(index,1);listeners.length>0||delete topics[topic]}};obj.one=function(topic,cb){var listener=obj.on(topic,function(){listener.un();cb.apply(null,arguments)})};obj.delegate=function(delegateTo,topic,delegateTopic){topic=processTopic(topic);obj.on(topic,function(data){delegateTo.emit(delegateTopic||topic,data)})};return obj;function processTopic(topic){return topic.join?topic.join(" "):topic}}try{module.exports=emitter}catch(e){}if(typeof module!="undefined")module.exports=require("./lib/emitter");(function(){function diffPos(oldText,newText){var td=textdiff(oldText,newText);if(td.from==undefined){return{s:-1,delta:0}}return{s:td.from,delta:td.newFragment.length-td.oldFragment.length}}function textdiff(oldText,newText){if(oldText===newText)return{};var oL=oldText.length;var nL=newText.length;trace("oldLength: "+oL+". newLength: "+nL);if(nL>oL){if(newText.substr(0,oL)===oldText){trace("some characters was added to the end");return{from:oL,to:oL,oldFragment:"",newFragment:newText.substr(oL)}}if(newText.substr(nL-oL)===oldText){trace("some characters was added to the start");return{from:0,to:0,oldFragment:"",newFragment:newText.substr(0,nL-oL)}}}if(nL<oL){if(oldText.substr(oL-nL)===newText){trace("some characters was removed from the end");return{from:0,to:oL-nL,oldFragment:oldText.substr(0,oL-nL),newFragment:""}}if(oldText.substr(0,nL)===newText){trace("some characters was removed from the start");return{from:nL,to:oL,oldFragment:oldText.substr(nL),newFragment:""}}}var minL=nL<oL?nL:oL;var front=calculateFront(oldText,newText,minL),back=calculateBack(oldText,newText,oL,nL,minL);trace("front: "+front);trace("back: "+back);if(front+back>oL){back-=front+back-oL}if(front+back>nL){back-=front+back-nL}return{from:front,to:oL-back,oldFragment:oldText.substr(front,oL-back-front),newFragment:newText.substr(front,nL-back-front)}}function calculateFront(oldText,newText,minL){var front=0;while(oldText[front]===newText[front]&&front<minL){front+=1}return front}function calculateBack(oldText,newText,oL,nL,minL){var back=0;while(oldText[oL-back-1]===newText[nL-back-1]&&minL-back>=0){back+=1}return back}function trace(){}if(typeof module=="undefined"){window.diffPos=diffPos;window.textdiff=textdiff}try{module.exports={diffPos:diffPos,textdiff:textdiff}}catch(e){}})();if(typeof module!="undefined")module.exports=require("./lib/textdiff");_=require("lodash"),emitter=require("emitter");function createWs(options){var WebSocketClass=window.WebSocket||window.MozWebSocket,socket,standByStatus=false,activityTimer=null,connected=false,closedByMe=false,closeWhenConnected=false,reconnectTimer,idleTimer,reconnectTime=1e3,initialReconnectTime=1e3,maxReconnectTime=6e4,messageQueue=[],emiterQueue=[],emiterQueueId,playTimerId,isPaused=false;options=_.extend({url:null,connectionTimeout:1e3,idleTimeout:5*6e4,useQueue:false,useStandBy:false,playDelay:50,resetQueueOnReconnect:false},options);var ws=emitter({connect:connect,send:function(message){if(standByStatus){wakeUp(message)}var strMessage=JSON.stringify(message);messageQueue.push(strMessage);dequeue()},close:function(){closedByMe=true;log("explicit close requested");if(!connected){return closeWhenConnected=true}try{socket&&socket.close();if(reconnectTimer){clearTimeout(reconnectTimer);reconnectTimer=null}}catch(e){logError("socket closing bug",e.stack||e)}connected=false;if(activityTimer){clearTimeout(activityTimer)}},reconnect:function(doEmit){ws.close();ws.connect(doEmit)},isConnected:function(){return connected},release:function(){clearTimeout(reconnectTimer)},toString:function(){return"[object WebSocket]"},wsPlay:function(){clearTimeout(playTimerId);playTimerId=setTimeout(function(){isPaused=false;emiterWorker()},options.playDelay)},wsPause:function(){clearTimeout(playTimerId);isPaused=true}});return ws;function connect(re){log("connect to url: "+options.url);socket=new WebSocketClass(options.url);closedByMe=false;connected=false;socket.onopen=function(){reconnectTime=initialReconnectTime;connected=true;if(closeWhenConnected){closeWhenConnected=false;ws.close()}if(re&&options.resetQueueOnReconnect){messageQueue=[]}else{dequeue()}ws.emit("connect");re&&ws.emit("reconnect")};socket.onmessage=function(msg){console.log("%c Received: %s","color: #46af91;",msg.data);activity(msg.data);handleMessage(msg.data)};socket.onclose=function(){connected=false;ws.emit("disconnect");if(!closedByMe){handleError("disconnected")}};socket.onerror=handleError;window.app&&app.one("offline",function(){if(!connected)return;ws.close();app.one("online",function(){ws.connect()})})}function activity(msg){if(!options.useStandBy||!msg||hasPingPong(msg)){return}clearTimeout(activityTimer);activityTimer=setTimeout(function(){ws.close();standByStatus=true;activityTimer=false},options.useStandBy)}function hasPingPong(msg){if(msg&&msg=="ping"){return true}var message,result=false;try{message=JSON.parse(msg)}catch(e){}if(message&&(message=="ping"||message.action&&message.action=="pong")){result=true}return result}function wakeUp(message){if(hasPingPong(message)){return false}if(standByStatus){standByStatus=false;connect(true)}}function dequeue(){if(!socket)return;while(socket.readyState==WebSocketClass.OPEN&&messageQueue.length){send(messageQueue.shift())}}function send(message){console.log("%c Sending %s","color:rgba(10, 10, 10, 0.6); font-size: 10px",message);activity(message);socket.send(message);if(idleTimer)clearTimeout(idleTimer);idleTimer=setTimeout(ping,options.idleTimeout)}function ping(){idleTimer=null;ws.send("ping")}function handleMessage(msg){try{msg=JSON.parse(msg)}catch(e){logError(e.stack||e,msg)}if(options.useQueue){emiterQueue.push(msg);emiterWorker()}else{ws.emit("message",msg)}}function handleError(data){logError("websocket error",data);ws.emit("error",data);if(data&&data.target&&[WebSocketClass.CLOSING,WebSocketClass.CLOSED].indexOf(data.target.readyState)>-1){return}if(reconnectTimer){return}if(connected){ws.close()}log("try to reconnect in "+reconnectTime/1e3+"s");reconnectTimer=setTimeout(function(){reconnectTime=Math.min(maxReconnectTime,reconnectTime*1.5);reconnectTimer=null;connect(true)},reconnectTime)}function log(){console.log.apply(console,arguments)}function logError(){console.error.apply(console,arguments)}function emiterWorker(){if(emiterQueueId||isPaused){return}if(emiterQueue.length===0){emiterQueueId=null;return}emiterQueueId=setTimeout(function(){if(!isPaused){ws.emit("message",emiterQueue.shift())}emiterQueueId=null;emiterWorker()},options.useQueue)}}try{module.exports=createWs}catch(e){}if(typeof module!="undefined")module.exports=require("./lib/websocket");(function(){var undefined;var arrayPool=[],objectPool=[];var idCounter=0;var indicatorObject={};var keyPrefix=+new Date+"";var largeArraySize=75;var maxPoolSize=40;var whitespace=" 	\f ﻿"+"\n\r\u2028\u2029"+" ᠎             　";var reEmptyStringLeading=/\b__p \+= '';/g,reEmptyStringMiddle=/\b(__p \+=) '' \+/g,reEmptyStringTrailing=/(__e\(.*?\)|\b__t\)) \+\n'';/g;var reEsTemplate=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g;var reFlags=/\w*$/;var reFuncName=/^\s*function[ \n\r\t]+\w/;var reInterpolate=/<%=([\s\S]+?)%>/g;var reLeadingSpacesAndZeros=RegExp("^["+whitespace+"]*0+(?=.$)");var reNoMatch=/($^)/;var reThis=/\bthis\b/;var reUnescapedString=/['\n\r\t\u2028\u2029\\]/g;var contextProps=["Array","Boolean","Date","Error","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setTimeout"];var shadowedProps=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"];var templateCounter=0;var argsClass="[object Arguments]",arrayClass="[object Array]",boolClass="[object Boolean]",dateClass="[object Date]",errorClass="[object Error]",funcClass="[object Function]",numberClass="[object Number]",objectClass="[object Object]",regexpClass="[object RegExp]",stringClass="[object String]";var cloneableClasses={};cloneableClasses[funcClass]=false;cloneableClasses[argsClass]=cloneableClasses[arrayClass]=cloneableClasses[boolClass]=cloneableClasses[dateClass]=cloneableClasses[numberClass]=cloneableClasses[objectClass]=cloneableClasses[regexpClass]=cloneableClasses[stringClass]=true;var debounceOptions={leading:false,maxWait:0,trailing:false};var descriptor={configurable:false,enumerable:false,value:null,writable:false};var iteratorData={args:"",array:null,bottom:"",firstArg:"",init:"",keys:null,loop:"",shadowedProps:null,support:null,top:"",useHas:false};var objectTypes={"boolean":false,"function":true,object:true,number:false,string:false,undefined:false};var stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"};var root=objectTypes[typeof window]&&window||this;var freeExports=objectTypes[typeof exports]&&exports&&!exports.nodeType&&exports;var freeModule=objectTypes[typeof module]&&module&&!module.nodeType&&module;var moduleExports=freeModule&&freeModule.exports===freeExports&&freeExports;var freeGlobal=objectTypes[typeof global]&&global;if(freeGlobal&&(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal)){root=freeGlobal}function baseIndexOf(array,value,fromIndex){var index=(fromIndex||0)-1,length=array?array.length:0;while(++index<length){if(array[index]===value){return index}}return-1}function cacheIndexOf(cache,value){var type=typeof value;cache=cache.cache;if(type=="boolean"||value==null){return cache[value]?0:-1}if(type!="number"&&type!="string"){type="object"}var key=type=="number"?value:keyPrefix+value;cache=(cache=cache[type])&&cache[key];return type=="object"?cache&&baseIndexOf(cache,value)>-1?0:-1:cache?0:-1}function cachePush(value){var cache=this.cache,type=typeof value;if(type=="boolean"||value==null){cache[value]=true}else{if(type!="number"&&type!="string"){type="object"}var key=type=="number"?value:keyPrefix+value,typeCache=cache[type]||(cache[type]={});if(type=="object"){(typeCache[key]||(typeCache[key]=[])).push(value)}else{typeCache[key]=true}}}function charAtCallback(value){return value.charCodeAt(0)}function compareAscending(a,b){var ac=a.criteria,bc=b.criteria,index=-1,length=ac.length;while(++index<length){var value=ac[index],other=bc[index];if(value!==other){if(value>other||typeof value=="undefined"){return 1}if(value<other||typeof other=="undefined"){return-1}}}return a.index-b.index}function createCache(array){var index=-1,length=array.length,first=array[0],mid=array[length/2|0],last=array[length-1];if(first&&typeof first=="object"&&mid&&typeof mid=="object"&&last&&typeof last=="object"){return false}var cache=getObject();cache["false"]=cache["null"]=cache["true"]=cache["undefined"]=false;var result=getObject();result.array=array;result.cache=cache;result.push=cachePush;while(++index<length){result.push(array[index])}return result}function escapeStringChar(match){return"\\"+stringEscapes[match]}function getArray(){return arrayPool.pop()||[]}function getObject(){return objectPool.pop()||{array:null,cache:null,criteria:null,"false":false,index:0,"null":false,number:null,object:null,push:null,string:null,"true":false,undefined:false,value:null}}function isNode(value){return typeof value.toString!="function"&&typeof(value+"")=="string"}function releaseArray(array){array.length=0;if(arrayPool.length<maxPoolSize){arrayPool.push(array)}}function releaseObject(object){var cache=object.cache;if(cache){releaseObject(cache)}object.array=object.cache=object.criteria=object.object=object.number=object.string=object.value=null;if(objectPool.length<maxPoolSize){objectPool.push(object)}}function slice(array,start,end){start||(start=0);if(typeof end=="undefined"){end=array?array.length:0}var index=-1,length=end-start||0,result=Array(length<0?0:length);while(++index<length){result[index]=array[start+index]}return result}function runInContext(context){context=context?_.defaults(root.Object(),context,_.pick(root,contextProps)):root;var Array=context.Array,Boolean=context.Boolean,Date=context.Date,Error=context.Error,Function=context.Function,Math=context.Math,Number=context.Number,Object=context.Object,RegExp=context.RegExp,String=context.String,TypeError=context.TypeError;var arrayRef=[];var errorProto=Error.prototype,objectProto=Object.prototype,stringProto=String.prototype;var oldDash=context._;var toString=objectProto.toString;var reNative=RegExp("^"+String(toString).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");var ceil=Math.ceil,clearTimeout=context.clearTimeout,floor=Math.floor,fnToString=Function.prototype.toString,getPrototypeOf=isNative(getPrototypeOf=Object.getPrototypeOf)&&getPrototypeOf,hasOwnProperty=objectProto.hasOwnProperty,push=arrayRef.push,propertyIsEnumerable=objectProto.propertyIsEnumerable,setTimeout=context.setTimeout,splice=arrayRef.splice,unshift=arrayRef.unshift;var defineProperty=function(){try{var o={},func=isNative(func=Object.defineProperty)&&func,result=func(o,o,o)&&func}catch(e){}return result}();var nativeCreate=isNative(nativeCreate=Object.create)&&nativeCreate,nativeIsArray=isNative(nativeIsArray=Array.isArray)&&nativeIsArray,nativeIsFinite=context.isFinite,nativeIsNaN=context.isNaN,nativeKeys=isNative(nativeKeys=Object.keys)&&nativeKeys,nativeMax=Math.max,nativeMin=Math.min,nativeParseInt=context.parseInt,nativeRandom=Math.random;var ctorByClass={};ctorByClass[arrayClass]=Array;ctorByClass[boolClass]=Boolean;ctorByClass[dateClass]=Date;ctorByClass[funcClass]=Function;ctorByClass[objectClass]=Object;ctorByClass[numberClass]=Number;ctorByClass[regexpClass]=RegExp;ctorByClass[stringClass]=String;var nonEnumProps={};nonEnumProps[arrayClass]=nonEnumProps[dateClass]=nonEnumProps[numberClass]={constructor:true,toLocaleString:true,toString:true,valueOf:true};nonEnumProps[boolClass]=nonEnumProps[stringClass]={constructor:true,toString:true,valueOf:true};nonEnumProps[errorClass]=nonEnumProps[funcClass]=nonEnumProps[regexpClass]={constructor:true,toString:true};nonEnumProps[objectClass]={constructor:true};(function(){var length=shadowedProps.length;while(length--){var key=shadowedProps[length];for(var className in nonEnumProps){if(hasOwnProperty.call(nonEnumProps,className)&&!hasOwnProperty.call(nonEnumProps[className],key)){nonEnumProps[className][key]=false}}}})();function lodash(value){return value&&typeof value=="object"&&!isArray(value)&&hasOwnProperty.call(value,"__wrapped__")?value:new lodashWrapper(value)}function lodashWrapper(value,chainAll){this.__chain__=!!chainAll;this.__wrapped__=value}lodashWrapper.prototype=lodash.prototype;var support=lodash.support={};(function(){var ctor=function(){this.x=1},object={0:1,length:1},props=[];ctor.prototype={valueOf:1,y:1};for(var key in new ctor){props.push(key)}for(key in arguments){}support.argsClass=toString.call(arguments)==argsClass;support.argsObject=arguments.constructor==Object&&!(arguments instanceof Array);support.enumErrorProps=propertyIsEnumerable.call(errorProto,"message")||propertyIsEnumerable.call(errorProto,"name");support.enumPrototypes=propertyIsEnumerable.call(ctor,"prototype");support.funcDecomp=!isNative(context.WinRTError)&&reThis.test(runInContext);support.funcNames=typeof Function.name=="string";support.nonEnumArgs=key!=0;support.nonEnumShadows=!/valueOf/.test(props);support.ownLast=props[0]!="x";support.spliceObjects=(arrayRef.splice.call(object,0,1),!object[0]);support.unindexedChars="x"[0]+Object("x")[0]!="xx";try{support.nodeClass=!(toString.call(document)==objectClass&&!({toString:0}+""))}catch(e){support.nodeClass=true}})(1);lodash.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:reInterpolate,variable:"",imports:{_:lodash}};var iteratorTemplate=function(obj){var __p="var index, iterable = "+obj.firstArg+", result = "+obj.init+";\nif (!iterable) return result;\n"+obj.top+";";if(obj.array){__p+="\nvar length = iterable.length; index = -1;\nif ("+obj.array+") {  ";if(support.unindexedChars){__p+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "}__p+="\n  while (++index < length) {\n    "+obj.loop+";\n  }\n}\nelse {  "}else if(support.nonEnumArgs){__p+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+obj.loop+";\n    }\n  } else {  "}if(support.enumPrototypes){__p+="\n  var skipProto = typeof iterable == 'function';\n  "}if(support.enumErrorProps){__p+="\n  var skipErrorProps = iterable === errorProto || iterable instanceof Error;\n  "}var conditions=[];if(support.enumPrototypes){conditions.push('!(skipProto && index == "prototype")')}if(support.enumErrorProps){conditions.push('!(skipErrorProps && (index == "message" || index == "name"))')}if(obj.useHas&&obj.keys){__p+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] && keys(iterable),\n      length = ownProps ? ownProps.length : 0;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n";if(conditions.length){__p+="    if ("+conditions.join(" && ")+") {\n  "}__p+=obj.loop+";    ";if(conditions.length){__p+="\n    }"}__p+="\n  }  "}else{__p+="\n  for (index in iterable) {\n";if(obj.useHas){conditions.push("hasOwnProperty.call(iterable, index)")}if(conditions.length){__p+="    if ("+conditions.join(" && ")+") {\n  "}__p+=obj.loop+";    ";if(conditions.length){__p+="\n    }"}__p+="\n  }    ";if(support.nonEnumShadows){__p+="\n\n  if (iterable !== objectProto) {\n    var ctor = iterable.constructor,\n        isProto = iterable === (ctor && ctor.prototype),\n        className = iterable === stringProto ? stringClass : iterable === errorProto ? errorClass : toString.call(iterable),\n        nonEnum = nonEnumProps[className];\n      ";for(k=0;k<7;k++){__p+="\n    index = '"+obj.shadowedProps[k]+"';\n    if ((!(isProto && nonEnum[index]) && hasOwnProperty.call(iterable, index))";if(!obj.useHas){__p+=" || (!nonEnum[index] && iterable[index] !== objectProto[index])"}__p+=") {\n      "+obj.loop+";\n    }      "}__p+="\n  }    "}}if(obj.array||support.nonEnumArgs){__p+="\n}"}__p+=obj.bottom+";\nreturn result";return __p};function baseBind(bindData){var func=bindData[0],partialArgs=bindData[2],thisArg=bindData[4];function bound(){if(partialArgs){var args=slice(partialArgs);push.apply(args,arguments)}if(this instanceof bound){var thisBinding=baseCreate(func.prototype),result=func.apply(thisBinding,args||arguments);return isObject(result)?result:thisBinding}return func.apply(thisArg,args||arguments)}setBindData(bound,bindData);return bound}function baseClone(value,isDeep,callback,stackA,stackB){if(callback){var result=callback(value);if(typeof result!="undefined"){return result}}var isObj=isObject(value);if(isObj){var className=toString.call(value);if(!cloneableClasses[className]||!support.nodeClass&&isNode(value)){return value}var ctor=ctorByClass[className];switch(className){case boolClass:case dateClass:return new ctor(+value);case numberClass:case stringClass:return new ctor(value);case regexpClass:result=ctor(value.source,reFlags.exec(value));result.lastIndex=value.lastIndex;return result}}else{return value}var isArr=isArray(value);if(isDeep){var initedStack=!stackA;stackA||(stackA=getArray());stackB||(stackB=getArray());var length=stackA.length;while(length--){if(stackA[length]==value){return stackB[length]}}result=isArr?ctor(value.length):{}}else{result=isArr?slice(value):assign({},value)}if(isArr){if(hasOwnProperty.call(value,"index")){result.index=value.index}if(hasOwnProperty.call(value,"input")){result.input=value.input}}if(!isDeep){return result}stackA.push(value);stackB.push(result);(isArr?baseEach:forOwn)(value,function(objValue,key){result[key]=baseClone(objValue,isDeep,callback,stackA,stackB)});if(initedStack){releaseArray(stackA);releaseArray(stackB)}return result}function baseCreate(prototype,properties){return isObject(prototype)?nativeCreate(prototype):{}}if(!nativeCreate){baseCreate=function(){function Object(){}return function(prototype){if(isObject(prototype)){Object.prototype=prototype;var result=new Object;Object.prototype=null}return result||context.Object()}}()}function baseCreateCallback(func,thisArg,argCount){if(typeof func!="function"){return identity}if(typeof thisArg=="undefined"||!("prototype"in func)){return func}var bindData=func.__bindData__;if(typeof bindData=="undefined"){if(support.funcNames){bindData=!func.name}bindData=bindData||!support.funcDecomp;if(!bindData){var source=fnToString.call(func);if(!support.funcNames){bindData=!reFuncName.test(source)}if(!bindData){bindData=reThis.test(source);setBindData(func,bindData)}}}if(bindData===false||bindData!==true&&bindData[1]&1){return func}switch(argCount){case 1:return function(value){return func.call(thisArg,value)};case 2:return function(a,b){return func.call(thisArg,a,b)};case 3:return function(value,index,collection){return func.call(thisArg,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)}}return bind(func,thisArg)}function baseCreateWrapper(bindData){var func=bindData[0],bitmask=bindData[1],partialArgs=bindData[2],partialRightArgs=bindData[3],thisArg=bindData[4],arity=bindData[5];var isBind=bitmask&1,isBindKey=bitmask&2,isCurry=bitmask&4,isCurryBound=bitmask&8,key=func;function bound(){var thisBinding=isBind?thisArg:this;if(partialArgs){var args=slice(partialArgs);push.apply(args,arguments)}if(partialRightArgs||isCurry){args||(args=slice(arguments));if(partialRightArgs){push.apply(args,partialRightArgs)}if(isCurry&&args.length<arity){bitmask|=16&~32;return baseCreateWrapper([func,isCurryBound?bitmask:bitmask&~3,args,null,thisArg,arity])}}args||(args=arguments);if(isBindKey){func=thisBinding[key]}if(this instanceof bound){thisBinding=baseCreate(func.prototype);var result=func.apply(thisBinding,args);return isObject(result)?result:thisBinding}return func.apply(thisBinding,args)}setBindData(bound,bindData);return bound}function baseDifference(array,values){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,isLarge=length>=largeArraySize&&indexOf===baseIndexOf,result=[];if(isLarge){var cache=createCache(values);if(cache){indexOf=cacheIndexOf;values=cache}else{isLarge=false}}while(++index<length){var value=array[index];if(indexOf(values,value)<0){result.push(value)}}if(isLarge){releaseObject(values)}return result}function baseFlatten(array,isShallow,isStrict,fromIndex){var index=(fromIndex||0)-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(value&&typeof value=="object"&&typeof value.length=="number"&&(isArray(value)||isArguments(value))){if(!isShallow){value=baseFlatten(value,isShallow,isStrict)}var valIndex=-1,valLength=value.length,resIndex=result.length;result.length+=valLength;while(++valIndex<valLength){result[resIndex++]=value[valIndex]}}else if(!isStrict){result.push(value)}}return result}function baseIsEqual(a,b,callback,isWhere,stackA,stackB){if(callback){var result=callback(a,b);if(typeof result!="undefined"){return!!result}}if(a===b){return a!==0||1/a==1/b}var type=typeof a,otherType=typeof b;if(a===a&&!(a&&objectTypes[type])&&!(b&&objectTypes[otherType])){return false}if(a==null||b==null){return a===b}var className=toString.call(a),otherClass=toString.call(b);if(className==argsClass){className=objectClass}if(otherClass==argsClass){otherClass=objectClass}if(className!=otherClass){return false}switch(className){case boolClass:case dateClass:return+a==+b;case numberClass:return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case regexpClass:case stringClass:return a==String(b)}var isArr=className==arrayClass;if(!isArr){var aWrapped=hasOwnProperty.call(a,"__wrapped__"),bWrapped=hasOwnProperty.call(b,"__wrapped__");if(aWrapped||bWrapped){return baseIsEqual(aWrapped?a.__wrapped__:a,bWrapped?b.__wrapped__:b,callback,isWhere,stackA,stackB)}if(className!=objectClass||!support.nodeClass&&(isNode(a)||isNode(b))){return false}var ctorA=!support.argsObject&&isArguments(a)?Object:a.constructor,ctorB=!support.argsObject&&isArguments(b)?Object:b.constructor;if(ctorA!=ctorB&&!(isFunction(ctorA)&&ctorA instanceof ctorA&&isFunction(ctorB)&&ctorB instanceof ctorB)&&("constructor"in a&&"constructor"in b)){return false}}var initedStack=!stackA;stackA||(stackA=getArray());stackB||(stackB=getArray());var length=stackA.length;while(length--){if(stackA[length]==a){return stackB[length]==b}}var size=0;result=true;stackA.push(a);stackB.push(b);if(isArr){length=a.length;size=b.length;result=size==length;if(result||isWhere){while(size--){var index=length,value=b[size];if(isWhere){while(index--){if(result=baseIsEqual(a[index],value,callback,isWhere,stackA,stackB)){break}}}else if(!(result=baseIsEqual(a[size],value,callback,isWhere,stackA,stackB))){break}}}}else{forIn(b,function(value,key,b){if(hasOwnProperty.call(b,key)){size++;return result=hasOwnProperty.call(a,key)&&baseIsEqual(a[key],value,callback,isWhere,stackA,stackB)}});if(result&&!isWhere){forIn(a,function(value,key,a){if(hasOwnProperty.call(a,key)){return result=--size>-1}})}}stackA.pop();stackB.pop();if(initedStack){releaseArray(stackA);releaseArray(stackB)}return result}function baseMerge(object,source,callback,stackA,stackB){(isArray(source)?forEach:forOwn)(source,function(source,key){var found,isArr,result=source,value=object[key];if(source&&((isArr=isArray(source))||isPlainObject(source))){var stackLength=stackA.length;while(stackLength--){if(found=stackA[stackLength]==source){value=stackB[stackLength];break}}if(!found){var isShallow;if(callback){result=callback(value,source);if(isShallow=typeof result!="undefined"){value=result}}if(!isShallow){value=isArr?isArray(value)?value:[]:isPlainObject(value)?value:{}}stackA.push(source);stackB.push(value);if(!isShallow){baseMerge(value,source,callback,stackA,stackB)}}}else{if(callback){result=callback(value,source);if(typeof result=="undefined"){result=source}}if(typeof result!="undefined"){value=result}}object[key]=value})}function baseRandom(min,max){return min+floor(nativeRandom()*(max-min+1))}function baseUniq(array,isSorted,callback){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[];var isLarge=!isSorted&&length>=largeArraySize&&indexOf===baseIndexOf,seen=callback||isLarge?getArray():result;if(isLarge){var cache=createCache(seen);indexOf=cacheIndexOf;seen=cache}while(++index<length){var value=array[index],computed=callback?callback(value,index,array):value;if(isSorted?!index||seen[seen.length-1]!==computed:indexOf(seen,computed)<0){if(callback||isLarge){seen.push(computed)}result.push(value)}}if(isLarge){releaseArray(seen.array);releaseObject(seen)}else if(callback){releaseArray(seen)}return result}function createAggregator(setter){return function(collection,callback,thisArg){var result={};callback=lodash.createCallback(callback,thisArg,3);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];setter(result,value,callback(value,index,collection),collection)}}else{baseEach(collection,function(value,key,collection){setter(result,value,callback(value,key,collection),collection)})}return result}}function createWrapper(func,bitmask,partialArgs,partialRightArgs,thisArg,arity){var isBind=bitmask&1,isBindKey=bitmask&2,isCurry=bitmask&4,isCurryBound=bitmask&8,isPartial=bitmask&16,isPartialRight=bitmask&32;if(!isBindKey&&!isFunction(func)){throw new TypeError}if(isPartial&&!partialArgs.length){bitmask&=~16;isPartial=partialArgs=false}if(isPartialRight&&!partialRightArgs.length){bitmask&=~32;isPartialRight=partialRightArgs=false}var bindData=func&&func.__bindData__;if(bindData&&bindData!==true){bindData=slice(bindData);if(bindData[2]){bindData[2]=slice(bindData[2])}if(bindData[3]){bindData[3]=slice(bindData[3])}if(isBind&&!(bindData[1]&1)){bindData[4]=thisArg}if(!isBind&&bindData[1]&1){bitmask|=8}if(isCurry&&!(bindData[1]&4)){bindData[5]=arity}if(isPartial){push.apply(bindData[2]||(bindData[2]=[]),partialArgs)}if(isPartialRight){unshift.apply(bindData[3]||(bindData[3]=[]),partialRightArgs)}bindData[1]|=bitmask;return createWrapper.apply(null,bindData)}var creater=bitmask==1||bitmask===17?baseBind:baseCreateWrapper;return creater([func,bitmask,partialArgs,partialRightArgs,thisArg,arity])}function createIterator(){iteratorData.shadowedProps=shadowedProps;iteratorData.array=iteratorData.bottom=iteratorData.loop=iteratorData.top="";iteratorData.init="iterable";iteratorData.useHas=true;for(var object,index=0;object=arguments[index];index++){for(var key in object){iteratorData[key]=object[key]}}var args=iteratorData.args;iteratorData.firstArg=/^[^,]+/.exec(args)[0];var factory=Function("baseCreateCallback, errorClass, errorProto, hasOwnProperty, "+"indicatorObject, isArguments, isArray, isString, keys, objectProto, "+"objectTypes, nonEnumProps, stringClass, stringProto, toString","return function("+args+") {\n"+iteratorTemplate(iteratorData)+"\n}");return factory(baseCreateCallback,errorClass,errorProto,hasOwnProperty,indicatorObject,isArguments,isArray,isString,iteratorData.keys,objectProto,objectTypes,nonEnumProps,stringClass,stringProto,toString)}function escapeHtmlChar(match){return htmlEscapes[match]}function getIndexOf(){var result=(result=lodash.indexOf)===indexOf?baseIndexOf:result;return result}function isNative(value){return typeof value=="function"&&reNative.test(value)}var setBindData=!defineProperty?noop:function(func,value){descriptor.value=value;defineProperty(func,"__bindData__",descriptor)};function shimIsPlainObject(value){var ctor,result;if(!(value&&toString.call(value)==objectClass)||(ctor=value.constructor,isFunction(ctor)&&!(ctor instanceof ctor))||!support.argsClass&&isArguments(value)||!support.nodeClass&&isNode(value)){return false}if(support.ownLast){forIn(value,function(value,key,object){result=hasOwnProperty.call(object,key);return false});return result!==false}forIn(value,function(value,key){result=key});return typeof result=="undefined"||hasOwnProperty.call(value,result)}function unescapeHtmlChar(match){return htmlUnescapes[match]}function isArguments(value){return value&&typeof value=="object"&&typeof value.length=="number"&&toString.call(value)==argsClass||false}if(!support.argsClass){isArguments=function(value){return value&&typeof value=="object"&&typeof value.length=="number"&&hasOwnProperty.call(value,"callee")&&!propertyIsEnumerable.call(value,"callee")||false}}var isArray=nativeIsArray||function(value){return value&&typeof value=="object"&&typeof value.length=="number"&&toString.call(value)==arrayClass||false};var shimKeys=createIterator({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)"});var keys=!nativeKeys?shimKeys:function(object){if(!isObject(object)){return[]}if(support.enumPrototypes&&typeof object=="function"||support.nonEnumArgs&&object.length&&isArguments(object)){return shimKeys(object)}return nativeKeys(object)};var eachIteratorOptions={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : baseCreateCallback(callback, thisArg, 3)",array:"typeof length == 'number'",keys:keys,loop:"if (callback(iterable[index], index, collection) === false) return result"};var defaultsIteratorOptions={args:"object, source, guard",top:"var args = arguments,\n"+"    argsIndex = 0,\n"+"    argsLength = typeof guard == 'number' ? 2 : args.length;\n"+"while (++argsIndex < argsLength) {\n"+"  iterable = args[argsIndex];\n"+"  if (iterable && objectTypes[typeof iterable]) {",keys:keys,loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"};
var forOwnIteratorOptions={top:"if (!objectTypes[typeof iterable]) return result;\n"+eachIteratorOptions.top,array:false};var htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};var htmlUnescapes=invert(htmlEscapes);var reEscapedHtml=RegExp("("+keys(htmlUnescapes).join("|")+")","g"),reUnescapedHtml=RegExp("["+keys(htmlEscapes).join("")+"]","g");var baseEach=createIterator(eachIteratorOptions);var assign=createIterator(defaultsIteratorOptions,{top:defaultsIteratorOptions.top.replace(";",";\n"+"if (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n"+"  var callback = baseCreateCallback(args[--argsLength - 1], args[argsLength--], 2);\n"+"} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n"+"  callback = args[--argsLength];\n"+"}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"});function clone(value,isDeep,callback,thisArg){if(typeof isDeep!="boolean"&&isDeep!=null){thisArg=callback;callback=isDeep;isDeep=false}return baseClone(value,isDeep,typeof callback=="function"&&baseCreateCallback(callback,thisArg,1))}function cloneDeep(value,callback,thisArg){return baseClone(value,true,typeof callback=="function"&&baseCreateCallback(callback,thisArg,1))}function create(prototype,properties){var result=baseCreate(prototype);return properties?assign(result,properties):result}var defaults=createIterator(defaultsIteratorOptions);function findKey(object,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg,3);forOwn(object,function(value,key,object){if(callback(value,key,object)){result=key;return false}});return result}function findLastKey(object,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg,3);forOwnRight(object,function(value,key,object){if(callback(value,key,object)){result=key;return false}});return result}var forIn=createIterator(eachIteratorOptions,forOwnIteratorOptions,{useHas:false});function forInRight(object,callback,thisArg){var pairs=[];forIn(object,function(value,key){pairs.push(key,value)});var length=pairs.length;callback=baseCreateCallback(callback,thisArg,3);while(length--){if(callback(pairs[length--],pairs[length],object)===false){break}}return object}var forOwn=createIterator(eachIteratorOptions,forOwnIteratorOptions);function forOwnRight(object,callback,thisArg){var props=keys(object),length=props.length;callback=baseCreateCallback(callback,thisArg,3);while(length--){var key=props[length];if(callback(object[key],key,object)===false){break}}return object}function functions(object){var result=[];forIn(object,function(value,key){if(isFunction(value)){result.push(key)}});return result.sort()}function has(object,key){return object?hasOwnProperty.call(object,key):false}function invert(object){var index=-1,props=keys(object),length=props.length,result={};while(++index<length){var key=props[index];result[object[key]]=key}return result}function isBoolean(value){return value===true||value===false||value&&typeof value=="object"&&toString.call(value)==boolClass||false}function isDate(value){return value&&typeof value=="object"&&toString.call(value)==dateClass||false}function isElement(value){return value&&value.nodeType===1||false}function isEmpty(value){var result=true;if(!value){return result}var className=toString.call(value),length=value.length;if(className==arrayClass||className==stringClass||(support.argsClass?className==argsClass:isArguments(value))||className==objectClass&&typeof length=="number"&&isFunction(value.splice)){return!length}forOwn(value,function(){return result=false});return result}function isEqual(a,b,callback,thisArg){return baseIsEqual(a,b,typeof callback=="function"&&baseCreateCallback(callback,thisArg,2))}function isFinite(value){return nativeIsFinite(value)&&!nativeIsNaN(parseFloat(value))}function isFunction(value){return typeof value=="function"}if(isFunction(/x/)){isFunction=function(value){return typeof value=="function"&&toString.call(value)==funcClass}}function isObject(value){return!!(value&&objectTypes[typeof value])}function isNaN(value){return isNumber(value)&&value!=+value}function isNull(value){return value===null}function isNumber(value){return typeof value=="number"||value&&typeof value=="object"&&toString.call(value)==numberClass||false}var isPlainObject=!getPrototypeOf?shimIsPlainObject:function(value){if(!(value&&toString.call(value)==objectClass)||!support.argsClass&&isArguments(value)){return false}var valueOf=value.valueOf,objProto=isNative(valueOf)&&(objProto=getPrototypeOf(valueOf))&&getPrototypeOf(objProto);return objProto?value==objProto||getPrototypeOf(value)==objProto:shimIsPlainObject(value)};function isRegExp(value){return value&&objectTypes[typeof value]&&toString.call(value)==regexpClass||false}function isString(value){return typeof value=="string"||value&&typeof value=="object"&&toString.call(value)==stringClass||false}function isUndefined(value){return typeof value=="undefined"}function mapValues(object,callback,thisArg){var result={};callback=lodash.createCallback(callback,thisArg,3);forOwn(object,function(value,key,object){result[key]=callback(value,key,object)});return result}function merge(object){var args=arguments,length=2;if(!isObject(object)){return object}if(typeof args[2]!="number"){length=args.length}if(length>3&&typeof args[length-2]=="function"){var callback=baseCreateCallback(args[--length-1],args[length--],2)}else if(length>2&&typeof args[length-1]=="function"){callback=args[--length]}var sources=slice(arguments,1,length),index=-1,stackA=getArray(),stackB=getArray();while(++index<length){baseMerge(object,sources[index],callback,stackA,stackB)}releaseArray(stackA);releaseArray(stackB);return object}function omit(object,callback,thisArg){var result={};if(typeof callback!="function"){var props=[];forIn(object,function(value,key){props.push(key)});props=baseDifference(props,baseFlatten(arguments,true,false,1));var index=-1,length=props.length;while(++index<length){var key=props[index];result[key]=object[key]}}else{callback=lodash.createCallback(callback,thisArg,3);forIn(object,function(value,key,object){if(!callback(value,key,object)){result[key]=value}})}return result}function pairs(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){var key=props[index];result[index]=[key,object[key]]}return result}function pick(object,callback,thisArg){var result={};if(typeof callback!="function"){var index=-1,props=baseFlatten(arguments,true,false,1),length=isObject(object)?props.length:0;while(++index<length){var key=props[index];if(key in object){result[key]=object[key]}}}else{callback=lodash.createCallback(callback,thisArg,3);forIn(object,function(value,key,object){if(callback(value,key,object)){result[key]=value}})}return result}function transform(object,callback,accumulator,thisArg){var isArr=isArray(object);if(accumulator==null){if(isArr){accumulator=[]}else{var ctor=object&&object.constructor,proto=ctor&&ctor.prototype;accumulator=baseCreate(proto)}}if(callback){callback=lodash.createCallback(callback,thisArg,4);(isArr?baseEach:forOwn)(object,function(value,index,object){return callback(accumulator,value,index,object)})}return accumulator}function values(object){var index=-1,props=keys(object),length=props.length,result=Array(length);while(++index<length){result[index]=object[props[index]]}return result}function at(collection){var args=arguments,index=-1,props=baseFlatten(args,true,false,1),length=args[2]&&args[2][args[1]]===collection?1:props.length,result=Array(length);if(support.unindexedChars&&isString(collection)){collection=collection.split("")}while(++index<length){result[index]=collection[props[index]]}return result}function contains(collection,target,fromIndex){var index=-1,indexOf=getIndexOf(),length=collection?collection.length:0,result=false;fromIndex=(fromIndex<0?nativeMax(0,length+fromIndex):fromIndex)||0;if(isArray(collection)){result=indexOf(collection,target,fromIndex)>-1}else if(typeof length=="number"){result=(isString(collection)?collection.indexOf(target,fromIndex):indexOf(collection,target,fromIndex))>-1}else{baseEach(collection,function(value){if(++index>=fromIndex){return!(result=value===target)}})}return result}var countBy=createAggregator(function(result,value,key){hasOwnProperty.call(result,key)?result[key]++:result[key]=1});function every(collection,callback,thisArg){var result=true;callback=lodash.createCallback(callback,thisArg,3);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(!(result=!!callback(collection[index],index,collection))){break}}}else{baseEach(collection,function(value,index,collection){return result=!!callback(value,index,collection)})}return result}function filter(collection,callback,thisArg){var result=[];callback=lodash.createCallback(callback,thisArg,3);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(callback(value,index,collection)){result.push(value)}}}else{baseEach(collection,function(value,index,collection){if(callback(value,index,collection)){result.push(value)}})}return result}function find(collection,callback,thisArg){callback=lodash.createCallback(callback,thisArg,3);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(callback(value,index,collection)){return value}}}else{var result;baseEach(collection,function(value,index,collection){if(callback(value,index,collection)){result=value;return false}});return result}}function findLast(collection,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg,3);forEachRight(collection,function(value,index,collection){if(callback(value,index,collection)){result=value;return false}});return result}function forEach(collection,callback,thisArg){if(callback&&typeof thisArg=="undefined"&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(callback(collection[index],index,collection)===false){break}}}else{baseEach(collection,callback,thisArg)}return collection}function forEachRight(collection,callback,thisArg){var iterable=collection,length=collection?collection.length:0;callback=callback&&typeof thisArg=="undefined"?callback:baseCreateCallback(callback,thisArg,3);if(isArray(collection)){while(length--){if(callback(collection[length],length,collection)===false){break}}}else{if(typeof length!="number"){var props=keys(collection);length=props.length}else if(support.unindexedChars&&isString(collection)){iterable=collection.split("")}baseEach(collection,function(value,key,collection){key=props?props[--length]:--length;return callback(iterable[key],key,collection)})}return collection}var groupBy=createAggregator(function(result,value,key){(hasOwnProperty.call(result,key)?result[key]:result[key]=[]).push(value)});var indexBy=createAggregator(function(result,value,key){result[key]=value});function invoke(collection,methodName){var args=slice(arguments,2),index=-1,isFunc=typeof methodName=="function",length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){result[++index]=(isFunc?methodName:value[methodName]).apply(value,args)});return result}function map(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);callback=lodash.createCallback(callback,thisArg,3);if(isArray(collection)){while(++index<length){result[index]=callback(collection[index],index,collection)}}else{baseEach(collection,function(value,key,collection){result[++index]=callback(value,key,collection)})}return result}function max(collection,callback,thisArg){var computed=-Infinity,result=computed;if(typeof callback!="function"&&thisArg&&thisArg[callback]===collection){callback=null}if(callback==null&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(value>result){result=value}}}else{callback=callback==null&&isString(collection)?charAtCallback:lodash.createCallback(callback,thisArg,3);baseEach(collection,function(value,index,collection){var current=callback(value,index,collection);if(current>computed){computed=current;result=value}})}return result}function min(collection,callback,thisArg){var computed=Infinity,result=computed;if(typeof callback!="function"&&thisArg&&thisArg[callback]===collection){callback=null}if(callback==null&&isArray(collection)){var index=-1,length=collection.length;while(++index<length){var value=collection[index];if(value<result){result=value}}}else{callback=callback==null&&isString(collection)?charAtCallback:lodash.createCallback(callback,thisArg,3);baseEach(collection,function(value,index,collection){var current=callback(value,index,collection);if(current<computed){computed=current;result=value}})}return result}var pluck=map;function reduce(collection,callback,accumulator,thisArg){var noaccum=arguments.length<3;callback=lodash.createCallback(callback,thisArg,4);if(isArray(collection)){var index=-1,length=collection.length;if(noaccum){accumulator=collection[++index]}while(++index<length){accumulator=callback(accumulator,collection[index],index,collection)}}else{baseEach(collection,function(value,index,collection){accumulator=noaccum?(noaccum=false,value):callback(accumulator,value,index,collection)})}return accumulator}function reduceRight(collection,callback,accumulator,thisArg){var noaccum=arguments.length<3;callback=lodash.createCallback(callback,thisArg,4);forEachRight(collection,function(value,index,collection){accumulator=noaccum?(noaccum=false,value):callback(accumulator,value,index,collection)});return accumulator}function reject(collection,callback,thisArg){callback=lodash.createCallback(callback,thisArg,3);return filter(collection,function(value,index,collection){return!callback(value,index,collection)})}function sample(collection,n,guard){if(collection&&typeof collection.length!="number"){collection=values(collection)}else if(support.unindexedChars&&isString(collection)){collection=collection.split("")}if(n==null||guard){return collection?collection[baseRandom(0,collection.length-1)]:undefined}var result=shuffle(collection);result.length=nativeMin(nativeMax(0,n),result.length);return result}function shuffle(collection){var index=-1,length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);forEach(collection,function(value){var rand=baseRandom(0,++index);result[index]=result[rand];result[rand]=value});return result}function size(collection){var length=collection?collection.length:0;return typeof length=="number"?length:keys(collection).length}function some(collection,callback,thisArg){var result;callback=lodash.createCallback(callback,thisArg,3);if(isArray(collection)){var index=-1,length=collection.length;while(++index<length){if(result=callback(collection[index],index,collection)){break}}}else{baseEach(collection,function(value,index,collection){return!(result=callback(value,index,collection))})}return!!result}function sortBy(collection,callback,thisArg){var index=-1,isArr=isArray(callback),length=collection?collection.length:0,result=Array(typeof length=="number"?length:0);if(!isArr){callback=lodash.createCallback(callback,thisArg,3)}forEach(collection,function(value,key,collection){var object=result[++index]=getObject();if(isArr){object.criteria=map(callback,function(key){return value[key]})}else{(object.criteria=getArray())[0]=callback(value,key,collection)}object.index=index;object.value=value});length=result.length;result.sort(compareAscending);while(length--){var object=result[length];result[length]=object.value;if(!isArr){releaseArray(object.criteria)}releaseObject(object)}return result}function toArray(collection){if(collection&&typeof collection.length=="number"){return support.unindexedChars&&isString(collection)?collection.split(""):slice(collection)}return values(collection)}var where=filter;function compact(array){var index=-1,length=array?array.length:0,result=[];while(++index<length){var value=array[index];if(value){result.push(value)}}return result}function difference(array){return baseDifference(array,baseFlatten(arguments,true,true,1))}function findIndex(array,callback,thisArg){var index=-1,length=array?array.length:0;callback=lodash.createCallback(callback,thisArg,3);while(++index<length){if(callback(array[index],index,array)){return index}}return-1}function findLastIndex(array,callback,thisArg){var length=array?array.length:0;callback=lodash.createCallback(callback,thisArg,3);while(length--){if(callback(array[length],length,array)){return length}}return-1}function first(array,callback,thisArg){var n=0,length=array?array.length:0;if(typeof callback!="number"&&callback!=null){var index=-1;callback=lodash.createCallback(callback,thisArg,3);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array?array[0]:undefined}}return slice(array,0,nativeMin(nativeMax(0,n),length))}function flatten(array,isShallow,callback,thisArg){if(typeof isShallow!="boolean"&&isShallow!=null){thisArg=callback;callback=typeof isShallow!="function"&&thisArg&&thisArg[isShallow]===array?null:isShallow;isShallow=false}if(callback!=null){array=map(array,callback,thisArg)}return baseFlatten(array,isShallow)}function indexOf(array,value,fromIndex){if(typeof fromIndex=="number"){var length=array?array.length:0;fromIndex=fromIndex<0?nativeMax(0,length+fromIndex):fromIndex||0}else if(fromIndex){var index=sortedIndex(array,value);return array[index]===value?index:-1}return baseIndexOf(array,value,fromIndex)}function initial(array,callback,thisArg){var n=0,length=array?array.length:0;if(typeof callback!="number"&&callback!=null){var index=length;callback=lodash.createCallback(callback,thisArg,3);while(index--&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:callback||n}return slice(array,0,nativeMin(nativeMax(0,length-n),length))}function intersection(){var args=[],argsIndex=-1,argsLength=arguments.length,caches=getArray(),indexOf=getIndexOf(),trustIndexOf=indexOf===baseIndexOf,seen=getArray();while(++argsIndex<argsLength){var value=arguments[argsIndex];if(isArray(value)||isArguments(value)){args.push(value);caches.push(trustIndexOf&&value.length>=largeArraySize&&createCache(argsIndex?args[argsIndex]:seen))}}var array=args[0],index=-1,length=array?array.length:0,result=[];outer:while(++index<length){var cache=caches[0];value=array[index];if((cache?cacheIndexOf(cache,value):indexOf(seen,value))<0){argsIndex=argsLength;(cache||seen).push(value);while(--argsIndex){cache=caches[argsIndex];if((cache?cacheIndexOf(cache,value):indexOf(args[argsIndex],value))<0){continue outer}}result.push(value)}}while(argsLength--){cache=caches[argsLength];if(cache){releaseObject(cache)}}releaseArray(caches);releaseArray(seen);return result}function last(array,callback,thisArg){var n=0,length=array?array.length:0;if(typeof callback!="number"&&callback!=null){var index=length;callback=lodash.createCallback(callback,thisArg,3);while(index--&&callback(array[index],index,array)){n++}}else{n=callback;if(n==null||thisArg){return array?array[length-1]:undefined}}return slice(array,nativeMax(0,length-n))}function lastIndexOf(array,value,fromIndex){var index=array?array.length:0;if(typeof fromIndex=="number"){index=(fromIndex<0?nativeMax(0,index+fromIndex):nativeMin(fromIndex,index-1))+1}while(index--){if(array[index]===value){return index}}return-1}function pull(array){var args=arguments,argsIndex=0,argsLength=args.length,length=array?array.length:0;while(++argsIndex<argsLength){var index=-1,value=args[argsIndex];while(++index<length){if(array[index]===value){splice.call(array,index--,1);length--}}}return array}function range(start,end,step){start=+start||0;step=typeof step=="number"?step:+step||1;if(end==null){end=start;start=0}var index=-1,length=nativeMax(0,ceil((end-start)/(step||1))),result=Array(length);while(++index<length){result[index]=start;start+=step}return result}function remove(array,callback,thisArg){var index=-1,length=array?array.length:0,result=[];callback=lodash.createCallback(callback,thisArg,3);while(++index<length){var value=array[index];if(callback(value,index,array)){result.push(value);splice.call(array,index--,1);length--}}return result}function rest(array,callback,thisArg){if(typeof callback!="number"&&callback!=null){var n=0,index=-1,length=array?array.length:0;callback=lodash.createCallback(callback,thisArg,3);while(++index<length&&callback(array[index],index,array)){n++}}else{n=callback==null||thisArg?1:nativeMax(0,callback)}return slice(array,n)}function sortedIndex(array,value,callback,thisArg){var low=0,high=array?array.length:low;callback=callback?lodash.createCallback(callback,thisArg,1):identity;value=callback(value);while(low<high){var mid=low+high>>>1;callback(array[mid])<value?low=mid+1:high=mid}return low}function union(){return baseUniq(baseFlatten(arguments,true,true))}function uniq(array,isSorted,callback,thisArg){if(typeof isSorted!="boolean"&&isSorted!=null){thisArg=callback;callback=typeof isSorted!="function"&&thisArg&&thisArg[isSorted]===array?null:isSorted;isSorted=false}if(callback!=null){callback=lodash.createCallback(callback,thisArg,3)}return baseUniq(array,isSorted,callback)}function without(array){return baseDifference(array,slice(arguments,1))}function xor(){var index=-1,length=arguments.length;while(++index<length){var array=arguments[index];if(isArray(array)||isArguments(array)){var result=result?baseUniq(baseDifference(result,array).concat(baseDifference(array,result))):array}}return result||[]}function zip(){var array=arguments.length>1?arguments:arguments[0],index=-1,length=array?max(pluck(array,"length")):0,result=Array(length<0?0:length);while(++index<length){result[index]=pluck(array,index)}return result}function zipObject(keys,values){var index=-1,length=keys?keys.length:0,result={};if(!values&&length&&!isArray(keys[0])){values=[]}while(++index<length){var key=keys[index];if(values){result[key]=values[index]}else if(key){result[key[0]]=key[1]}}return result}function after(n,func){if(!isFunction(func)){throw new TypeError}return function(){if(--n<1){return func.apply(this,arguments)}}}function bind(func,thisArg){return arguments.length>2?createWrapper(func,17,slice(arguments,2),null,thisArg):createWrapper(func,1,null,null,thisArg)}function bindAll(object){var funcs=arguments.length>1?baseFlatten(arguments,true,false,1):functions(object),index=-1,length=funcs.length;while(++index<length){var key=funcs[index];object[key]=createWrapper(object[key],1,null,null,object)}return object}function bindKey(object,key){return arguments.length>2?createWrapper(key,19,slice(arguments,2),null,object):createWrapper(key,3,null,null,object)}function compose(){var funcs=arguments,length=funcs.length;while(length--){if(!isFunction(funcs[length])){throw new TypeError}}return function(){var args=arguments,length=funcs.length;while(length--){args=[funcs[length].apply(this,args)]}return args[0]}}function curry(func,arity){arity=typeof arity=="number"?arity:+arity||func.length;return createWrapper(func,4,null,null,null,arity)}function debounce(func,wait,options){var args,maxTimeoutId,result,stamp,thisArg,timeoutId,trailingCall,lastCalled=0,maxWait=false,trailing=true;if(!isFunction(func)){throw new TypeError}wait=nativeMax(0,wait)||0;if(options===true){var leading=true;trailing=false}else if(isObject(options)){leading=options.leading;maxWait="maxWait"in options&&(nativeMax(wait,options.maxWait)||0);trailing="trailing"in options?options.trailing:trailing}var delayed=function(){var remaining=wait-(now()-stamp);if(remaining<=0){if(maxTimeoutId){clearTimeout(maxTimeoutId)}var isCalled=trailingCall;maxTimeoutId=timeoutId=trailingCall=undefined;if(isCalled){lastCalled=now();result=func.apply(thisArg,args);if(!timeoutId&&!maxTimeoutId){args=thisArg=null}}}else{timeoutId=setTimeout(delayed,remaining)}};var maxDelayed=function(){if(timeoutId){clearTimeout(timeoutId)}maxTimeoutId=timeoutId=trailingCall=undefined;if(trailing||maxWait!==wait){lastCalled=now();result=func.apply(thisArg,args);if(!timeoutId&&!maxTimeoutId){args=thisArg=null}}};return function(){args=arguments;stamp=now();thisArg=this;trailingCall=trailing&&(timeoutId||!leading);if(maxWait===false){var leadingCall=leading&&!timeoutId}else{if(!maxTimeoutId&&!leading){lastCalled=stamp}var remaining=maxWait-(stamp-lastCalled),isCalled=remaining<=0;if(isCalled){if(maxTimeoutId){maxTimeoutId=clearTimeout(maxTimeoutId)}lastCalled=stamp;result=func.apply(thisArg,args)}else if(!maxTimeoutId){maxTimeoutId=setTimeout(maxDelayed,remaining)}}if(isCalled&&timeoutId){timeoutId=clearTimeout(timeoutId)}else if(!timeoutId&&wait!==maxWait){timeoutId=setTimeout(delayed,wait)}if(leadingCall){isCalled=true;result=func.apply(thisArg,args)}if(isCalled&&!timeoutId&&!maxTimeoutId){args=thisArg=null}return result}}function defer(func){if(!isFunction(func)){throw new TypeError}var args=slice(arguments,1);return setTimeout(function(){func.apply(undefined,args)},1)}function delay(func,wait){if(!isFunction(func)){throw new TypeError}var args=slice(arguments,2);return setTimeout(function(){func.apply(undefined,args)},wait)}function memoize(func,resolver){if(!isFunction(func)){throw new TypeError}var memoized=function(){var cache=memoized.cache,key=resolver?resolver.apply(this,arguments):keyPrefix+arguments[0];return hasOwnProperty.call(cache,key)?cache[key]:cache[key]=func.apply(this,arguments)};memoized.cache={};return memoized}function once(func){var ran,result;if(!isFunction(func)){throw new TypeError}return function(){if(ran){return result}ran=true;result=func.apply(this,arguments);func=null;return result}}function partial(func){return createWrapper(func,16,slice(arguments,1))}function partialRight(func){return createWrapper(func,32,null,slice(arguments,1))}function throttle(func,wait,options){var leading=true,trailing=true;if(!isFunction(func)){throw new TypeError}if(options===false){leading=false}else if(isObject(options)){leading="leading"in options?options.leading:leading;trailing="trailing"in options?options.trailing:trailing}debounceOptions.leading=leading;debounceOptions.maxWait=wait;debounceOptions.trailing=trailing;return debounce(func,wait,debounceOptions)}function wrap(value,wrapper){return createWrapper(wrapper,16,[value])}function constant(value){return function(){return value}}function createCallback(func,thisArg,argCount){var type=typeof func;if(func==null||type=="function"){return baseCreateCallback(func,thisArg,argCount)}if(type!="object"){return property(func)}var props=keys(func),key=props[0],a=func[key];if(props.length==1&&a===a&&!isObject(a)){return function(object){var b=object[key];return a===b&&(a!==0||1/a==1/b)}}return function(object){var length=props.length,result=false;while(length--){if(!(result=baseIsEqual(object[props[length]],func[props[length]],null,true))){break}}return result}}function escape(string){return string==null?"":String(string).replace(reUnescapedHtml,escapeHtmlChar)}function identity(value){return value}function mixin(object,source,options){var chain=true,methodNames=source&&functions(source);if(!source||!options&&!methodNames.length){if(options==null){options=source}ctor=lodashWrapper;source=object;object=lodash;methodNames=functions(source)}if(options===false){chain=false}else if(isObject(options)&&"chain"in options){chain=options.chain}var ctor=object,isFunc=isFunction(ctor);forEach(methodNames,function(methodName){var func=object[methodName]=source[methodName];if(isFunc){ctor.prototype[methodName]=function(){var chainAll=this.__chain__,value=this.__wrapped__,args=[value];push.apply(args,arguments);var result=func.apply(object,args);if(chain||chainAll){if(value===result&&isObject(result)){return this}result=new ctor(result);result.__chain__=chainAll}return result}}})}function noConflict(){context._=oldDash;return this}function noop(){}var now=isNative(now=Date.now)&&now||function(){return(new Date).getTime()};var parseInt=nativeParseInt(whitespace+"08")==8?nativeParseInt:function(value,radix){return nativeParseInt(isString(value)?value.replace(reLeadingSpacesAndZeros,""):value,radix||0)};function property(key){return function(object){return object[key]}}function random(min,max,floating){var noMin=min==null,noMax=max==null;if(floating==null){if(typeof min=="boolean"&&noMax){floating=min;min=1}else if(!noMax&&typeof max=="boolean"){floating=max;noMax=true}}if(noMin&&noMax){max=1}min=+min||0;if(noMax){max=min;min=0}else{max=+max||0}if(floating||min%1||max%1){var rand=nativeRandom();return nativeMin(min+rand*(max-min+parseFloat("1e-"+((rand+"").length-1))),max)}return baseRandom(min,max)}function result(object,key){if(object){var value=object[key];return isFunction(value)?object[key]():value}}function template(text,data,options){var settings=lodash.templateSettings;text=String(text||"");options=defaults({},options,settings);var imports=defaults({},options.imports,settings.imports),importsKeys=keys(imports),importsValues=values(imports);var isEvaluating,index=0,interpolate=options.interpolate||reNoMatch,source="__p += '";var reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+interpolate.source+"|"+(interpolate===reInterpolate?reEsTemplate:reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g");text.replace(reDelimiters,function(match,escapeValue,interpolateValue,esTemplateValue,evaluateValue,offset){interpolateValue||(interpolateValue=esTemplateValue);source+=text.slice(index,offset).replace(reUnescapedString,escapeStringChar);if(escapeValue){source+="' +\n__e("+escapeValue+") +\n'"}if(evaluateValue){isEvaluating=true;source+="';\n"+evaluateValue+";\n__p += '"}if(interpolateValue){source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"}index=offset+match.length;return match});source+="';\n";var variable=options.variable,hasVariable=variable;if(!hasVariable){variable="obj";source="with ("+variable+") {\n"+source+"\n}\n"}source=(isEvaluating?source.replace(reEmptyStringLeading,""):source).replace(reEmptyStringMiddle,"$1").replace(reEmptyStringTrailing,"$1;");source="function("+variable+") {\n"+(hasVariable?"":variable+" || ("+variable+" = {});\n")+"var __t, __p = '', __e = _.escape"+(isEvaluating?", __j = Array.prototype.join;\n"+"function print() { __p += __j.call(arguments, '') }\n":";\n")+source+"return __p\n}";var sourceURL="\n/*\n//# sourceURL="+(options.sourceURL||"/lodash/template/source["+templateCounter++ +"]")+"\n*/";try{var result=Function(importsKeys,"return "+source+sourceURL).apply(undefined,importsValues)}catch(e){e.source=source;throw e}if(data){return result(data)}result.source=source;return result}function times(n,callback,thisArg){n=(n=+n)>-1?n:0;var index=-1,result=Array(n);callback=baseCreateCallback(callback,thisArg,1);while(++index<n){result[index]=callback(index)}return result}function unescape(string){return string==null?"":String(string).replace(reEscapedHtml,unescapeHtmlChar)}function uniqueId(prefix){var id=++idCounter;return String(prefix==null?"":prefix)+id}function chain(value){value=new lodashWrapper(value);value.__chain__=true;return value}function tap(value,interceptor){interceptor(value);return value}function wrapperChain(){this.__chain__=true;return this}function wrapperToString(){return String(this.__wrapped__)}function wrapperValueOf(){return this.__wrapped__}lodash.after=after;lodash.assign=assign;lodash.at=at;lodash.bind=bind;lodash.bindAll=bindAll;lodash.bindKey=bindKey;lodash.chain=chain;lodash.compact=compact;lodash.compose=compose;lodash.constant=constant;lodash.countBy=countBy;lodash.create=create;lodash.createCallback=createCallback;lodash.curry=curry;lodash.debounce=debounce;lodash.defaults=defaults;lodash.defer=defer;lodash.delay=delay;lodash.difference=difference;lodash.filter=filter;lodash.flatten=flatten;lodash.forEach=forEach;lodash.forEachRight=forEachRight;lodash.forIn=forIn;lodash.forInRight=forInRight;
lodash.forOwn=forOwn;lodash.forOwnRight=forOwnRight;lodash.functions=functions;lodash.groupBy=groupBy;lodash.indexBy=indexBy;lodash.initial=initial;lodash.intersection=intersection;lodash.invert=invert;lodash.invoke=invoke;lodash.keys=keys;lodash.map=map;lodash.mapValues=mapValues;lodash.max=max;lodash.memoize=memoize;lodash.merge=merge;lodash.min=min;lodash.omit=omit;lodash.once=once;lodash.pairs=pairs;lodash.partial=partial;lodash.partialRight=partialRight;lodash.pick=pick;lodash.pluck=pluck;lodash.property=property;lodash.pull=pull;lodash.range=range;lodash.reject=reject;lodash.remove=remove;lodash.rest=rest;lodash.shuffle=shuffle;lodash.sortBy=sortBy;lodash.tap=tap;lodash.throttle=throttle;lodash.times=times;lodash.toArray=toArray;lodash.transform=transform;lodash.union=union;lodash.uniq=uniq;lodash.values=values;lodash.where=where;lodash.without=without;lodash.wrap=wrap;lodash.xor=xor;lodash.zip=zip;lodash.zipObject=zipObject;lodash.collect=map;lodash.drop=rest;lodash.each=forEach;lodash.eachRight=forEachRight;lodash.extend=assign;lodash.methods=functions;lodash.object=zipObject;lodash.select=filter;lodash.tail=rest;lodash.unique=uniq;lodash.unzip=zip;mixin(lodash);lodash.clone=clone;lodash.cloneDeep=cloneDeep;lodash.contains=contains;lodash.escape=escape;lodash.every=every;lodash.find=find;lodash.findIndex=findIndex;lodash.findKey=findKey;lodash.findLast=findLast;lodash.findLastIndex=findLastIndex;lodash.findLastKey=findLastKey;lodash.has=has;lodash.identity=identity;lodash.indexOf=indexOf;lodash.isArguments=isArguments;lodash.isArray=isArray;lodash.isBoolean=isBoolean;lodash.isDate=isDate;lodash.isElement=isElement;lodash.isEmpty=isEmpty;lodash.isEqual=isEqual;lodash.isFinite=isFinite;lodash.isFunction=isFunction;lodash.isNaN=isNaN;lodash.isNull=isNull;lodash.isNumber=isNumber;lodash.isObject=isObject;lodash.isPlainObject=isPlainObject;lodash.isRegExp=isRegExp;lodash.isString=isString;lodash.isUndefined=isUndefined;lodash.lastIndexOf=lastIndexOf;lodash.mixin=mixin;lodash.noConflict=noConflict;lodash.noop=noop;lodash.now=now;lodash.parseInt=parseInt;lodash.random=random;lodash.reduce=reduce;lodash.reduceRight=reduceRight;lodash.result=result;lodash.runInContext=runInContext;lodash.size=size;lodash.some=some;lodash.sortedIndex=sortedIndex;lodash.template=template;lodash.unescape=unescape;lodash.uniqueId=uniqueId;lodash.all=every;lodash.any=some;lodash.detect=find;lodash.findWhere=find;lodash.foldl=reduce;lodash.foldr=reduceRight;lodash.include=contains;lodash.inject=reduce;mixin(function(){var source={};forOwn(lodash,function(func,methodName){if(!lodash.prototype[methodName]){source[methodName]=func}});return source}(),false);lodash.first=first;lodash.last=last;lodash.sample=sample;lodash.take=first;lodash.head=first;forOwn(lodash,function(func,methodName){var callbackable=methodName!=="sample";if(!lodash.prototype[methodName]){lodash.prototype[methodName]=function(n,guard){var chainAll=this.__chain__,result=func(this.__wrapped__,n,guard);return!chainAll&&(n==null||guard&&!(callbackable&&typeof n=="function"))?result:new lodashWrapper(result,chainAll)}}});lodash.VERSION="2.4.1";lodash.prototype.chain=wrapperChain;lodash.prototype.toString=wrapperToString;lodash.prototype.value=wrapperValueOf;lodash.prototype.valueOf=wrapperValueOf;baseEach(["join","pop","shift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){var chainAll=this.__chain__,result=func.apply(this.__wrapped__,arguments);return chainAll?new lodashWrapper(result,chainAll):result}});baseEach(["push","reverse","sort","unshift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){func.apply(this.__wrapped__,arguments);return this}});baseEach(["concat","slice","splice"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){return new lodashWrapper(func.apply(this.__wrapped__,arguments),this.__chain__)}});if(!support.spliceObjects){baseEach(["pop","shift","splice"],function(methodName){var func=arrayRef[methodName],isSplice=methodName=="splice";lodash.prototype[methodName]=function(){var chainAll=this.__chain__,value=this.__wrapped__,result=func.apply(value,arguments);if(value.length===0){delete value[0]}return chainAll||isSplice?new lodashWrapper(result,chainAll):result}})}return lodash}var _=runInContext();if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){root._=_;define(function(){return _})}else if(freeExports&&freeModule){if(moduleExports){(freeModule.exports=_)._=_}else{freeExports._=_}}else{root._=_}}).call(this);var Wrap=function(){_f=function(){};_=require("lodash");var SPACES_WITHOUT_NBSP=[10,8,32,8194,8195,8196,8197,8198,8199,8200,8201,8202,8203,8287,12288].map(function(s){return String.fromCharCode(s)});var leftSpaceRe=new RegExp("^["+SPACES_WITHOUT_NBSP.join("")+"]+","g");var rightSpaceRe=new RegExp("["+SPACES_WITHOUT_NBSP.join("")+"]+$","g");var spaceRe=new RegExp("["+SPACES_WITHOUT_NBSP.join("")+"]+","g");var nbspRe=new RegExp(String.fromCharCode(160),"g");var tab=String.fromCharCode(9);var SKIP_CLASSES=[];var SKIP_TAGS=["pre","code","blockquote"];var entityMap={mark:{"&":"᪥","<":"Ᲊ",">":"ᲆ",'"':"᯼","'":"ᨋ","/":"ᩗ"},escape:{"᪥":"&amp;","Ᲊ":"&lt;","ᲆ":"&gt;","᯼":"&quot;","ᨋ":"&#x27;","ᩗ":"&#x2F;"}};function detectIE(){var ua=window.navigator.userAgent;var msie=ua.indexOf("MSIE ");if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10)}var trident=ua.indexOf("Trident/");if(trident>0){var rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}var edge=ua.indexOf("Edge/");if(edge>0){return parseInt(ua.substring(edge+5,ua.indexOf(".",edge)),10)}return false}var isIE=!!detectIE();var entityRegexes={mark:new RegExp("["+_.keys(entityMap.mark).join("")+"]","g"),escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g")};return window.__Wrap={render:render,getNodeInfo:getNodeInfo,unwrap:unwrap,setRange:setRange,getNextTextNode:getNextTextNode,isDescendant:isDescendant,getNodeText:getNodeText,getCursorPos:getCursorPos,setCursorPos:setCursorPos,isBr:isBr,isBlock:isBlock,invalidateNode:invalidateNode,getNodeByTextPos:getNodeByTextPos,getPosInText:getPosInText,markChildPos:markChildPos,getText:getText,collision:collision,mergeNodes:mergeNodes,hasSkipNode:hasSkipNode,hasSkipTag:hasSkipTag,hasSkipClass:hasSkipClass,skipClass:skipClass,skipTag:skipTag};function skipClass(cls){if(!cls){return SKIP_CLASSES}SKIP_CLASSES=cls}function skipTag(tag){if(!tag){return SKIP_TAGS}SKIP_TAGS=tag}function matchParent(m){while(m.parent){m=m.parent}return m}function splitOverlaps(m){var matches=m.concat();for(var i=0;i<matches.length;i++){var a=matches[i],split=[];if(a._s==undefined){a._s=a.s;a._e=a.e}for(var k=i+1;k<matches.length;k++){var b=matches[k];if(b._s==undefined){b._s=b.s;b._e=b.e}if(collision(a,b)<=0)continue;if(a._s>b._s&&a._e-b._e>0){split.push({_s:a._s,_e:b._e,parent:a});split.push({_s:b._e,_e:a._e,parent:a});break}else if(a._e<b._e&&b._s-a._s>0){split.push({_s:a._s,_e:b._s,parent:a});split.push({_s:b._s,_e:a._e,parent:a});break}}if(split.length){matches.splice.apply(matches,[i,1].concat(split));i=0}}matches.sort(function(a,b){return a._s-b._s||b._e-a._e});return matches}function collision(a,b){return Math.min(a._e,b._e)-Math.max(a._s,b._s)}function markEscape(string){if(string==null)return"";return(""+string).replace(entityRegexes.mark,function(m){return entityMap.mark[m]})}function escape(string){if(string==null)return"";return(""+string).replace(entityRegexes.escape,function(m){return entityMap.escape[m]})}function renderDom(config){var node=config.node,matches=config.matches,createElement=config.createElement,isValidNode=config.isValidNode||function(node){return true},isValidMatchForNode=config.isValidMatchForNode||function(node,validNode,match){return validNode};var result=[];var splittedMatches=splitOverlaps(matches).filter(function(m){return!m.inDom&&!matchParent(m).inDom});if(splittedMatches.length==0)return;wrapDom(node,node,0,splittedMatches,null,createElement,isValidNode,isValidMatchForNode);var splittedMatches=splitOverlaps(matches).filter(function(m){return!m.inDom&&!matchParent(m).inDom})}function br(val){return val.replace(/\n/g,"<br>")}function renderText(config){var text=config.text,node=config.node,matches=config.matches,createTag=config.createTag,updateMethod=config.updateMethod;if(updateMethod){updateMethod(text,matches,function(text,matches){var splittedMatches=splitOverlaps(matches);return wrapText(text,splittedMatches,createTag)})}else{var splittedMatches=splitOverlaps(matches);node.innerHTML=br(wrapText(text,matches,createTag))}}function render(config){if(config.type=="dom"){return renderDom(config)}if(config.type=="text"){return renderText(config)}}function defaultCreateTag(m,text){var parent=m.parent||m,cls="";return{start:"<g class='gr_ gr_"+parent.id+cls+"' id='"+parent.id+"'>",end:"</g>"}}function wrapText(text,matches,createTag){var initial=text;text=markEscape(text);var createTag=createTag||defaultCreateTag;var closeAts=[],tag,s=0,i,j,m,parent,startTag,start;for(i=0;i<matches.length;i++){m=matches[i];m.calculatedPos=false;parent=m.parent||m;parent.inDom=true;if(parent.orig)parent.orig.inDom=true;parent=parent.orig||parent;tag=createTag(parent,initial);parent.renderTs=parent.renderTs||Date.now();startTag=tag.start;start=s+m._s;text=text.substring(0,start)+startTag+text.substring(start);s+=startTag.length;for(j=0;j<closeAts.length;j++){if(closeAts[j]>start){closeAts[j]+=startTag.length}}closeAts.push(s+m._e)}closeAts.sort(function(a,b){return a-b});s=0;for(j=0;j<closeAts.length;j++){start=s+closeAts[j];text=text.substring(0,start)+tag.end+text.substring(start);s+=tag.end.length}return escape(text)}function defaultCreateElement(m,val){var el=document.createElement("g");el.getElementsByTagName("g");el.className="gr_ gr_"+m.id;el.textContent=val;el.id=m.id;return el}function replaceRange(node,s,e,newNode){var ownerDocument=node.ownerDocument||node;var range=ownerDocument.createRange();try{range.setStart(node,s);range.setEnd(node,e);range.deleteContents();range.insertNode(newNode)}catch(e){Wrap.error&&Wrap.error("replaceRange");throw e}}function wrapDom(root,node,start,matches,state,createElement,isValidNode,isValidMatchForNode){var child,s=start||0,i;var textNode={_s:undefined,_e:undefined};createElement=createElement||defaultCreateElement;state=state||{level:-1,validNodeForMatchLevel:0};state.text=state.text||getText(root);var level=state.level;var validNodeForMatch=isValidNode(node);if(!validNodeForMatch){state.validNodeForMatch=false;state.validNodeForMatchLevel=state.level}else{if(state.level<=state.validNodeForMatchLevel){state.validNodeForMatch=true;state.validNodeForMatchLevel=state.level}}state.level++;node.__s=s;for(i=0;i<node.childNodes.length;i++){child=node.childNodes[i];if(child.__jump_next){i++;delete child.__jump_next;child=node.childNodes[i]}if(!child)continue;if(child.nodeType!=1&&child.nodeType!=3)continue;if(hasSkipNode(child))continue;var ni=getNodeInfo(root,child);if(nodeBetweenTags(ni)&&child.nodeType==3){continue}if(child.nodeType!=3){s=wrapDom(root,child,s,matches,state,createElement,isValidNode,isValidMatchForNode)}var brAddedAtNode=state.brAddedAtNode,prevIsBr=state.prevIsBr;var prevIsBrWithinNode=prevIsBr&&(brAddedAtNode==child||isDescendant(brAddedAtNode,child)||isDescendant(child,brAddedAtNode));ni.prevIsBrWithinNode=prevIsBrWithinNode;var val=getNodeText(ni),nodeVal=val;textNode._s=s;textNode._e=s+val.length;s=textNode._e;if(val){state.prevIsBr=false}var br=isBr(ni);if(br){state.prevIsBr=true;s++;state.brAddedAtNode=child.parentNode}if(ni.isPreWrap&&val.indexOf("\n")!=-1){state.prevIsBr=true;state.brAddedAtNode=child.parentNode}if(ni.node.tagName=="IMG")state.prevIsBr=false;if(child.nodeType!=3||textNode._s==textNode._e)continue;if(nodeVal!=child.textContent){child.textContent=nodeVal}for(var k=0;k<matches.length;k++){var m=matches[0];var parent=m.parent||m;m.__s=m.__s||m._s;m.__e=m.__e||m._e;if(m.__s>=textNode._e)break;while(state.text[m.__s]=="\n"){m.__s++}if(m.__s<textNode._s){var p=child.parentNode;while(p.__s>m.__s){p=p.parentNode}m.__timesRendered=m.__timesRendered||0;m.__timesRendered++;if(m.__timesRendered>5){break}wrapDom(root,p,p.__s,matches,state,createElement,isValidNode,isValidMatchForNode)}if(textNode._e<m._e){var oldS=m.__s;m.__s=textNode._e;m={__s:oldS,__e:textNode._e,parent:m}}else{matches.shift();k--}if(!state.validNodeForMatch&&!isValidMatchForNode(child,state.validNodeForMatch,parent))continue;var matchS=0;if(textNode._s<m.__s){matchS=m.__s-textNode._s;val=val.substr(matchS)}m.calculatedPos=false;var matchLen=m.__e-m.__s,matchE=matchS+matchLen,mParent=matchParent(m);var el=createElement(mParent,val.substr(0,matchLen));mParent.renderTs=mParent.renderTs||Date.now();parent.inDom=true;start=s+m.__s;val=val.substr(0,matchLen);replaceRange(child,matchS,matchE,el);if(isIE){if(el.parentNode.tagName!=el.tagName){el.__jump_next=true}if(node.firstChild&&node.firstChild.nodeType==3&&node.firstChild.textContent.length==0){node.removeChild(node.firstChild)}else{}if(!child.parentNode){var fixIE=true;child=el}}el.__node_info=null;if(el.previousSibling){el.previousSibling.__node_info=null}if(el.nextSibling){el.nextSibling.__node_info=null}removeContentFields(child);if(child.parentNode==node){if(!fixIE){i++}textNode._s=m.__s;textNode._e=m.__e;el.__s=m.__s;s=m.__e;var _br=isBr(getNodeInfo(root,el));if(_br)s++}delete m.__s;delete m.__e;delete m.__timesRendered;child=el.firstChild;if(el.parentNode!=node&&el.parentNode){wrapDom(root,el.parentNode,el.parentNode.__s,matches,state,createElement,isValidNode,isValidMatchForNode);continue}}}if(isTableCell(node)&&isTableCell(node.nextElementSibling)){if(matches[0]&&matches[0].__s==s){matches[0].__s++}s++}state.level=level;return s}function mergeNodes(nodes){if(!nodes||nodes&&nodes.length===0){return false}if(nodes.length===1){return nodes[0]}var mergedNode=nodes[0],len=nodes.length;for(var i=1;i<len;i++){mergedNode.appendChild(nodes[i]);invalidateNode(nodes[i].parentNode)}mergedNode.innerHTML=getText(mergedNode);mergedNode.normalize();nodes[0].parentNode.normalize();invalidateNode(mergedNode);invalidateNode(nodes[0].parentNode);return mergedNode}function replaceLeftSpaces(str){return str.replace(leftSpaceRe,"")}function replaceRightSpaces(str){return str.replace(rightSpaceRe,"")}function collapseRightSpaces(str){return str.replace(rightSpaceRe," ")}function trim(str){return str.replace(leftSpaceRe,"").replace(rightSpaceRe,"")}function trimmedContent(node,preWrap){if(!node)return;if(node.__trimmed_content)return node.__trimmed_content;if(preWrap)return node.__trimmed_content=node.textContent;return node.__trimmed_content=trim(node.textContent)}function removeContentFields(node){if(node.__trimmed_content)delete node.__trimmed_content;if(node.__node_text)delete node.__node_text}function invalidateNode(node){if(!node)return;removeContentFields(node);node.parentNode&&node.parentNode.normalize();if(node.childNodes.length>0){for(var i=0,len=node.childNodes.length;i<len;i++){invalidateNode(node.childNodes[i])}}}function collapseSpaces(str){return str.replace(/\n+/g," ").replace(spaceRe," ")}function isDescendant(parent,child){if(!child)return false;var node=child.parentNode;while(node!=null){if(node==parent)return true;node=node.parentNode}return false}function unwrap(el){if(!el.parentNode)return;var doc=el.ownerDocument,p=el.parentNode;if(el.childNodes.length>1){var f=doc.createDocumentFragment();while(el.childNodes.length>0){var node=el.childNodes[0];f.appendChild(node)}p.replaceChild(f,el);invalidateNode(p)}else if(el.firstChild){p.replaceChild(el.firstChild,el);p.normalize();invalidateNode(p)}else{p.removeChild(el);p.normalize();invalidateNode(p)}}function getNextNode(root,target){var result,exitOnNextNode;function getNodes(node){if(node.nodeType!=3&&node.nodeType!=1)return;if(node.nodeType==1&&exitOnNextNode){result=node;return false}if(target==node)exitOnNextNode=true;if(node.childNodes){for(var i=0,len=node.childNodes.length;i<len;++i){if(getNodes(node.childNodes[i])===false)return false}}}getNodes(root);return result}function getNextTextNode(root,target){var result,exitOnNextNode;function getNodes(node){if(node.nodeType!=3&&node.nodeType!=1)return;if(node.nodeType==3&&exitOnNextNode){result=node;return false}if(target==node)exitOnNextNode=true;if(node.childNodes){for(var i=0,len=node.childNodes.length;i<len;++i){if(getNodes(node.childNodes[i])===false)return false}}}getNodes(root);return result}function isBlock(node){if(!node)return;if(node.__is_block)return node.__is_block;if(!node.ownerDocument||!node.tagName||hasSkipNode(node)){return node.__is_block=false}var tagName=node.tagName.toLowerCase();var result=["table","div","p","blockquote","body","table","tr","th","td","ol","ul","li","h1","h2","h3","h4","h5","h6"].indexOf(tagName)!=-1;if(node.style.display=="block")result=true;node.__is_block=result;return result}function isPreWrap(node,root){if(node.__white_space)return node.__white_space==="pre-wrap";var parent=node.nodeType==3?node.parentNode:node;while(parent!=root||node==root||node.parentNode==root){parent.__white_space||(parent.__white_space=getComputedStyle(parent).whiteSpace);if(parent.__white_space==="pre-wrap"){node.__white_space=parent.__white_space;return node.__white_space=="pre-wrap"}parent=parent.parentNode;if(node==root||node.parentNode==root)return}}function getNodeInfo(root,node){if(node.__node_info&&document.location.hash.indexOf("cache")>-1){node.__node_info.pos=node.__node_info.offset=node.__node_info.prevIsBrWithinNode=undefined;return node.__node_info}var nodeIsBlock=isBlock(node);var next=node.nextSibling;var prev=node.previousSibling;var parent=node.parentNode;var preWrap=isPreWrap(node,root);var nextContent;if(next&&next.nodeType==3&&!next.data){next=next.nextSibling;nextContent=trimmedContent(next,preWrap)}else{nextContent=trimmedContent(next,preWrap)}var prevContent;if(prev&&prev.nodeType==3&&!prev.data){prev=prev.previousSibling;prevContent=trimmedContent(prev,preWrap)}else{prevContent=trimmedContent(prev,preWrap)}var lastChildContent=next&&trimmedContent(parent.lastChild,preWrap);if(isBlock(next)){var nextIsBlock=true;var nextInline=false}else{var nextIsBlock=false;var nextInline=true}if(isBlock(prev)){var prevIsBlock=true;var prevInline=false}else{var prevIsBlock=false;var prevInline=true}var nodeIsBr=node.tagName=="BR";var nodeIsP=node.tagName=="P";var nextIsBr=next&&next.tagName=="BR";var prevIsBr=prev&&prev.tagName=="BR";var nextIsLastChild=next&&parent.lastElementChild==next&&!lastChildContent;var nodeIsFirstChild=parent.firstChild==node||!trimmedContent(parent.firstChild,preWrap)&&parent.firstElementChild==node;var nodeIsLastChild=parent.lastChild==node||!lastChildContent&&parent.lastElementChild==node;var nodeIsRootFirstChild=nodeIsFirstChild&&parent==root;var nodeWithContent=!!(trimmedContent(node,preWrap)||nodeIsBlock&&node.getElementsByTagName("br")[0]||node.tagName&&node.getElementsByTagName("img")[0]);var prevWithContent=!!(prev&&prevContent);var nextWithContent=!!(next&&nextContent);var parentWithContent=!!trimmedContent(parent,preWrap);var nextIsInline=next&&(next.nodeType==3||nextInline)&&nextWithContent;var prevIsInline=prev&&(prev.nodeType==3||prevInline)&&prevWithContent;var nextIsBlockWithContent=nextIsBlock&&nextWithContent;var prevIsBlockWithContent=prevIsBlock&&prevWithContent;var onlyOneChild=parent.children.length==1;return node.__node_info={node:node,root:root,preWrap:preWrap,isTextNode:node.nodeType==3,nodeIsBlock:nodeIsBlock,nodeIsBr:nodeIsBr,nodeIsP:nodeIsP,isRoot:node==root,nodeWithContent:nodeWithContent,next:next,nextIsLastChild:nextIsLastChild,nextWithContent:nextWithContent,nextIsInline:nextIsInline,nextIsBlockWithContent:nextIsBlockWithContent,nextIsBr:nextIsBr,nextInline:nextInline,nextIsBlock:nextIsBlock,nodeIsFirstChild:nodeIsFirstChild,nodeIsRootFirstChild:nodeIsRootFirstChild,prev:prev,prevWithContent:prevWithContent,prevIsInline:prevIsInline,prevIsBlockWithContent:prevIsBlockWithContent,prevIsBr:prevIsBr,prevInline:prevInline,prevIsBlock:prevIsBlock,nodeIsLastChild:nodeIsLastChild,onlyOneChild:onlyOneChild,parentWithContent:parentWithContent}}function isBr(ni){var result=false;if(ni.nodeIsBlock&&ni.nodeWithContent&&ni.nextIsInline&&!ni.prevIsBrWithinNode)result=true;if(!ni.nodeIsBlock&&ni.nodeWithContent&&(ni.nextIsBlock||ni.nextIsBr))result=true;if(ni.nodeIsBlock&&ni.nodeWithContent&&ni.nextIsBlock&&!ni.prevIsBrWithinNode)result=true;if(ni.nextIsBr&&!ni.nextIsLastChild&&ni.nodeWithContent)result=true;if(ni.nodeIsBr&&!ni.parentWithContent&&ni.nodeIsLastChild)result=true;if(ni.nodeIsBr&&ni.nextIsBr)result=true;if(ni.nodeIsBr&&ni.nodeIsFirstChild&&!ni.onlyOneChild)result=true;if(ni.nodeIsBr&&ni.nextIsInline&&!ni.prevWithContent&&!ni.prevIsBr)result=true;if(ni.nodeIsBr&&ni.nextIsBlockWithContent&&ni.prevIsBlockWithContent)result=true;if(ni.isRoot)result=false;if(ni.preWrap&&ni.node.textContent[ni.node.textContent.length-1]=="\n"&&(ni.prev?ni.prevIsBlock:true)&&(ni.next?ni.nextIsBlock:true))result=false;if(ni.isTextNode&&nodeBetweenTags(ni))result=false;if(isTableCell(ni.node))result=false;return result}function nodeBetweenTags(ni){if(ni.node.parentNode)return["table","tbody","thead","tr"].indexOf(ni.node.parentNode.tagName.toLowerCase())!=-1}function getNodeText(ni){if(!ni.node.nodeValue)return"";if(nodeBetweenTags(ni))return"";if(ni.preWrap)return ni.node.nodeValue;var val=collapseSpaces(ni.node.nodeValue);if((!ni.next||!ni.prev)&&!isBlock(ni.node.parentNode)&&!ni.prevIsBr){ni.node.__node_text=val;return val}if(!ni.prev||ni.prevIsBlock||ni.prevIsBr)val=replaceLeftSpaces(val);if(!ni.next||ni.nextIsBlock)val=replaceRightSpaces(val);ni.node.__node_text=val;return val}function isTableCell(node){if(!node)return;return node.tagName=="TD"||node.tagName=="TH"}function hasSkipNode(node){if(node.nodeType!==1){return false}return hasSkipTag(node)||hasSkipClass(node)}function hasSkipTag(node){var tagName=node.tagName.toLowerCase();return SKIP_TAGS.indexOf(tagName)>=0}function hasSkipClass(node){for(var i=0;i<SKIP_CLASSES.length;i++){if(node.classList.contains(SKIP_CLASSES[i])){return true}}return false}function getText(node,cb){var hasCb=cb;cb=cb||_f;node.normalize();var isCached=!hasCb&&node.__getText&&node.__getText.getText&&node.__getText.innerHTML===node.innerHTML;if(isCached){return node.__getText.getText}function parse(root,options){var result=[],brAddedAtNode,pos=0;function getNodes(node){if(node.nodeType!=3&&node.nodeType!=1)return;if(hasSkipNode(node))return;var ni=getNodeInfo(root,node);var oldPos=pos;if(nodeBetweenTags(ni)&&node.nodeType==3)return;if(ni.isTextNode){var val=getNodeText(ni);pos+=val.length;if(val)result.push(val);if(ni.preWrap&&val[val.length-1]=="\n"){brAddedAtNode=node.parentNode}}if(node.childNodes&&!hasSkipNode(node)){for(var i=0,len=node.childNodes.length;i<len;++i){if(getNodes(node.childNodes[i])===false)return false}}if(node.tagName=="IMG")result.push("");if(isTableCell(node)&&isTableCell(node.nextElementSibling)){result.push(tab);pos++}var line=result[result.length-1];var prevIsBrWithinNode=line&&line[line.length-1]=="\n"&&(brAddedAtNode==node||isDescendant(brAddedAtNode,node)||isDescendant(node,brAddedAtNode));ni.prevIsBrWithinNode=prevIsBrWithinNode;var br=isBr(ni);if(br){result.push("\n");pos++;brAddedAtNode=node.parentNode}if(cb(ni,oldPos)===false)return false}getNodes(root);return result.join("")}var parsedNode=parse(node);if(hasCb&&node.__getText){delete node.__getText}if(!hasCb){node.__getText={getText:parsedNode,innerHTML:node.innerHTML}}return parsedNode}function nodeOffsetToTextOffset(nodePos,offset,ni){var result=nodePos;if(ni.isTextNode){var v1=ni.node.textContent.substr(0,offset);if(trim(v1))v1=replaceRightSpaces(v1);var ni2={prev:ni.prev,prevIsBlock:ni.prevIsBlock,prevIsBr:ni.prevIsBr,node:{nodeValue:v1}};var v2=getNodeText(ni2);result=offset+nodePos-(v1.length-v2.length)}else{if(ni.nodeIsBr&&!ni.onlyOneChild)result--}return result}function getPosInText(root,node,offset){var result=0;if(node.childNodes.length&&offset>0){node=node.childNodes[offset];offset=0}getText(root,function(ni,nodePos){if(ni.node==node){result=nodeOffsetToTextOffset(nodePos,offset,ni);return false}});return result}function markChildPos(root){getText(root,function(ni,nodePos){if(!ni.isTextNode){ni.node.__pos=nodePos}})}function getNodeByTextPos(root,pos){var result=null;root.normalize();getText(root,function(ni,nodePos){ni.pos=nodePos;ni.offset=0;var nodeEnd=nodePos+getNodeText(ni).length;if(nodePos==nodeEnd)return true;if(pos>=nodePos&&pos<=nodeEnd){var val=ni.node.nodeValue||"";for(var i=0;i<=val.length;i++){if(pos==nodeOffsetToTextOffset(nodePos,i,ni)){ni.offset=i;continue}}if(ni.nodeIsBr&&ni.offset==0||ni.isTextNode&&!ni.nodeWithContent){return true}result=ni;return false}});return result}function getCursorPos(root){var sel=root.ownerDocument.getSelection();if(!sel.anchorNode)return{s:-1,e:-1};var s=getPosInText(root,sel.anchorNode,sel.anchorOffset);var e=sel.isCollapsed?s:getPosInText(root,sel.focusNode,sel.focusOffset);return{s:s,e:e}}function setCursorPos(root,pos){var sNi=getNodeByTextPos(root,pos.s);var eNi=pos.s==pos.e?sNi:getNodeByTextPos(root,pos.e);if(!sNi||sNi<0||eNi<0)return;setRange(sNi,eNi,root.ownerDocument)}function setRange(sNi,eNi){var doc=sNi.node.ownerDocument;try{if(!eNi)eNi=sNi;var sel=doc.getSelection();var range=doc.createRange();range.setStart(sNi.node,sNi.offset);range.setEnd(eNi.node,eNi.offset);sel.removeAllRanges();sel.addRange(range)}catch(e){console.log(e)}}}();try{module.exports=Wrap}catch(e){}var Wrap2=function(){var _document;var _window;if(typeof document!=="undefined"&&typeof window!=="undefined"){_document=document;_window=window}else{_document=require("jsdom").jsdom();_window=_document.createWindow?_document.createWindow():_document.parentWindow}var EMPTY_FUNCTION=function(){};var _=require("lodash");var SPACES_WITHOUT_NBSP=[10,8,32,8194,8195,8196,8197,8198,8199,8200,8201,8202,8203,8287,12288].map(function(s){return String.fromCharCode(s)});var leftSpaceRe=new RegExp("^["+SPACES_WITHOUT_NBSP.join("")+"]+","g");var rightSpaceRe=new RegExp("["+SPACES_WITHOUT_NBSP.join("")+"]+$","g");var spaceRe=new RegExp("["+SPACES_WITHOUT_NBSP.join("")+"]+","g");var newlineRe=/\n+/g;var tab=String.fromCharCode(9);var SKIP_CLASSES=[];var SKIP_TAGS={pre:true,code:true,blockquote:true,PRE:true,CODE:true,BLOCKQUOTE:true};var blockTagNames={table:true,div:true,p:true,blockquote:true,body:true,tr:true,th:true,td:true,ol:true,ul:true,li:true,h1:true,h2:true,h3:true,h4:true,h5:true,h6:true,TABLE:true,DIV:true,P:true,BLOCKQUOTE:true,BODY:true,TR:true,TH:true,TD:true,OL:true,UL:true,LI:true,H1:true,H2:true,H3:true,H4:true,H5:true,H6:true};var tableTagNames={table:true,tbody:true,thead:true,tr:true,TABLE:true,TBODY:true,THEAD:true,TR:true};var BR_TAG="BR";var IMG_TAG="IMG";var NEWLINE="\n";var TRUTHY_FUNCTION=function(){return true};var entityMap={mark:{"&":"᪥","<":"Ᲊ",">":"ᲆ",'"':"᯼","'":"ᨋ","/":"ᩗ"},escape:{"᪥":"&amp;","Ᲊ":"&lt;","ᲆ":"&gt;","᯼":"&quot;","ᨋ":"&#x27;","ᩗ":"&#x2F;"}};var replaceLeftSpaces=function(str){return str.replace(leftSpaceRe,"")};if(String.prototype.trimLeft){replaceRightSpaces=function(str){return str.trimLeft()}}var replaceRightSpaces=function(str){return str.replace(rightSpaceRe,"")};if(String.prototype.trimRight){replaceRightSpaces=function(str){return str.trimRight()}}var trim=function(str){return str.replace(leftSpaceRe,"").replace(rightSpaceRe,"")};if(String.prototype.trim){trim=function(str){return str.trim()}}function detectIE(){var ua=_window.navigator.userAgent;var msie=ua.indexOf("MSIE ");if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10)}var trident=ua.indexOf("Trident/");if(trident>0){var rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}var edge=ua.indexOf("Edge/");if(edge>0){return parseInt(ua.substring(edge+5,ua.indexOf(".",edge)),10)}return false}var isIE=!!detectIE();var entityRegexes={mark:new RegExp("["+_.keys(entityMap.mark).join("")+"]","g"),escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g")};return window.__Wrap={render:render,getNodeInfo:getNodeInfo,unwrap:unwrap,setRange:setRange,getNextTextNode:getNextTextNode,isDescendant:isDescendant,getNodeText:getNodeText,getCursorPos:getCursorPos,setCursorPos:setCursorPos,isBr:isBr,isBlock:isBlock,invalidateNode:invalidateNode,getNodeByTextPos:getNodeByTextPos,getPosInText:getPosInText,markChildPos:markChildPos,getText:getText,collision:collision,mergeNodes:mergeNodes,hasSkipNode:hasSkipNode,hasSkipTag:hasSkipTag,hasSkipClass:hasSkipClass,skipClass:skipClass,skipTag:skipTag};function skipClass(cls){if(!cls){return SKIP_CLASSES}SKIP_CLASSES=cls}function skipTag(tag){if(!tag){return SKIP_TAGS}SKIP_TAGS=tag}function matchParent(m){while(m.parent){m=m.parent}return m}function splitOverlaps(m){var matches=m.concat();for(var i=0,ilen=matches.length;i<ilen;i++){var a=matches[i],split=[];if(a._s===undefined){a._s=a.s;a._e=a.e}for(var k=i+1,klen=matches.length;k<klen;k++){var b=matches[k];if(b._s===undefined){b._s=b.s;b._e=b.e}if(collision(a,b)<=0)continue;if(a._s>b._s&&a._e-b._e>0){split.push({_s:a._s,_e:b._e,parent:a},{_s:b._e,_e:a._e,parent:a});break}else if(a._e<b._e&&b._s-a._s>0){split.push({_s:a._s,_e:b._s,parent:a},{_s:b._s,_e:a._e,parent:a});break}}if(split.length){matches.splice.apply(matches,[i,1].concat(split));i=0}}matches.sort(function(a,b){return a._s-b._s||b._e-a._e});return matches}function collision(a,b){return Math.min(a._e,b._e)-Math.max(a._s,b._s)}function markEscape(string){if(string==null)return"";return(""+string).replace(entityRegexes.mark,function(m){return entityMap.mark[m]})}function escapeEntities(string){if(string==null)return"";return(""+string).replace(entityRegexes.escape,function(m){return entityMap.escape[m]})}function renderDom(config){var i,len,node=config.node,matches=config.matches,createElement=config.createElement,isValidNode=config.isValidNode||TRUTHY_FUNCTION,isValidMatchForNode=config.isValidMatchForNode||function(node,validNode){return validNode};var splitMatches=[];for(i=0,matches=splitOverlaps(matches),len=matches.length;i<len;i++){if(!matches[i].inDom&&!matchParent(matches[i]).inDom){splitMatches.push(matches[i])}}if(splitMatches.length===0)return;wrapDom(node,node,0,splitMatches,null,createElement,isValidNode,isValidMatchForNode);splitMatches=[];for(i=0,matches=splitOverlaps(matches),len=matches.length;i<len;i++){if(!matches[i].inDom&&!matchParent(matches[i]).inDom){splitMatches.push(matches[i])}}}function br(val){return val.replace(/\n/g,"<br>")}function renderText(config){var text=config.text,node=config.node,matches=config.matches,createTag=config.createTag,updateMethod=config.updateMethod;if(updateMethod){updateMethod(text,matches,function(text,matches){var splitMatches=splitOverlaps(matches);return wrapText(text,splitMatches,createTag)})}else{node.innerHTML=br(wrapText(text,matches,createTag))}}function render(config){if(config.type==="dom"){return renderDom(config)}if(config.type==="text"){return renderText(config)}}function defaultCreateTag(m){var parent=m.parent||m,cls="";return{start:"<g class='gr_ gr_"+parent.id+cls+"' id='"+parent.id+"'>",end:"</g>"}}function wrapText(text,matches,createTag){var initial=text;text=markEscape(text);createTag=createTag||defaultCreateTag;var closeAts=[],tag,s=0,i,j,m,parent,startTag,start,len;for(i=0,len=matches.length;i<len;i++){m=matches[i];m.calculatedPos=false;parent=m.parent||m;parent.inDom=true;if(parent.orig)parent.orig.inDom=true;parent=parent.orig||parent;tag=createTag(parent,initial);parent.renderTs=parent.renderTs||Date.now();startTag=tag.start;start=s+m._s;text=text.substring(0,start)+startTag+text.substring(start);s+=startTag.length;for(j=0,len=closeAts.length;j<len;j++){if(closeAts[j]>start){closeAts[j]+=startTag.length}}closeAts.push(s+m._e)}closeAts.sort(function(a,b){return a-b});s=0;for(j=0,len=closeAts.length;j<len;j++){start=s+closeAts[j];
text=text.substring(0,start)+tag.end+text.substring(start);s+=tag.end.length}return escapeEntities(text)}function defaultCreateElement(m,val){var el=_document.createElement("g");el.className="gr_ gr_"+m.id;el.textContent=val;el.id=m.id;return el}function replaceRange(node,s,e,newNode){var ownerDocument=node.ownerDocument||node;var range=ownerDocument.createRange();try{range.setStart(node,s);range.setEnd(node,e);range.deleteContents();range.insertNode(newNode)}catch(e){Wrap.error&&Wrap.error("replaceRange");throw e}}function wrapDom(root,node,start,matches,state,createElement,isValidNode,isValidMatchForNode){var child,s=start||0,i,len,fixIE;var textNode={_s:undefined,_e:undefined};createElement=createElement||defaultCreateElement;state=state||{level:-1,validNodeForMatchLevel:0,validNodeForMatch:false};state.text=state.text||getText(root);var level=state.level;var validNodeForMatch=isValidNode(node);if(!validNodeForMatch){state.validNodeForMatch=false;state.validNodeForMatchLevel=state.level}else{if(state.level<=state.validNodeForMatchLevel){state.validNodeForMatch=true;state.validNodeForMatchLevel=state.level}}state.level++;node.__s=s;for(i=0,len=node.childNodes.length;i<len;i++){child=node.childNodes[i];if(child.__jump_next){i++;child.__jump_next=null;child=node.childNodes[i]}if(!child)continue;if(child.nodeType!==1&&child.nodeType!==3)continue;if(hasSkipNode(child))continue;var ni=getNodeInfo(root,child);if(isNodeBetweenTags(ni)&&child.nodeType===3)continue;if(child.nodeType!==3){s=wrapDom(root,child,s,matches,state,createElement,isValidNode,isValidMatchForNode)}var brAddedAtNode=state.brAddedAtNode,prevIsBr=state.prevIsBr,prevIsBrWithinNode=prevIsBr&&(brAddedAtNode===child||isDescendant(brAddedAtNode,child)||isDescendant(child,brAddedAtNode));ni.prevIsBrWithinNode=prevIsBrWithinNode;var val=getNodeText(ni),nodeVal=val;textNode._s=s;textNode._e=s+val.length;s=textNode._e;if(val){state.prevIsBr=false}var br=isBr(ni);if(br){state.prevIsBr=true;s++;state.brAddedAtNode=child.parentNode}if(ni.isPreWrap&&val.indexOf(NEWLINE)!==-1){state.prevIsBr=true;state.brAddedAtNode=child.parentNode}if(ni.node.tagName===IMG_TAG)state.prevIsBr=false;if(child.nodeType!==3||textNode._s===textNode._e)continue;if(nodeVal!==child.textContent){child.textContent=nodeVal}for(var k=0,klen=matches.length;k<klen;k++){var m=matches[0];var parent=m.parent||m;m.__s=m.__s||m._s;m.__e=m.__e||m._e;if(m.__s>=textNode._e)break;while(state.text[m.__s]===NEWLINE){m.__s++}if(m.__s<textNode._s){var p=child.parentNode;while(p.__s>m.__s){p=p.parentNode}m.__timesRendered=m.__timesRendered||0;m.__timesRendered++;if(m.__timesRendered>5){break}wrapDom(root,p,p.__s,matches,state,createElement,isValidNode,isValidMatchForNode)}if(textNode._e<m._e){var oldS=m.__s;m.__s=textNode._e;m={__s:oldS,__e:textNode._e,parent:m}}else{matches.shift();k--}if(!state.validNodeForMatch&&!isValidMatchForNode(child,state.validNodeForMatch,parent))continue;var matchS=0;if(textNode._s<m.__s){matchS=m.__s-textNode._s;val=val.substr(matchS)}m.calculatedPos=false;var matchLen=m.__e-m.__s,matchE=matchS+matchLen,mParent=matchParent(m);var el=createElement(mParent,val.substr(0,matchLen));mParent.renderTs=mParent.renderTs||Date.now();parent.inDom=true;start=s+m.__s;val=val.substr(0,matchLen);replaceRange(child,matchS,matchE,el);if(isIE){if(el.parentNode.tagName!==el.tagName){el.__jump_next=true}if(node.firstChild&&node.firstChild.nodeType===3&&node.firstChild.textContent.length===0){node.removeChild(node.firstChild)}else{}if(!child.parentNode){fixIE=true;child=el}}clearCachedValues(child);if(child.parentNode===node){if(!fixIE){i++}textNode._s=m.__s;textNode._e=m.__e;el.__s=m.__s;s=m.__e;var _br=isBr(getNodeInfo(root,el));if(_br)s++}m.__s=null;m.__e=null;m.__timesRendered=null;child=el.firstChild;if(el.parentNode!==node&&el.parentNode){wrapDom(root,el.parentNode,el.parentNode.__s,matches,state,createElement,isValidNode,isValidMatchForNode);continue}}}if(isTableCell(node)&&isTableCell(node.nextElementSibling)){if(matches[0]&&matches[0].__s===s){matches[0].__s++}s++}state.level=level;return s}function mergeNodes(nodes){if(!nodes||nodes&&nodes.length===0){return false}if(nodes.length===1){return nodes[0]}var mergedNode=nodes[0],len=nodes.length;for(var i=1;i<len;i++){mergedNode.appendChild(nodes[i]);invalidateNode(nodes[i].parentNode)}mergedNode.innerHTML=getText(mergedNode);mergedNode.normalize();nodes[0].parentNode.normalize();invalidateNode(mergedNode);invalidateNode(nodes[0].parentNode);return mergedNode}function trimmedContent(node,preWrap){if(!node)return;if(preWrap)return node.textContent;if(node.__trimmed_content)return node.__trimmed_content;node.__trimmed_content=trim(node.textContent);return node.__trimmed_content}function clearCachedValues(node){if(node.__trimmed_content)node.__trimmed_content=null;if(node.__node_text)node.__node_text=null}function invalidateNode(node){if(!node)return;clearCachedValues(node);node.parentNode&&node.parentNode.normalize();if(node.childNodes.length>0){for(var i=0,len=node.childNodes.length;i<len;i++){invalidateNode(node.childNodes[i])}}}function collapseSpaces(str){return str.replace(newlineRe," ").replace(spaceRe," ")}function isDescendant(parent,child){if(!child)return false;var node=child.parentNode;while(node){if(node===parent)return true;node=node.parentNode}return false}function unwrap(el){if(!el.parentNode)return;var doc=el.ownerDocument,p=el.parentNode;if(el.childNodes.length>1){var f=doc.createDocumentFragment();while(el.childNodes.length>0){var node=el.childNodes[0];f.appendChild(node)}p.replaceChild(f,el);invalidateNode(p)}else if(el.firstChild){p.replaceChild(el.firstChild,el);p.normalize();invalidateNode(p)}else{p.removeChild(el);p.normalize();invalidateNode(p)}}function getNextTextNode(root,target){var result,exitOnNextNode;function getNodes(node){if(node.nodeType!==3&&node.nodeType!==1)return;if(node.nodeType===3&&exitOnNextNode){result=node;return false}if(target===node)exitOnNextNode=true;if(node.childNodes){for(var i=0,len=node.childNodes.length;i<len;++i){if(getNodes(node.childNodes[i])===false)return false}}}getNodes(root);return result}function isBlock(node){if(!node||!node.ownerDocument||!node.tagName||hasSkipNode(node))return;if(node.__is_block)return node.__is_block;if(node.style.display==="block")return true;return blockTagNames[node.tagName]}function isPreWrap(node,root){if(node.__white_space)return node.__white_space==="pre-wrap";var parent=node.nodeType===3?node.parentNode:node;while(parent!==root||node===root||node.parentNode===root){parent.__white_space=parent.__white_space||parent.ownerDocument.defaultView.getComputedStyle(parent).getPropertyValue("white-space");if(parent.__white_space==="pre-wrap"){node.__white_space=parent.__white_space;return node.__white_space==="pre-wrap"}parent=parent.parentNode;if(node===root||node.parentNode===root)return}}function getNodeInfo(root,node){var nodeIsBlock=isBlock(node),next=node.nextSibling,prev=node.previousSibling,preWrap=isPreWrap(node,root);var prevContent=trimmedContent(prev,preWrap),nextContent=trimmedContent(next,preWrap);if(next&&next.nodeType===3&&!nextContent){next=next.nextSibling;nextContent=trimmedContent(next,preWrap)}if(prev&&prev.nodeType===3&&!prevContent){prev=prev.previousSibling;prevContent=trimmedContent(prev,preWrap)}var lastChildContent=next&&trimmedContent(next.parentNode.lastChild,preWrap);var nextIsBlock=isBlock(next),prevIsBlock=isBlock(prev),nextInline=next&&next.tagName&&!isBlock(next),prevInline=prev&&prev.tagName&&!isBlock(prev),nodeIsBr=node.tagName===BR_TAG,nodeIsP=node.tagName==="P",nextIsBr=next&&next.tagName===BR_TAG,prevIsBr=prev&&prev.tagName===BR_TAG,nextIsLastChild=next&&next.parentNode.lastElementChild===next&&!lastChildContent,nodeIsFirstChild=node.parentNode.firstChild===node||!trimmedContent(node.parentNode.firstChild,preWrap)&&node.parentNode.firstElementChild===node,nodeIsLastChild=node.parentNode.lastChild===node||!lastChildContent&&node.parentNode.lastElementChild===node,nodeIsRootFirstChild=nodeIsFirstChild&&node.parentNode===root,nodeWithContent=trimmedContent(node,preWrap)||nodeIsBlock&&node.getElementsByTagName(BR_TAG)[0]||node.tagName&&node.getElementsByTagName(IMG_TAG)[0],prevWithContent=prev&&prevContent,nextWithContent=next&&nextContent,parentWithContent=trimmedContent(node.parentNode,preWrap),nextIsElement=next&&(next.nodeType===3||nextInline)&&nextWithContent,prevIsElement=prev&&(prev.nodeType===3||prevInline)&&prevWithContent,nextIsBlockWithContent=nextIsBlock&&nextWithContent,prevIsBlockWithContent=prevIsBlock&&prevWithContent,onlyOneChild=node.parentNode.children.length===1;return{node:node,root:root,preWrap:preWrap,next:next,prev:prev,isTextNode:node.nodeType===3,nodeIsBlock:nodeIsBlock,nextIsBlock:nextIsBlock,prevIsBlock:prevIsBlock,nextInline:nextInline,prevInline:prevInline,nodeIsBr:nodeIsBr,nodeIsP:nodeIsP,nextIsBr:nextIsBr,prevIsBr:prevIsBr,nextIsLastChild:nextIsLastChild,nodeIsFirstChild:nodeIsFirstChild,nodeIsLastChild:nodeIsLastChild,nodeIsRootFirstChild:nodeIsRootFirstChild,nodeWithContent:nodeWithContent,prevWithContent:prevWithContent,nextWithContent:nextWithContent,parentWithContent:parentWithContent,nextIsElement:nextIsElement,prevIsElement:prevIsElement,nextIsBlockWithContent:nextIsBlockWithContent,prevIsBlockWithContent:prevIsBlockWithContent,onlyOneChild:onlyOneChild,isRoot:node===root}}function isBr(ni){var result=false;if(ni.nodeIsBlock&&ni.nodeWithContent&&ni.nextIsElement&&!ni.prevIsBrWithinNode)result=true;if(!ni.nodeIsBlock&&ni.nodeWithContent&&(ni.nextIsBlock||ni.nextIsBr))result=true;if(ni.nodeIsBlock&&ni.nodeWithContent&&ni.nextIsBlock&&!ni.prevIsBrWithinNode)result=true;if(ni.nextIsBr&&!ni.nextIsLastChild&&ni.nodeWithContent)result=true;if(ni.nodeIsBr&&!ni.parentWithContent&&ni.nodeIsLastChild)result=true;if(ni.nodeIsBr&&ni.nextIsBr)result=true;if(ni.nodeIsBr&&ni.nodeIsFirstChild&&!ni.onlyOneChild)result=true;if(ni.nodeIsBr&&ni.nextIsElement&&!ni.prevWithContent&&!ni.prevIsBr)result=true;if(ni.nodeIsBr&&ni.nextIsBlockWithContent&&ni.prevIsBlockWithContent)result=true;if(ni.isRoot)result=false;if(ni.preWrap&&ni.node.textContent[ni.node.textContent.length-1]===NEWLINE&&(ni.prev?ni.prevIsBlock:true)&&(ni.next?ni.nextIsBlock:true))result=false;if(ni.isTextNode&&isNodeBetweenTags(ni))result=false;if(isTableCell(ni.node))result=false;return result}function isNodeBetweenTags(ni){if(ni.node.parentNode)return tableTagNames[ni.node.parentNode.tagName]}function getNodeText(ni){if(ni.node.__node_text)return ni.node.__node_text;if(!ni.node.nodeValue)return"";if(isNodeBetweenTags(ni))return"";if(ni.preWrap)return ni.node.nodeValue;var val=collapseSpaces(ni.node.nodeValue);if((!ni.next||!ni.prev)&&!isBlock(ni.node.parentNode)&&!ni.prevIsBr){ni.node.__node_text=val;return val}if(!ni.prev||ni.prevIsBlock||ni.prevIsBr)val=replaceLeftSpaces(val);if(!ni.next||ni.nextIsBlock)val=replaceRightSpaces(val);ni.node.__node_text=val;return val}function isTableCell(node){if(!node)return;return node.tagName==="TD"||node.tagName==="TH"}function hasSkipNode(node){if(node.nodeType!==1){return false}return hasSkipTag(node)||hasSkipClass(node)}function hasSkipTag(node){return SKIP_TAGS[node.tagName]}function hasSkipClass(node){for(var i=0,len=SKIP_CLASSES.length;i<len;i++){if(node.classList.contains(SKIP_CLASSES[i])){return true}}return false}function getText(node,cb){var hasCb=cb;cb=cb||EMPTY_FUNCTION;node.normalize();var isCached=!hasCb&&node.__getText&&node.__getText.getText&&node.__getText.innerHTML===node.innerHTML;if(isCached){return node.__getText.getText}function parse(root){var result=[],brAddedAtNode,pos=0;function getNodes(node){if(node.nodeType!==3&&node.nodeType!==1)return;if(hasSkipNode(node))return;var ni=getNodeInfo(root,node);var oldPos=pos;if(isNodeBetweenTags(ni)&&node.nodeType===3)return;if(ni.isTextNode){var val=getNodeText(ni);pos+=val.length;if(val)result.push(val);if(ni.preWrap&&val[val.length-1]===NEWLINE){brAddedAtNode=node.parentNode}}if(node.childNodes&&!hasSkipNode(node)){for(var i=0,len=node.childNodes.length;i<len;++i){if(getNodes(node.childNodes[i])===false)return false}}if(node.tagName===IMG_TAG)result.push("");if(isTableCell(node)&&isTableCell(node.nextElementSibling)){result.push(tab);pos++}var line=result[result.length-1];var prevIsBrWithinNode=line&&line[line.length-1]===NEWLINE&&(brAddedAtNode===node||isDescendant(brAddedAtNode,node)||isDescendant(node,brAddedAtNode));ni.prevIsBrWithinNode=prevIsBrWithinNode;var br=isBr(ni);if(br){result.push(NEWLINE);pos++;brAddedAtNode=node.parentNode}if(cb(ni,oldPos)===false)return false}getNodes(root);return result.join("")}var parsedNode=parse(node);if(hasCb&&node.__getText){node.__getText=null}if(!hasCb){node.__getText={getText:parsedNode,innerHTML:node.innerHTML}}return parsedNode}function nodeOffsetToTextOffset(nodePos,offset,ni){var result=nodePos;if(ni.isTextNode){var v1=ni.node.textContent.substr(0,offset);if(trim(v1))v1=replaceRightSpaces(v1);var ni2={prev:ni.prev,prevIsBlock:ni.prevIsBlock,prevIsBr:ni.prevIsBr,node:{nodeValue:v1}};var v2=getNodeText(ni2);result=offset+nodePos-(v1.length-v2.length)}else{if(ni.nodeIsBr&&!ni.onlyOneChild)result--}return result}function getPosInText(root,node,offset){var result=0;if(node.childNodes.length&&offset>0){node=node.childNodes[offset];offset=0}getText(root,function(ni,nodePos){if(ni.node===node){result=nodeOffsetToTextOffset(nodePos,offset,ni);return false}});return result}function markChildPos(root){getText(root,function(ni,nodePos){if(!ni.isTextNode){ni.node.__pos=nodePos}})}function getNodeByTextPos(root,pos){var result=null;root.normalize();getText(root,function(ni,nodePos){ni.pos=nodePos;ni.offset=0;var nodeEnd=nodePos+getNodeText(ni).length;if(nodePos===nodeEnd)return true;if(pos>=nodePos&&pos<=nodeEnd){var val=ni.node.nodeValue||"";for(var i=0,len=val.length;i<=len;i++){if(pos===nodeOffsetToTextOffset(nodePos,i,ni)){ni.offset=i;continue}}if(ni.nodeIsBr&&ni.offset===0||ni.isTextNode&&!ni.nodeWithContent){return true}result=ni;return false}});return result}function getCursorPos(root){var sel=root.ownerDocument.getSelection();if(!sel.anchorNode)return{s:-1,e:-1};var s=getPosInText(root,sel.anchorNode,sel.anchorOffset);var e=sel.isCollapsed?s:getPosInText(root,sel.focusNode,sel.focusOffset);return{s:s,e:e}}function setCursorPos(root,pos){var sNi=getNodeByTextPos(root,pos.s);var eNi=pos.s===pos.e?sNi:getNodeByTextPos(root,pos.e);if(!sNi||sNi<0||eNi<0)return;setRange(sNi,eNi,root.ownerDocument)}function setRange(sNi,eNi){var doc=sNi.node.ownerDocument;try{if(!eNi)eNi=sNi;var sel=doc.getSelection();var range=doc.createRange();range.setStart(sNi.node,sNi.offset);range.setEnd(eNi.node,eNi.offset);sel.removeAllRanges();sel.addRange(range)}catch(e){console.log(e)}}}();try{module.exports=Wrap2}catch(e){}if(typeof module!="undefined")module.exports=require("./lib/wrap");var Util=function(){var _=require("lodash");_f=function(){};if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};fNOP.prototype=this.prototype;fBound.prototype=new fNOP;return fBound}}String.prototype.trimLeft=String.prototype.trimLeft||function(){return String(this).replace(/^\s+/,"")};String.prototype.trimRight=String.prototype.trimRight||function(){return String(this).replace(/\s+$/,"")};var NBSP_RE=new RegExp(String.fromCharCode(160),"g"),nbsp=String.fromCharCode(160),reBr=/\n/g,reLastSpace=/\s$/g,reBrSpace=new RegExp("\n"+String.fromCharCode(32),"g"),re2Spaces=new RegExp(String.fromCharCode(32)+String.fromCharCode(32),"g"),tagsForWatch=["b","strong","i","em","u","ins","s","font","span","ul","li","ol","a","img","blockquote","h1","h2","h3","h4","h5","h6"],watchetrs=[];var cssNumber={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1};return{guid:guid,listen:listen,unlisten:unlisten,watch:watch,unwatch:unwatch,elementInDocument:elementInDocument,hasClass:hasClass,addClass:addClass,css:css,removeClass:removeClass,insertBefore:insertBefore,insertAfter:insertAfter,createEl:createEl,NBSP_RE:NBSP_RE,matchesSelector:matchesSelector,isFocused:isFocused,br:br};function S4(){return((1+Math.random())*65536|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function listen(el,event,cb,unbind,b){if(!el)return;if(b==undefined)b=false;var func=unbind?"removeEventListener":"addEventListener";cb.__wrapFunc=cb.__wrapFunc||function(e){cb(_.extend({originalEvent:e,preventDefault:_f,stopPropagation:_f},e.detail))};el[func](event+"-gr",cb.__wrapFunc,b);el[func](event,cb,b)}function unlisten(el,event,cb,b){listen(el,event,cb,true,b)}function elementInDocument(element,doc){doc=doc||document;while(element){if(element==doc){return true}element=element.parentNode}return false}function createEl(html,doc){var div=(doc||document).createElement("div");div.innerHTML=html.trim();return div.firstElementChild}function matchesSelector(el,sel){if(window.$&&window.$.is)return $(el).is(sel);if(el.matchesSelector)return el.matchesSelector(sel);if(el.webkitMatchesSelector)return el.webkitMatchesSelector(sel);if(el.mozMatchesSelector)return el.mozMatchesSelector(sel)}function maybeAddPx(name,value){return typeof value=="number"&&!cssNumber[dasherize(name)]?value+"px":value}function camelize(str){return str.replace(/-+(.)?/g,function(match,chr){return chr?chr.toUpperCase():""})}function dasherize(str){return str.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/_/g,"-").toLowerCase()}function css(el,property,value){if(arguments.length<3){var element=el,computedStyle=getComputedStyle(element,"");if(!element)return;if(typeof property=="string")return element.style[camelize(property)]||computedStyle.getPropertyValue(property);else if(_.isArray(property)){var props={};_.each(property,function(val,prop){props[prop]=element.style[camelize(prop)]||computedStyle.getPropertyValue(prop)});return props}}var css="";if(_.isString(property)){if(!value&&value!==0)el.style.removeProperty(dasherize(property));else css=dasherize(property)+":"+maybeAddPx(property,value)}else{for(key in property)if(!property[key]&&property[key]!==0)el.style.removeProperty(dasherize(key));else css+=dasherize(key)+":"+maybeAddPx(key,property[key])+";"}return el.style.cssText+=";"+css}function hasClass(_el,cls){if(!_el||_el.className==undefined)return false;return _el.classList.contains(cls)}function addClass(_el,cls){if(!_el)return;return _el.classList.add(cls)}function removeClass(_el,cls){if(!_el)return;return _el.classList.remove(cls)}function insertBefore(newElement,targetElement){targetElement.parentNode.insertBefore(newElement,targetElement)}function insertAfter(referenceNode,newNode){referenceNode.parentNode.insertBefore(newNode,referenceNode.nextSibling)}function isFF(){return window.navigator.userAgent.indexOf("Firefox")!=-1}function isFocused(el){if(isFF())return el.ownerDocument.activeElement==el;if(document.activeElement&&document.activeElement.tagName=="IFRAME"){return el===el.ownerDocument.activeElement}else if(document.activeElement&&document.activeElement.tagName=="BODY"){return el===document.activeElement}return el===document.activeElement}function br(val,last){val=val.replace(reBrSpace,"<br>"+nbsp).replace(reBr,"<br>");if(last){val=val.replace(reLastSpace,nbsp)}return val}function watch(node,cb){if(!window.MutationObserver){return false}var isWatch=_.findLast(watchetrs,{node:node,cb:cb});if(isWatch)return false;var callback=function(mutations){var targets=[],config={tags:tagsForWatch};mutations.forEach(function mutationCallback(mutation){if(mutation.addedNodes.length!==0){checkMutatin(mutation,mutation.addedNodes,"addedNodes")}if(mutation.removedNodes.length!==0){checkMutatin(mutation,mutation.removedNodes,"removedNodes")}});function checkMutatin(mutation,nodes,action){for(var i=0,total=nodes.length;i<total;i++){var tag=nodes[i].tagName?nodes[i].tagName:mutation.target.tagName;var toPush={node:mutation.target,tag:tag.toLowerCase(),action:action};if(mutation.target&&targets.indexOf(toPush)===-1){targets.push(toPush)}}}function isExternalChange(targets,config){var toInvalidate=[],isRm=false;targets.forEach(function isRmNodes(target){if(target.action==="removedNodes"){var currentTagName=target.node.tagName.toLowerCase();if(_.indexOf(config.tags,currentTagName)!==-1){isRm=true}}});targets.forEach(function isExternalChangeEach(target){var currentTagName=target.tag,isTagsMatch=_.indexOf(config.tags,currentTagName),toInalidateNode=false;if(target.action==="addedNodes"&&isTagsMatch!==-1||target.action==="removedNodes"&&isRm){toInalidateNode=target.node}if(toInalidateNode&&toInvalidate.indexOf(toInalidateNode)===-1){toInvalidate.push(toInalidateNode)}});if(toInvalidate.length){return toInvalidate}else{return false}}var toInvalid=isExternalChange(targets,config);if(toInvalid&&cb){cb(toInvalid)}},mo=new MutationObserver(callback),options={childList:true,subtree:true,attributes:false,characterData:false};mo.observe(node,options);watchetrs.push({node:node,cb:cb,mo:mo})}function unwatch(node,cb){var isWatch=_.findLast(watchetrs,{node:node,cb:cb});if(!isWatch){return false}isWatch.mo.disconnect();watchetrs=_.without(watchetrs,isWatch)}}();try{module.exports=Util}catch(e){}var HtmlDom=function(config){var Util=require("./util"),Wrap=require("wrap"),emitter=require("emitter"),_=require("lodash"),DOMPurify=require("dompurify");var editor=config.editor,el=config.el,document=el.ownerDocument;var me=emitter({render:render,remove:remove,renderRange:renderRange,removeBySelector:removeBySelector,replace:replace,getCleanHtml:getCleanHtml,getHtml:getHtml,start:start,stop:stop,select:select,deselect:deselect,getText:getText,setText:setText,setHtml:setHtml,changeSelection:changeSelection,getCursor:getCursor,setCursor:setCursor,unwrapToCommonParent:unwrapToCommonParent,invalidate:invalidate});if(editor&&editor.on)editor.on("immediatepaste",onpaste);var CLEANUP_FREQUENCY=1e3;var hasClass=Util.hasClass,addClass=Util.addClass,removeClass=Util.removeClass,isFocused=Util.isFocused,br=Util.br;var checkingTimer;var removeEls=[];return me;function render(matches,text){var inDom=_.where(editor.matches.get(),{inDom:true});var toRemoveFromDom=_.difference(inDom,matches);toRemoveFromDom.forEach(function(m){remove(m)});var doRender=false;for(var i=0;i<matches.length;i++){var m=matches[i];if(m.replaced){m._s=m.s;m._e=m.e}if(m.inDom)continue;doRender=true;removeCollisionMatches(m,matches)}if(!doRender)return me.emit("rendered");var cursor=getCursorInfo();_render(matches,text);if(isFocused(el)&&cursorChanged(cursor))setCursor(cursor.pos)}function removeCollisionMatches(m,matches){for(var j=0;j<matches.length;j++){var m2=matches[j];if(m._e-m._s>m2._e-m2._s&&Wrap.collision(m,m2)>0){if(m2.inDom)remove(m2)}}}function _render(matches,text){function createElement(m,val){var el=document.createElement("g"),cls=editor.getMatchClass(m,text||"");el.className="gr_ gr_"+m.id+cls+" "+(m.cls||"");el.textContent=val;el.id=m.id;el.setAttribute("data-gr-id",m.id);return el}Wrap.render({node:el,matches:matches,createElement:createElement,isValidNode:config.isValidNode,isValidMatchForNode:config.isValidMatchForNode,type:"dom"});for(var i=0;i<matches.length;i++){var m=matches[i];if(!m.inDom)editor.matches.remove(m,true)}me.emit("rendered")}function getText(invalidateNode){if(invalidateNode){me.emit("startInvalidateNode");Wrap.invalidateNode(el);me.emit("endInvalidateNode")}return Wrap.getText(el).replace(Util.NBSP_RE," ")}function setText(val){el.innerHTML=br(_.escape(val))}function setHtml(val){el.innerHTML=DOMPurify.sanitize(val)}function changeSelection(){var sel=document.getSelection();var node=sel.anchorNode;if(!node)return;var parent=node.parentNode;var selValue=sel.toString();if(selValue.length>1)return;if(hasClass(parent,"gr_")){if(hasClass(parent.parentNode,"gr_spell"))parent=parent.parentNode;return editor.selectById(parent.id)}var nextNode=node.nextElementSibling;if(nextNode&&node.__node_text&&hasClass(nextNode,"gr_tiny")&&node.__node_text.length==sel.focusOffset){return editor.selectById(nextNode.id)}if(editor.selectedMatch)editor.selectedMatch.deselect()}function getCursorInfo(){var sel=document.getSelection(),aNode=sel.anchorNode||{},fNode=sel.focusNode||{};return{pos:getCursor(),aNode:aNode,aNodeText:aNode.textContent,aNodeParent:aNode.parentNode,fNode:fNode,fNodeText:fNode.textContent,fNodeParent:fNode.parentNode}}function cursorChanged(oldSel){var sel=document.getSelection(),aNode=sel.anchorNode||{},fNode=sel.focusNode||{};return oldSel.aNode!=aNode||oldSel.aNodeText!=aNode.textContent||oldSel.aNodeParent!=aNode.parentNode||oldSel.fNode!=fNode||oldSel.fNodeText!=fNode.textContent||oldSel.fNodeParent!=fNode.parentNode}function setCursor(pos){Wrap.setCursorPos(el,pos)}function getCursor(){return Wrap.getCursorPos(el)}function renderRange(match){match._s=match.s;match._e=match.e;match.id="tmp_id";match.cls="gr_tmp_id";_render([match]);return el.querySelectorAll(".gr_tmp_id")}function getSel(match){return".gr_"+match.id}function removeBySelector(sel){var p=Wrap.getCursorPos(el);var els=el.querySelectorAll(sel),len=els.length;for(var i=0;i<len;i++){Wrap.unwrap(els[i])}Wrap.setCursorPos(el,p)}function remove(match,withText){var p=Wrap.getCursorPos(el);var els=el.querySelectorAll(getSel(match)),len=els.length;for(var i=0;i<len;i++){if(withText){els[i].parentNode.removeChild(els[i]);continue}Wrap.unwrap(els[i])}match.inDom=false;Wrap.setCursorPos(el,p)}function getCommonParent(nodes){var i,node1=nodes[0];method="contains"in node1?"contains":"compareDocumentPosition",test=method==="contains"?1:16;rocking:while(node1=node1.parentNode){i=nodes.length;while(i--){if((node1[method](nodes[i])&test)!==test)continue rocking}return node1}return null}function unwrapToCommonParent(nodes){var commonParent=getCommonParent(nodes),len=nodes.length,nodeList=nodes;if(len>1){var mergedNode=Wrap.mergeNodes(nodes);nodeList=[];nodeList.push(mergedNode);len=nodeList.length}for(var i=0;i<len;i++){var node=nodeList[i],p=node.parentNode,j=0;while(p!=commonParent&&j<1e3){var _p=p;p=p.parentNode;Wrap.unwrap(_p);j++}Wrap.unwrap(node)}}function replace(match,value,isUndo){removeCollisionMatches(match,editor.getFiltered());var nodes=renderRange({s:match.s,e:match.e});if(nodes.length>1){unwrapToCommonParent(nodes)}var node=renderRange({s:match.s,e:match.e})[0];node.textContent=value;node.id=match.id;match.replaced=!isUndo;match.inDom=!isUndo;node.className="gr_ gr_"+match.id+editor.getMatchClass(match,editor.getText())+" "+(match.cls||"");node.setAttribute("data-gr-id",match.id);if(isUndo)Wrap.unwrap(node)}function select(match){var alerts=document.querySelectorAll(getSel(match)),len=alerts.length;for(var i=0;i<len;i++){addClass(alerts[i],"sel")}}function deselect(match){var alerts=document.querySelectorAll(getSel(match)),len=alerts.length;for(var i=0;i<len;i++){removeClass(alerts[i],"sel")}}function nodePosValid(matchEl,m){var s=matchEl.__pos;var e=s+matchEl.textContent.length;var result=s>=m._s&&e<=m._e;return result}function invalidate(associateMatches){clearTimeout(checkingTimer);var els=el.querySelectorAll("g[data-gr-id]"),len=els.length;var ids=[];Wrap.markChildPos(el);for(var i=0;i<len;i++){var matchEl=els[i];var m=editor.matches.byId(matchEl.id);ids.push(matchEl.id);if(m&&nodePosValid(matchEl,m)){if(!m.inDom&&associateMatches)m.inDom=true;if(!m.selected&&hasClass(matchEl,"sel"))removeClass(matchEl,"sel");if(!matchEl.className){var cls=editor.getMatchClass(m,editor.getText());matchEl.className="gr_ gr_"+m.id+cls+" "+(m.cls||"")}continue}var cursor=getCursorInfo();Wrap.unwrap(matchEl);if(isFocused(el)&&cursorChanged(cursor))setCursor(cursor.pos)}var matches=editor.getFiltered(),shouldRender=false;for(var i=0;i<matches.length;i++){var m=matches[i],id=m.id;if(ids.indexOf(id)!=-1)continue;m.inDom=false;shouldRender=true}if(shouldRender)render(matches,editor.getText());checkingTimer=setTimeout(invalidate,CLEANUP_FREQUENCY)}function removeComments(node){for(var i=0,len=node.childNodes.length;i<len;++i){var _el=node.childNodes[i];if(_el.nodeType!=3&&_el.nodeType!=1){removeEls.push(_el)}if(_el.nodeType==3){removeComments(_el)}}}function onpaste(){setTimeout(function(){removeComments(el);for(var i=0;i<removeEls.length;i++){var _el=removeEls[i];_el.parentNode.removeChild(_el)}if(removeEls.length>0){el.normalize();if(el.firstChild.textContent.trim()=="")el.firstChild.parentNode.removeChild(el.firstChild);if(el.lastChild.textContent.trim()=="")el.lastChild.parentNode.removeChild(el.lastChild);editor.hardReset()}removeEls=[];me.emit("startInvalidateNode");Wrap.invalidateNode(el);me.emit("endInvalidateNode")},0)}function getCleanHtml(){var clone=el.cloneNode(true);var els=clone.querySelectorAll(".gr-alert");for(var i=0;i<els.length;i++){Wrap.unwrap(els[i])}return clone.innerHTML}function getHtml(){return el.innerHTML}function start(){checkingTimer=setTimeout(invalidate,CLEANUP_FREQUENCY);editor.on("paste",function(){me.emit("startInvalidateNode");Wrap.invalidateNode(el);me.emit("endInvalidateNode");invalidate()})}function stop(){clearTimeout(checkingTimer)}};try{module.exports=HtmlDom}catch(e){}var HtmlGhostDom=function(config){var TextareaDom=require("./textarea-dom"),HtmlDom=require("./html-dom"),Util=require("./util"),Wrap=require("wrap"),DOMPurify=require("dompurify"),_=require("lodash"),br=Util.br,editor=config.editor;var htmlDom=HtmlDom({el:config.el,editor:editor});var doc=config.el.ownerDocument;var me=TextareaDom(config);function createBufferEl(pos){var div=doc.createElement("div");div.contentEditable=true;scrollTop=doc.documentElement.scrollTop||doc.body.scrollTop,scrollLeft=doc.documentElement.scrollLeft||doc.body.scrollLeft;Util.css(div,{position:"absolute",opacity:0,height:10,width:100,top:pos.top+scrollTop,left:pos.left+scrollLeft,lineHeight:10,overflow:"hidden"});document.body.appendChild(div);return div}function keepScroll(cb){var scroll=doc.body.scrollTop;cb();doc.body.scrollTop=scroll}function safeFocus(el){keepScroll(el.focus.bind(el))}me.getCursor=function(){return htmlDom.getCursor()};me.setCursor=function(){};me.setTextareaValue=function(value){me.clipboardReplace({value:br(_.escape(value)),rect:me.el.getBoundingClientRect(),selectionFunc:function(){doc.getSelection().selectAllChildren(me.el)}})||htmlDom.setHtml(value)};me.getText=function(){if(!me.el.parentNode)return"";return Wrap.getText(me.el)};me.getMatchSelectionRange=function(match){var startNode=Wrap.getNodeByTextPos(me.el,match._s);endNode=Wrap.getNodeByTextPos(me.el,match._e);return{anchorNode:startNode.node,anchorOffset:match._s-startNode.pos,focusNode:endNode.node,focusOffset:match._e-endNode.pos}};me.getDomRangeFromMatch=function(match){var data=me.getMatchSelectionRange(match);var result=doc.createRange();result.setStart(data.anchorNode,data.anchorOffset);result.setEnd(data.focusNode,data.focusOffset);return result};me.setDomSelection=function(match){var range=me.getDomRangeFromMatch(match);var s=doc.getSelection();s.removeAllRanges();s.addRange(range);return s};me.replace=function(match,value,isUndo){me.doReplace(match,value);match.replaced=!isUndo;match.inDom=!isUndo};me.doReplace=function(match,value){var rect;if(match.getEl()){rect=match.getEl().getBoundingClientRect()}else{var els=me.renderRange(match);rect=els[0].getBoundingClientRect();_.each(els,Wrap.unwrap)}var cursor=match._s+value.length;me.clipboardReplace({value:value,rect:rect,cursor:{s:cursor,e:cursor},selectionFunc:function(){me.setDomSelection(match)}})||me.rangeReplace(match,value)};me.pasteToEl=function(el){safeFocus(el);el.textContent="a";doc.getSelection().selectAllChildren(el);try{var scroll=doc.body.scrollTop;var result=doc.execCommand("paste");
doc.body.scrollTop=scroll;return result}catch(e){return false}};me.copyFromEl=function(el,cb){safeFocus(el);var s=doc.getSelection();s.selectAllChildren(el);doc.execCommand("copy");cb&&cb()};me.clipboardReplace=function(obj){var userBufferEl=createBufferEl(obj.rect),replaceBufferEl=createBufferEl(obj.rect);var removeBuffers=function(){userBufferEl.parentNode.removeChild(userBufferEl);replaceBufferEl.parentNode.removeChild(replaceBufferEl)};if(!me.pasteToEl(userBufferEl))return;me.emit("beforeReplace");replaceBufferEl.innerHTML=DOMPurify.sanitize(obj.value);me.copyFromEl(replaceBufferEl,function(){safeFocus(me.el);obj.selectionFunc();setTimeout(function(){keepScroll(function(){doc.execCommand("paste")});me.copyFromEl(userBufferEl,function(){setTimeout(function(){safeFocus(me.el);me.emit("afterReplace");htmlDom.setCursor(obj.cursor||editor.latestCursor)},10);removeBuffers()})},10)});return true};me.rangeReplace=function(match,value){var s=me.setDomSelection(match);var node=doc.createTextNode(value);var r=s.getRangeAt(0);r.deleteContents();r.insertNode(node)};return me};try{module.exports=HtmlGhostDom}catch(e){}var HtmlTypingLimiter=function(config){var Util=require("./util"),Wrap=require("wrap");var insertedAtPos,inputListener=config.inputListener,el=config.el,document=el.ownerDocument;var hasClass=Util.hasClass,insertBefore=Util.insertBefore,insertAfter=Util.insertAfter;inputListener.on("keypress",onkeypress);inputListener.on("keydown",onkeydown);inputListener.on("input",oninput);function invalidateCurrent(){var sel=document.getSelection();var n=sel.anchorNode;Wrap.invalidateNode(n)}function oninput(){invalidateCurrent()}function onkeypress(event){var sel=document.getSelection();if(sel.toString().length>1)return;var n=sel.anchorNode;Wrap.invalidateNode(n);var e=event.originalEvent;var commandKeyPressed=event.commandKeyPressed,navKey=event.navKey;var cmdKey=e.metaKey||e.ctrlKey;if(cmdKey)return;if(commandKeyPressed)insertedAtPos=null;if(!n||!n.nodeType||n.nodeType!=3)return;if(navKey||commandKeyPressed&&e.keyCode!=13&&e.keyCode!=32)return;insertedAtPos=null;if(!hasClass(n.parentNode,"gr_")||n.textContent.length!=sel.anchorOffset&&sel.anchorOffset!=0)return;if(e.keyCode==13)return fixBr(n.parentNode);var key=String.fromCharCode(e.keyCode);if(!e.shiftKey)key=key.toLowerCase();var tn=document.createTextNode(key);if(tn.textContent==" ")tn.textContent=String.fromCharCode(160);if(sel.anchorOffset==0){insertBefore(tn,n.parentNode)}else{insertAfter(n.parentNode,tn)}insertedAtPos=Wrap.getPosInText(el,tn,1);Wrap.setRange({node:tn,offset:1});e.preventDefault();Wrap.invalidateNode(tn);setTimeout(inputListener.oninput,0)}function fixBr(n){setTimeout(function(){if(!n||!n.parentNode)return;if(n.firstChild&&n.firstChild.tagName=="BR"){insertBefore(n.firstChild,n)}if(n.lastChild&&n.lastChild.tagName=="BR"){insertAfter(n,n.lastChild)}Wrap.invalidateNode(n)},0)}function onkeydown(event){var e=event.originalEvent;var cmdKey=e.metaKey||e.ctrlKey;if(cmdKey&&e.keyCode==90&&insertedAtPos!=null){var cursor=Wrap.getCursorPos(el);var ni=Wrap.getNodeByTextPos(el,insertedAtPos);var text=Wrap.getNodeText(ni);ni.node.textContent=text.substr(0,ni.offset-1)+text.substr(ni.offset);Wrap.invalidateNode(ni.node);insertedAtPos=null;cursor.s--;cursor.e--;Wrap.setCursorPos(el,cursor);e.preventDefault();setTimeout(inputListener.oninput,0)}}};try{module.exports=HtmlTypingLimiter}catch(e){}var InputListener=function(config){var Util=require("./util"),emitter=require("emitter");var el=config.el,editor=config.editor,text=editor.getText(),document=el.ownerDocument;var commandKeyPressed,NOT_ACTIVE_TIME=4e3,checkingTimeout,lastChange=new Date,prevText="",mo;var me=emitter({start:start,stop:stop,oninput:oninput,skipInputEvents:skipInputEvents});var skip=false;var listen=Util.listen,unlisten=Util.unlisten,watch=Util.watch,unwatch=Util.unwatch;return me;function start(){bind();periodicalChecking()}function stop(){unbind();clearTimeout(checkingTimeout)}function skipInputEvents(turnBack){if(turnBack!=undefined)return skip=false;skip=true}function bind(){listen(el,"input",oninput);listen(el,"click",onclick);listen(el,"keyup",onkeyup);listen(el,"keypress",onkeypress);listen(el,"keydown",onkeydown);listen(el,"paste",onpaste);listen(document,"mousedown",mousedown);watch(el,onpaste)}function unbind(){unlisten(el,"input",oninput);unlisten(el,"click",onclick);unlisten(el,"keyup",onkeyup);unlisten(el,"keypress",onkeypress);unlisten(el,"keydown",onkeydown);unlisten(el,"paste",onpaste);unlisten(document,"mousedown",mousedown);unwatch(el,onpaste)}function oninput(e){me.emit("typed",e);if(skip)return;lastChange=new Date;me.emit("input")}function onpaste(){if(me.ignorePaste)return;me.emit("immediatepaste");if(skip)return;setTimeout(function(){check(true);me.emit("paste");me.emit("input")},10)}function check(force){if(skip)return;var newText=editor.getText(),changing=userTyping(),changed=text.trim()!=newText.trim();if(newText==""&&!changed)return;if(changed&&commandKeyPressed){force=true;commandKeyPressed=false}if((!changed||changing)&&!force)return;me.emit("changed");text=newText;prevText=text}function selectionChanged(){me.emit("selectionChanged")}function onclick(e){if(skip)return;if(!window.event||window.event.customWritted){e.customWritted=true;window.event=e}selectionChanged()}function onkeyup(e){if(skip)return;if([37,38,39,40].indexOf(e.keyCode)!=-1){selectionChanged();return}me.emit("keyup")}function isNavKey(keyCode){return[37,38,39,40,17,18,91,8,16,20,9].indexOf(keyCode)!=-1}function isCommandKey(keyCode){return[32,190,188,186,59,57,48,191,49,13,8].indexOf(keyCode)!=-1}function onkeydown(e){if(skip)return;commandKeyPressed=isCommandKey(e.keyCode);me.emit("keydown",{originalEvent:e,commandKeyPressed:commandKeyPressed,listener:me})}function onkeypress(e){if(skip)return;var navKey=isNavKey(e.keyCode);me.emit("keypress",{originalEvent:e,navKey:navKey,commandKeyPressed:commandKeyPressed,listener:me})}function mousedown(){if(skip)return;lastChange=new Date-1e5;check()}function userTyping(){return!(new Date-lastChange>NOT_ACTIVE_TIME)}function periodicalChecking(){checkingTimeout=setTimeout(function(){var t=editor.getText(true);if(t!=prevText){lastChange=new Date;prevText=t;me.emit("input")}check();periodicalChecking()},200)}};try{module.exports=InputListener}catch(e){}var MatchUpdater=function(editor){var emitter=require("emitter"),_=require("lodash"),diffPos=require("textdiff").diffPos;var me=emitter({removeDeprecated:removeDeprecated,remove:remove,removeNotExisting:removeNotExisting,matchRemoved:matchRemoved,extend:extend,extendWithoutAdding:extendWithoutAdding,updatePos:updatePos,locateMatch:locateMatch,tryToAddRemoved:tryToAddRemoved});return me;function removeNotExisting(text,matches){if(!matches)return;var removeArr=[];for(var i=0;i<matches.length;i++){var match=matches[i],matchNotExist;var textValue=text.substring(match.s,match.e);if(match.skipUpdatePos&&textValue)continue;matchNotExist=match.value!=textValue;if(matchNotExist){removeArr.push(i)}}if(removeArr.length>0){removeItems(removeArr,matches,true)}}function matchRemoved(m,text,s,e){if(m.skipUpdatePos)return false;if(_.isUndefined(s)){s=m.s;e=m.e}var matchValue=text.substring(s,e);var value=m.value;if(matchValue!=value){console.log("%c removed '%s' '%s'","color:rgba(239, 110, 105, 0.8)",matchValue,value);m.removed=true;return true}return editor.matchRemoved(m,text,s,e)}function tryToAddRemoved(text,matches,removedMatches){var result=[];for(var id in removedMatches){var match=removedMatches[id];if(match.siblingValue==text.substring(match._s-1,match._e+1)&&!matchRemoved(match,text)){delete removedMatches[id];matches.push(match);result.push(match)}}return result}function locateMatch(m,newText){if(m.siblingValue.length<2)return false;if(m.siblingValue==newText.substring(m._s-1,m._e+1))return true;var diff=10;for(var i=-diff;i<diff;i++){var val=newText.substring(m._s+i-1,m._e+i+1);if(val==m.siblingValue){m._s+=i;m._e+=i;if(!m.replaced){m.s=m._s-m.sd;m.e=m._e-m.ed}return true}}}function updatePos(oldText,newText,matches){var d=diffPos(oldText.trimRight(),newText.trimRight());var removeArr=[];if(d.s==-1)return;var s=d.s;var delta=d.delta;var addArr=[];for(var i=0;i<matches.length;i++){var m=matches[i];var newS=m.s;var newE=m.e;if(newS>=s||delta!=0&&m.s==0&&s==0){newS+=delta;newE+=delta}if(m.value!=newText.substring(newS,newE)||newS<0||m._value!=newText.substring(newS+m.sd,newE+m.ed)||m.removed||matchRemoved(m,newText,newS,newE)){var r=editor.processRemove(m,newText,newS,newE,delta);if(r){if(r.next)continue;if(r.add)addArr=addArr.concat(r.add);if(r.remove){removeArr.push(i);m.removed=true;continue}}if(locateMatch(m,newText)){continue}removeArr.push(i);m.removed=true;continue}if(m.s>=s){if(delta==0&&m.value!=newText.substring(newS,newE)){removeArr.push(i);m.removed=true;continue}m.s=newS;m.e=newE;if(!m.replaced){m._s=m.s+m.sd;m._e=m.e+m.ed}else{m._s=m.s;m._e=m.e}}}if(removeArr.length>0)removeItems(removeArr,matches,true);if(addArr.length>0){for(var i=0;i<addArr.length;i++){matches.push(addArr[i])}}}function matchExist(matches,match){var result=false;if(!matches)return;for(var i=0;i<matches.length;i++){var target=matches[i];if(smartEquals(target,match)){return target}}return result}function smartEquals(o,n){var d=3;var equalPos=o.s-d>=n.s&&o.s+d<=n.e||o.e>=n.s&&o.e<=n.e;return editor.matchesEqual(o,n,equalPos)}function extend(matches,newMatches){newMatches=newMatches.concat();for(var i=0;i<newMatches.length;i++){var match=newMatches[i];var existedMatch=matchExist(matches,match);if(existedMatch){editor.extendMatch(existedMatch,match);console.log("%c SKIP MATCH it already exists","color:rgba(239, 110, 105, 0.8)",match,existedMatch);continue}matches.push(match)}}function extendWithoutAdding(matches,match){var existedMatch=matchExist(matches,match);if(existedMatch){editor.extendMatch(existedMatch,match)}}function removeItems(indexes,matches,doEmit){var removedMatches=[];for(var i=0;i<indexes.length;i++){var index=indexes[i]-i;var removedMatch=matches[index];matches.splice(index,1);removedMatches.push(removedMatch)}for(var i=0;i<removedMatches.length;i++){if(doEmit)me.emit("remove",removedMatches[i])}}function removeDeprecated(matches,newMatch){return;for(var i=0;i<matches.length;i++){var m=matches[i];if(m.s==newMatch.s&&m.e==newMatch.e)return removeItems([i],matches)}}function removeMatches(matchesToRemove,matches){for(var i=0;i<matchesToRemove.length;i++){remove(matchesToRemove[i],matches)}}function remove(m,matches){for(var i=0;i<matches.length;i++){if(matches[i].id==m.id){matches.splice(i,1);i--}}}};try{module.exports=MatchUpdater}catch(e){}var Matches=function(editor){var MatchUpdater=require("./match-updater"),emitter=require("emitter"),_=require("lodash");var matches=[],removedMatches={},matchesBuffer=[],matchesRmBuffer=[],matchUpdater=MatchUpdater(editor);var me=emitter({matchUpdater:matchUpdater,add:add,tryToAdd:tryToAdd,removeDeprecated:removeDeprecated,isIntersected:isIntersected,removeIntersectedWithReplace:removeIntersectedWithReplace,update:update,forceRemove:forceRemove,byId:byId,removeSimilar:removeSimilar,removeByPID:removeByPID,updatePos:updatePos,shift:shift,extend:extend,remove:remove,clear:clear,locateMatch:locateMatch,get:get,matchesBuffer:matchesBuffer,matchesRmBuffer:matchesRmBuffer,getRemoved:getRemoved,addRemoved:addRemoved,replace:replace,rmMatchesBufferCache:rmMatchesBufferCache});matchUpdater.delegate(me,"remove");return me;function get(){if(!matches)matches=[];return matches}function add(m){matches.push(m)}function byId(id){return _.findWhere(matches,{id:id})}function tryToAdd(match,text){match.value=text.substring(match.s,match.e);if(match.skipUpdatePos){match.value=text.substring(match.s,match.e);match._value=text.substring(match._s,match._e);match.v=match.value}if(inReplaced(match)){console.log("match exist",match);return}var _valInText=text.substring(match._s,match._e),valInText=text.substring(match.s,match.e);match.siblingValue=text.substring(match._s-1,match._e+1);if(!match.skipUpdatePos){match.removed=_valInText!=match._value||valInText!=match.v;if(match.removed){console.log("%c match value does not correspondents to the value in a text","color:rgba(239, 110, 105, 0.8)","'"+match.v+"' vs '"+valInText+"'");me.emit("lost_match_value_in_text",match)}}if(match.removed){console.log("%c lost match","color:rgba(239, 110, 105, 0.8)",match);return}extend(match);return true}function addRemoved(match){match.removed=false;match.rendered=false;if(editor.canAddRemovedMatch(match))return;removedMatches[match.id]=match}function getRemoved(){return removedMatches}function removeByPID(match){var pid=match.pid,len=matches.length,similar=[];while(len--){var m=matches[len];if(m.pid!=pid||m.value=="")continue;remove(m);removeDeprecated(m);similar.push(m)}return similar}function removeSimilar(match){var val=match.oldVal,len=matches.length,similar=[];while(len--){var m=matches[len];if(m.oldVal!=val)continue;m.addedToDict=true;remove(m);removeDeprecated(m);similar.push(m)}return similar}function removeDeprecated(match){matchUpdater.removeDeprecated(matches,match)}function forceRemove(match){for(var i=0;i<matches.length;i++){if(matches[i].id==match.id){remove(matches[i])}}rmMatchesBufferCache(match);delete removedMatches[match.id]}function remove(match,withoutEmit){if(!withoutEmit)me.emit("remove",match);matchUpdater.remove(match,matches);rmMatchesBufferCache(match)}function rmMatchesBufferCache(match){if(!match||!match.id){return}var sid=match.id;if(_.isArray(sid)){for(var i=0;i<sid.length;i++){rmMatchesFromBuffer(sid[i])}}else{rmMatchesFromBuffer(sid)}function rmMatchesFromBuffer(sid){rmMatchesBufferCacheBySid(sid);hasAvailableRenderDeletedMatch(match)}function rmMatchesBufferCacheBySid(sid){for(var i=0;i<matchesBuffer.length;i++){if(matchesBuffer[i]&&matchesBuffer[i].id==sid){matchesBuffer[i]=false}}}}function hasAvailableRenderDeletedMatch(match){if(!matchesBuffer.length){return}for(var i=0;i<matchesBuffer.length;i++){if(matchesBuffer[i]&&matchesBuffer[i].pid==match.pid&&matchesBuffer[i].highlightBegin==match.highlightBegin&&matchesBuffer[i].highlightEnd==match.highlightEnd){me.emit("hasAvailableRenderDeletedMatch",{match:matchesBuffer[i],position:i})}}}function update(oldText,newText){updatePos(oldText,newText,matches);matchUpdater.removeNotExisting(newText,matches);newText&&matchUpdater.tryToAddRemoved(newText,matches,removedMatches)}function updatePos(oldText,newText,_matches){matchUpdater.updatePos(oldText,newText,_matches);me.emit("updatePos",{matches:_matches,text:newText})}function extend(match){matchUpdater.extend(matches,[match])}function locateMatch(match,text){return matchUpdater.locateMatch(match,text)}function inReplaced(match){for(var i=0;i<matches.length;i++){var curMatch=matches[i];var equalPos=match.s==curMatch.s&&match.e==curMatch.e;if(!curMatch.r)continue;if(curMatch.ignored&&equalPos)return true}return false}function clear(){matches=[];removedMatches={}}function replace(match,value,isUndo,text){var replVal=value;if(_.isUndefined(replVal))replVal=match.rFirst;text=text.substring(0,match.s)+replVal+text.substring(match.e,text.length);var delta=replVal.length-match.oldVal.length;shift(match,delta,text);match.e=match.s+replVal.length;if(!isUndo){match._s=match.s;match._e=match.e}else{match._s=match.s+match.sd;match._e=match.e+match.ed}match.undoed=false;match.replaced=!isUndo;match.beforeReplace=match.v;match.oldVal=replVal;match.value=replVal;match._value=text.substring(match._s,match._e)}function shift(m,delta,text){for(var i=0;i<matches.length;i++){var target=matches[i];if(m==target)continue;if(m.e<target.s){target.s+=delta;target.e+=delta;target._s+=delta;target._e+=delta}if(m.s>=target.s&&m.e<=target.e&&editor.canShiftMatchEnd(m)){target.e+=delta;target._e+=delta;target.value=text.substring(target.s,target.e);target._value=text.substring(target._s,target._e);target.oldVal=target.value}else if(m.s>=target.s&&m.e>target.e){target.value=text.substring(target.s,target.e);target._value=text.substring(target._s,target._e);target.oldVal=target.value}}}function removeIntersectedWithReplace(m){var result=false;for(var i=0;i<matches.length;i++){var existed=matches[i];if(existed.value.split(" ").length>1||m==existed)continue;var toRemove=isIntersected(m,existed);if(toRemove){remove(toRemove);result=true}}return result}function isIntersected(m,existed){if(m.s<=existed.s&&m.e>=existed.s||m.s>=existed.s&&m.e<=existed.e||m.s<=existed.e&&m.e>=existed.e){return existed}return false}};try{module.exports=Matches}catch(e){}var TextSplit=function(config){var emitter=require("emitter"),Changesets=require("changesets"),_=require("lodash"),Util=require("./util");var node=config.node,ch=Changesets,oldVal="",blocks=[],startBlockLen=config.blockSize||1e3,maxBlockLen=config.maxBlockSize||2e3;var br=Util.br;var me=emitter({update:updateShadow});return me;function escapeHtmlChar(match){return htmlEscapes[match]}function updateShadow(val,matches,wrap){var diff=ch.diff(oldVal,val),i,k,b,b2,applied,oldText,oldPos;if(!blocks.length){b=createBlock(0,"");node.appendChild(b.el);blocks.push(b)}diff=diff.sequencify();applied=ch.cs([]);for(k=0;k<blocks.length;k++){b=blocks[k];oldText=b.text;oldPos=b.pos;for(i=0;i<applied.length;i++){b.pos=b.transformAgainst(applied[i]).pos}applied.push(applyToBlock(b,diff));if(!b.len){blocks.splice(k,1);node.removeChild(b.el);k--;continue}if(b.text!==oldText){b.textUp=true}if(b.text!==oldText||b.pos!=oldPos){b.posUp=true}while(b.len>maxBlockLen){b2=createBlock(b.pos+startBlockLen,b.text.substr(startBlockLen));b.text=b.text.substr(0,startBlockLen);b.len=b.text.length;insertAfter(b.el,b2.el);blocks.splice(k+1,0,b2);k++;b=b2}}var j,m,m2,col,newMatches=[];for(k=0;k<blocks.length;k++){b=blocks[k];newMatches=[];for(i=0;i<matches.length;i++){m=matches[i];col=Math.min(b.pos+b.len,m.e)-Math.max(b.pos,m.s);if(col<0)continue;m2=_.extend({},m);m2.orig=m;m2.s=Math.max(0,m.s-b.pos);m2.value=m2.value.substr(Math.max(0,b.pos-m.s),col);m2.e=m2.s+m2.value.length;m2._s=m2.s;m2._e=m2.e;if(!m.replaced){m2._s=m2.s+m.sd;m2._e=m2.e+m.ed}if(m2._s<0||m2._e<0)continue;newMatches.push(m2)}b.matchesUp=true;if(!b.matches.length&&!newMatches.length){b.matchesUp=false}else if(b.matches.length==newMatches.length){b.matchesUp=false;for(j=0;j<b.matches.length;j++){var equal=b.matches[j].orig===newMatches[j].orig&&b.matches[j]._s==newMatches[j]._s&&b.matches[j]._e==newMatches[j]._e;if(equal)continue;b.matchesUp=true;break}}else{b.matchesUp=true}if(b.matchesUp){b.matches=newMatches}}for(k=0;k<blocks.length;k++){b=blocks[k];if(b.textUp||b.matchesUp){var matchedText=b.text;if(b.matches.length){matchedText=wrap(b.text,b.matches)}else{matchedText=_.escape(matchedText)}b.el.innerHTML=br(matchedText,k==blocks.length-1);b.textUp=false}if(b.posUp){b.el.setAttribute("p",[b.pos,b.pos+b.len].join(","));b.posUp=false}}me.emit("finish");oldVal=val}function applyToBlock(b,diff){var applied=ch.cs([]),i,c,c2,delOps=[];for(i=0;i<diff.length;i++){c=diff[i];if(c.type=="="||!c.len)continue;if(c.pos<b.pos||c.pos>b.pos+b.len){continue}c2=c.extend({tlen:b.len,pos:c.pos-b.pos});if(c.type=="+"){applied.push(c);delOps.forEach(function(op){op.pos+=c.len})}if(c.type=="-"){c2.text=c2.text.substr(0,b.pos+b.len-c.pos);c2.len=c2.text.length;c.text=c.text.substr(c2.len);c.len=c.text.length;applied.push(c2);delOps.push(c)}b.text=c2.apply(b.text);b.len=b.text.length}return applied}function createBlock(start,text){var block=ch.op({type:"+",tlen:0,pos:start,text:text,accessory:0});block.el=document.createElement("gr_block");block.el.style.display="inline";block.textUp=true;block.posUp=true;block.matchesUp=false;block.matches=[];return block}function insertAfter(after,el){var parent=after.parentNode;if(after.nextSibling)parent.insertBefore(el,after.nextSibling);else parent.appendChild(el)}};try{module.exports=TextSplit}catch(e){}var TextareaDom=function(config){var emitter=require("emitter"),_=require("lodash"),Util=require("./util"),HtmlDom=require("./html-dom"),TextSplit=require("./text-split"),Wrap=require("wrap");var editor=config.editor,el=editor.el,id=Util.guid(),htmlDom,clone,cloneVal,lazyUpdateShadow;var insertBefore=Util.insertBefore,createEl=Util.createEl,isFocused=Util.isFocused;var _f=function(){};var split;var template="<div class='gram-ghost' gramm_editor contenteditable tabindex='-1'><span class='clone-val'></span></div>";var me=emitter({el:el,id:id,render:render,remove:remove,renderRange:renderRange,removeBySelector:removeBySelector,replace:replace,start:start,stop:stop,select:select,deselect:deselect,getText:getText,setText:setText,setTextareaValue:setTextareaValue,changeSelection:changeSelection,getCursor:getCursor,setCursor:setCursor,insertGhost:insertGhost,forceRedraw:forceRedraw,invalidate:_f});var lazySelectMatch=_.debounce(selectMatch,100);setTimeout(forceRedraw,10);return me;function forceRedraw(){var pos=editor.getCursor();var v=el.value;el.value=v+" ";el.value=v;isFocused(el)&&editor.setCursor(pos)}function insertGhost(){var clone=createEl(template,document);var cloneVal=clone.firstChild;clone.id=id;clone.setAttribute("gramm_id",id);insertBefore(clone,el);return{clone:clone,cloneVal:cloneVal}}function createClone(){var gh=me.insertGhost();clone=gh.clone;cloneVal=gh.cloneVal;htmlDom=HtmlDom({el:cloneVal,editor:editor}),split=TextSplit({node:cloneVal});split.on("finish",function(){me.emit("rendered")});me.htmlDom=htmlDom;lazyUpdateShadow=_.throttle(updateShadow,100);me.clone=clone;me.cloneVal=cloneVal;editor.emit("createdGhost")}function updateShadow(val,matches,text){try{split.update(val,matches,text)}catch(e){console.error(e.stack||e)}}function render(matches,text,isFast){for(var i=0;i<matches.length;i++){var m=matches[i];if(m.replaced){m._s=m.s;m._e=m.e}}_render(matches,text,isFast)}function createTag(m,text){var parent=m.parent||m,cls=editor.getMatchClass(parent,text);return{start:"<g class='gr_ gr_"+parent.id+cls+"' data-gr-id='"+parent.id+"' id='"+parent.id+"'>",end:"</g>"}}function _render(matches,text,isFast){Wrap.render({node:el,matches:matches,createTag:createTag,type:"text",text:text,updateMethod:isFast?updateShadow:lazyUpdateShadow})}function getText(){return el.value}function setTextareaValue(val){el.value=val}function setText(val){me.setTextareaValue(val);render(editor.getFiltered(),val,true)}function changeSelection(){var sel=document.getSelection(),selValue=sel.toString();if(selValue.length>1)return;lazySelectMatch()}function selectMatch(){var sel=el.selectionStart;var _matches=editor.getFiltered();var matches=_matches.concat();var selected=false;matches.sort(function(a,b){return b._e-a._e});var inRange=[];for(var i=0;i<matches.length;i++){var m=matches[i];var inMatch=sel>=m._s&&sel<=m._e;if(inMatch){inRange.push(m)}}if(inRange.length>0){inRange.sort(function(a,b){return a._e-a._s-(b._e-b._s)});selected=true;var m=inRange[0];if(editor.selectedMatch&&editor.selectedMatch!=m)editor.selectedMatch.deselect();return editor.selectById(m.id)}if(!selected&&editor.selectedMatch){editor.selectedMatch.deselect()}if(!selected){editor.emit("deselectMatch")}}function setCursor(pos){el.selectionStart=pos.s;el.selectionEnd=pos.e}function getCursor(){return{s:el.selectionStart,e:el.selectionEnd}}function renderRange(match){return htmlDom.renderRange(match)}function getSel(match){return".gr_"+match.id}function removeBySelector(sel){var els=el.querySelectorAll(sel),len=els.length;for(var i=0;i<len;i++){Wrap.unwrap(els[i])}}function remove(match,withText){var matches=editor.getFiltered();render(matches,editor.currentText,true)}function replace(match,value){var text=el.value;text=text.substring(0,match.s)+value+text.substr(match.e);editor.currentText=text;setText(text)}function select(match){htmlDom.select(match)}function deselect(match){htmlDom.deselect(match)}function getCleanHtml(){}function start(){createClone()}function stop(){}};try{module.exports=TextareaDom}catch(e){}(function(factory){"use strict";var root=typeof window==="undefined"?null:window;if(typeof define==="function"&&define.amd){define(function(){return factory(root)})}else if(typeof module!=="undefined"){module.exports=factory(root)}else{root.DOMPurify=factory(root)}})(function factory(window){"use strict";var DOMPurify=function(window){return factory(window)};DOMPurify.version="0.6.5";if(!window||!window.document||window.document.nodeType!==9){DOMPurify.isSupported=false;return DOMPurify}var document=window.document;var originalDocument=document;var DocumentFragment=window.DocumentFragment;var HTMLTemplateElement=window.HTMLTemplateElement;var NodeFilter=window.NodeFilter;var NamedNodeMap=window.NamedNodeMap||window.MozNamedAttrMap;var Text=window.Text;var Comment=window.Comment;if(typeof HTMLTemplateElement==="function"){document=document.createElement("template").content.ownerDocument}var implementation=document.implementation;var createNodeIterator=document.createNodeIterator;var getElementsByTagName=document.getElementsByTagName;var createDocumentFragment=document.createDocumentFragment;var importNode=originalDocument.importNode;var hooks={};DOMPurify.isSupported=typeof implementation.createHTMLDocument!=="undefined"&&document.documentMode!==9;var _addToSet=function(set,array){var l=array.length;while(l--){set[array[l]]=true}return set};var _cloneObj=function(object){var newObject={};var property;for(property in object){if(object.hasOwnProperty(property)){newObject[property]=object[property]}}return newObject};var ALLOWED_TAGS=null;var DEFAULT_ALLOWED_TAGS=_addToSet({},["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr","svg","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","switch","symbol","text","textpath","title","tref","tspan","view","vkern","math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmuliscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mpspace","msqrt","mystyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","#text"]);var ALLOWED_ATTR=null;var DEFAULT_ALLOWED_ATTR=_addToSet({},["accept","action","align","alt","autocomplete","background","bgcolor","border","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","coords","datetime","default","dir","disabled","download","enctype","face","for","headers","height","hidden","high","href","hreflang","id","ismap","label","lang","list","loop","low","max","maxlength","media","method","min","multiple","name","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","rows","rowspan","spellcheck","scope","selected","shape","size","span","srclang","start","src","step","style","summary","tabindex","title","type","usemap","valign","value","width","xmlns","accent-height","accumulate","additivive","alignment-baseline","ascent","azimuth","baseline-shift","bias","clip","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dy","dy","direction","display","divisor","dur","elevation","end","fill","fill-opacity","fill-rule","filter","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","image-rendering","in","in2","k1","k2","k3","k4","kerning","letter-spacing","lighting-color","local","marker-end","marker-mid","marker-start","max","mask","mode","min","offset","operator","opacity","order","overflow","paint-order","path","points","r","rx","ry","radius","restart","scale","seed","shape-rendering","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","transform","text-anchor","text-decoration","text-rendering","u1","u2","viewbox","visibility","word-spacing","wrap","writing-mode","x","x1","x2","y","y1","y2","z","accent","accentunder","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","display","displaystyle","fence","frame","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","xlink:href","xml:id","xlink:title","xml:space"]);var FORBID_TAGS=null;var FORBID_ATTR=null;var ALLOW_DATA_ATTR=true;var SAFE_FOR_JQUERY=false;var WHOLE_DOCUMENT=false;var RETURN_DOM=false;var RETURN_DOM_FRAGMENT=false;var RETURN_DOM_IMPORT=false;var SANITIZE_DOM=true;var KEEP_CONTENT=true;var FORBID_CONTENTS=_addToSet({},["audio","head","math","script","style","svg","video"]);var CONFIG=null;var formElement=document.createElement("form");var _parseConfig=function(cfg){if(typeof cfg!=="object"){cfg={}}ALLOWED_TAGS="ALLOWED_TAGS"in cfg?_addToSet({},cfg.ALLOWED_TAGS):DEFAULT_ALLOWED_TAGS;ALLOWED_ATTR="ALLOWED_ATTR"in cfg?_addToSet({},cfg.ALLOWED_ATTR):DEFAULT_ALLOWED_ATTR;FORBID_TAGS="FORBID_TAGS"in cfg?_addToSet({},cfg.FORBID_TAGS):{};FORBID_ATTR="FORBID_ATTR"in cfg?_addToSet({},cfg.FORBID_ATTR):{};ALLOW_DATA_ATTR=cfg.ALLOW_DATA_ATTR!==false;SAFE_FOR_JQUERY=cfg.SAFE_FOR_JQUERY||false;WHOLE_DOCUMENT=cfg.WHOLE_DOCUMENT||false;RETURN_DOM=cfg.RETURN_DOM||false;RETURN_DOM_FRAGMENT=cfg.RETURN_DOM_FRAGMENT||false;RETURN_DOM_IMPORT=cfg.RETURN_DOM_IMPORT||false;SANITIZE_DOM=cfg.SANITIZE_DOM!==false;KEEP_CONTENT=cfg.KEEP_CONTENT!==false;if(RETURN_DOM_FRAGMENT){RETURN_DOM=true}if(cfg.ADD_TAGS){if(ALLOWED_TAGS===DEFAULT_ALLOWED_TAGS){ALLOWED_TAGS=_cloneObj(ALLOWED_TAGS)}_addToSet(ALLOWED_TAGS,cfg.ADD_TAGS)}if(cfg.ADD_ATTR){if(ALLOWED_ATTR===DEFAULT_ALLOWED_ATTR){ALLOWED_ATTR=_cloneObj(ALLOWED_ATTR)}_addToSet(ALLOWED_ATTR,cfg.ADD_ATTR)}if(KEEP_CONTENT){ALLOWED_TAGS["#text"]=true}if(Object&&"freeze"in Object){Object.freeze(cfg)}CONFIG=cfg};var _forceRemove=function(node){try{node.parentNode.removeChild(node)}catch(e){node.outerHTML=""}};var _initDocument=function(dirty){var doc=implementation.createHTMLDocument("");var body=doc.body;body.parentNode.removeChild(body.parentNode.firstElementChild);body.outerHTML=dirty;return getElementsByTagName.call(doc,WHOLE_DOCUMENT?"html":"body")[0]};var _createIterator=function(root){return createNodeIterator.call(root.ownerDocument||root,root,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT|NodeFilter.SHOW_TEXT,function(){return NodeFilter.FILTER_ACCEPT},false)};var _isClobbered=function(elm){if(elm instanceof Text||elm instanceof Comment){return false}if(typeof elm.nodeName!=="string"||typeof elm.textContent!=="string"||typeof elm.removeChild!=="function"||!(elm.attributes instanceof NamedNodeMap)||typeof elm.removeAttribute!=="function"||typeof elm.setAttribute!=="function"){return true}return false};var _sanitizeElements=function(currentNode){_executeHook("beforeSanitizeElements",currentNode,null);
if(_isClobbered(currentNode)){_forceRemove(currentNode);return true}var tagName=currentNode.nodeName.toLowerCase();_executeHook("uponSanitizeElement",currentNode,{tagName:tagName});if(!ALLOWED_TAGS[tagName]||FORBID_TAGS[tagName]){if(KEEP_CONTENT&&!FORBID_CONTENTS[tagName]&&typeof currentNode.insertAdjacentHTML==="function"){try{currentNode.insertAdjacentHTML("AfterEnd",currentNode.innerHTML)}catch(e){}}_forceRemove(currentNode);return true}if(SAFE_FOR_JQUERY&&!currentNode.firstElementChild){currentNode.innerHTML=currentNode.textContent.replace(/</g,"&lt;")}_executeHook("afterSanitizeElements",currentNode,null);return false};var _sanitizeAttributes=function(currentNode){_executeHook("beforeSanitizeAttributes",currentNode,null);var attributes=currentNode.attributes;if(!attributes){return}var hookEvent={attrName:"",attrValue:"",keepAttr:true},l=attributes.length,attr,name,value,lcName,idAttr;while(l--){attr=attributes[l];name=attr.name;value=attr.value;lcName=name.toLowerCase();hookEvent.attrName=lcName;hookEvent.attrValue=value;hookEvent.keepAttr=true;_executeHook("uponSanitizeAttribute",currentNode,hookEvent);value=hookEvent.attrValue;if(lcName==="name"&&currentNode.nodeName==="IMG"&&attributes.id){idAttr=attributes.id;attributes=Array.prototype.slice.apply(attributes);currentNode.removeAttribute("id");currentNode.removeAttribute(name);if(attributes.indexOf(idAttr)>l){currentNode.setAttribute("id",idAttr.value)}}else{currentNode.removeAttribute(name)}if(!hookEvent.keepAttr){continue}if(SANITIZE_DOM&&(lcName==="id"||lcName==="name")&&(value in window||value in document||value in formElement)){continue}if((ALLOWED_ATTR[lcName]&&!FORBID_ATTR[lcName]||ALLOW_DATA_ATTR&&DATA_ATTR.test(lcName))&&(!IS_SCRIPT_OR_DATA.test(value.replace(ATTR_WHITESPACE,""))||lcName==="src"&&value.indexOf("data:")===0&&currentNode.nodeName==="IMG")){try{currentNode.setAttribute(name,value)}catch(e){}}}_executeHook("afterSanitizeAttributes",currentNode,null)};var DATA_ATTR=/^data-[\w.\u00B7-\uFFFF-]/;var IS_SCRIPT_OR_DATA=/^(?:\w+script|data):/i;var ATTR_WHITESPACE=/[\x00-\x20\xA0\u1680\u180E\u2000-\u2029\u205f\u3000]/g;var _sanitizeShadowDOM=function(fragment){var shadowNode;var shadowIterator=_createIterator(fragment);_executeHook("beforeSanitizeShadowDOM",fragment,null);while(shadowNode=shadowIterator.nextNode()){_executeHook("uponSanitizeShadowNode",shadowNode,null);if(_sanitizeElements(shadowNode)){continue}if(shadowNode.content instanceof DocumentFragment){_sanitizeShadowDOM(shadowNode.content)}_sanitizeAttributes(shadowNode)}_executeHook("afterSanitizeShadowDOM",fragment,null)};var _executeHook=function(entryPoint,currentNode,data){if(!hooks[entryPoint]){return}hooks[entryPoint].forEach(function(hook){hook.call(DOMPurify,currentNode,data,CONFIG)})};DOMPurify.sanitize=function(dirty,cfg){if(!DOMPurify.isSupported){if(typeof window.toStaticHTML==="function"&&typeof dirty==="string"){return window.toStaticHTML(dirty)}return dirty}_parseConfig(cfg);if(!RETURN_DOM&&!WHOLE_DOCUMENT&&dirty.indexOf("<")===-1){return dirty}var body=_initDocument(dirty);if(!body){return RETURN_DOM?null:""}var currentNode;var nodeIterator=_createIterator(body);while(currentNode=nodeIterator.nextNode()){if(_sanitizeElements(currentNode)){continue}if(currentNode.content instanceof DocumentFragment){_sanitizeShadowDOM(currentNode.content)}_sanitizeAttributes(currentNode)}var returnNode;if(RETURN_DOM){if(RETURN_DOM_FRAGMENT){returnNode=createDocumentFragment.call(body.ownerDocument);while(body.firstChild){returnNode.appendChild(body.firstChild)}}else{returnNode=body}if(RETURN_DOM_IMPORT){returnNode=importNode.call(originalDocument,returnNode,true)}return returnNode}return WHOLE_DOCUMENT?body.outerHTML:body.innerHTML};DOMPurify.addHook=function(entryPoint,hookFunction){if(typeof hookFunction!=="function"){return}hooks[entryPoint]=hooks[entryPoint]||[];hooks[entryPoint].push(hookFunction)};DOMPurify.removeHook=function(entryPoint){if(hooks[entryPoint]){hooks[entryPoint].pop()}};DOMPurify.removeHooks=function(entryPoint){if(hooks[entryPoint]){hooks[entryPoint]=[]}};DOMPurify.removeAllHooks=function(){hooks=[]};return DOMPurify});var Under={};var _=require("lodash"),emitter=require("emitter");Under.Util=require("./util");Under.HtmlDom=require("./html-dom");Under.HtmlGhostDom=require("./html-ghost-dom");Under.HtmlTypingLimiter=require("./html-typing-limiter");Under.InputListener=require("./input-listener");Under.Matches=require("./matches");Under.MatchUpdater=require("./match-updater");Under.TextareaDom=require("./textarea-dom");Under.TextSplit=require("./text-split");Under.Editor=function(config){var _f=function(){};var el=_.isString(config.el)?document.querySelector(config.el):config.el;var document=el.ownerDocument;var api=config.api;var useBufferForAddingMatches=true;var waitTime=500;if(!_.isUndefined(config.useBufferForAddingMatches))useBufferForAddingMatches=config.useBufferForAddingMatches;var me=emitter({el:el,getText:function(force){return force?getText():getCachedText()},setText:setText,setCursor:setCursor,getCursor:getCursor,saveCursor:saveCursor,restoreCursor:restoreCursor,addMethodsToMatch:addMethodsToMatch,addMatches:addMatches,tryToAdd:tryToAdd,render:render,check:check,getMatches:getMatches,getFiltered:getFiltered,getSelection:getSelection,close:close,clearData:clearData,hardReset:hardReset,latestCursor:{s:0,e:0},exit:exit,waitTime:waitTime,matchFilter:function(arr){return arr},processMatch:processMatch,beforeReplace:_f,getMatchClass:function(){return""},processRemove:_f,matchRemoved:_f,extendMatch:_f,matchesEqual:function(){return false},canAddRemovedMatch:function(){return true},canShiftMatchEnd:function(){return true},selectById:selectById,skipInputEvents:skipInputEvents,run:run,api:api,_removedByServer:[]});var listen=Under.Util.listen,unlisten=Under.Util.unlisten,onTypedState=false,checkingTimeout,inputLimiter=true;var matches=Under.Matches(me);var matchesBuffer=matches.matchesBuffer;me.matches=matches;var isTextarea=config.editorType=="textarea";me.isTextarea=isTextarea;config.editor=me;if(config.editorType=="contenteditable"){var dom=Under.HtmlDom(config)}if(isTextarea){var dom=Under.TextareaDom({editor:me})}me.isHtmlGhost=config.editorType=="htmlghost";if(me.isHtmlGhost){var dom=Under.HtmlGhostDom(config);dom.on("beforeReplace",function(){me.inputListener.ignorePaste=true});dom.on("afterReplace",function(){me.inputListener.ignorePaste=false})}var lazyRender=_.debounce(render,1e3);me.dom=dom;me.currentText=getText()||"";matches.on("remove",removeMatch);matches.on("hasAvailableRenderDeletedMatch",hasAvailableRenderDeletedMatch);var inputListener=Under.InputListener({el:el,editor:me});me.inputListener=inputListener;if(config.editorType=="contenteditable"){Under.HtmlTypingLimiter({inputListener:me.inputListener,el:el});me.setHtml=function(html){dom.setHtml(html);afterReplaceText()};me.getHtml=dom.getHtml}inputListener.on("changed",onchange);inputListener.on("input",oninput);inputListener.on("keypress",ontyped);inputListener.on("selectionChanged",onSelectionChanged);listen(el,"click",saveCursor);inputListener.delegate(me,"keydown");inputListener.delegate(me,"paste");inputListener.delegate(me,"immediatepaste");api.delegate(me,"sending");api.delegate(me,"finish");api.on("add",onadd);api.on("start",onstart);dom.delegate(me,"rendered");dom.delegate(me,"startInvalidateNode");dom.delegate(me,"endInvalidateNode");if(config.autorun)run();return me;function run(){inputListener.start();dom.start();if(config.value){setText(config.value)}api.update(me.currentText);check()}function getText(invalidateNode){return dom.getText(invalidateNode)}function getCachedText(){return me.currentText}function afterReplaceText(){me.currentText=getText(true);me.emit("afterReplace")}function setText(val){matches.get().forEach(function(m){m.inDom=false});matches.update(me.currentText,val);dom.setText(val);if(me.isHtmlGhost){setTimeout(afterReplaceText,100)}else{afterReplaceText()}}function setCursor(pos){return dom.setCursor(pos)}function getCursor(){return dom.getCursor()}function saveCursor(){me.latestCursor=getCursor(el)}function restoreCursor(){setCursor(me.latestCursor)}function skipInputEvents(turnBack){inputListener.skipInputEvents(turnBack)}function check(){api.send()}function ontyped(e){onTypedState=Date.now();if(e.originalEvent.charCode==32){if(inputLimiter){paintSingleMatch()}}}function onchange(e){console.log("TEXT to send",getText(),e);check();me.emit("change",e)}function updateText(){var text=getText();var beforeUpdateResult={text:text};me.emit("beforeUpdate",beforeUpdateResult);if(beforeUpdateResult.cancel)return updateText();api.update(text);matches.update(me.currentText,text);me.currentText=text}function oninput(e){updateText();render();saveCursor();me.emit("input",e)}function onSelectionChanged(){dom.changeSelection()}function selectById(id){var m=me.matches.byId(id);if(m&&me.selectedMatch&&me.selectedMatch!=m)me.selectedMatch.deselect();m&&m.select()}function render(){var shouldBeRendered=getFiltered();dom.render(shouldBeRendered,me.currentText);me.emit("saveDoc",me.currentText)}function onstart(msg){me.sid=msg.sid;me.emit("saveSid",me.sid)}function processMatch(m){m._s=m._s||m.s;m._e=m._e||m.e;m.sd=m._s-m.s;m.ed=m._e-m.e}function onadd(match){if(useBufferForAddingMatches){matchesBuffer.push(match);if(!checkingTimeout){onAddWorker()}}else{onAddFunc(match)}me.emit("tracking",{event:"matchFound",matches:match})}function onAddWorker(){checkingTimeout=setTimeout(function(){if(matchesBuffer.length&&Date.now()-onTypedState>waitTime){paintSingleMatch()}if(matchesBuffer.length){onAddWorker()}else{checkingTimeout=false}},50)}function paintSingleMatch(){if(matchesBuffer.length){var match=matchesBuffer.shift();if(match){onAddFunc(match)}else{paintSingleMatch()}}}function onAddFunc(match,force){var text=getText();me.currentText=text;if(me._removedByServer.indexOf(match.id)>-1)return;if(me.processMatch(match,text)!=undefined)return;var added=me.tryToAdd(match,text);if(!added)return;addMethodsToMatch(match);if(!force){lazyRender()}else{render()}}function hasAvailableRenderDeletedMatch(data){if(!data||!matchesBuffer.length){return}var match=data.match,position=data.position;if(matchesBuffer[position]&&(matchesBuffer[position].id=match.id)){matchesBuffer[position]=false;onAddFunc(match,true)}}function tryToAdd(match,newText,oldText){return matches.tryToAdd(match,newText,oldText)}function addMatches(data){if(!data||data.length==0)return;var text=getText();for(var i=0;i<data.length;i++){var m=data[i];if(m.v!=text.substring(m.s,m.e))continue;m.rendered=false;addMethodsToMatch(m);matches.add(m)}dom.invalidate(true);render()}function getMatches(){return matches.get()}function getFiltered(){return me.matchFilter(getMatches())}function addMethodsToMatch(match){var id=Under.Util.guid(),ts=Date.now();_.extend(match,{uid:id,ts:ts,replace:replace.bind(match),undo:undo.bind(match),addToDict:addToDict.bind(match),ignore:ignore.bind(match),ignoreAll:ignoreAll.bind(match),remove:removeMatch.bind(match),getEl:getEl.bind(match),select:selectMatch.bind(match),deselect:deselectMatch.bind(match)});me.emit("matchExtend",match)}function replace(value,isUndo,match){match=match||this;me.emit("beforeReplace");var text=getText();var offset=value.length-match.oldVal.length;if(me.latestCursor.s<match.s)offset=0;me.beforeReplace(match,offset,value);dom.remove(match);dom.replace(match,value,isUndo);matches.replace(match,value,isUndo,text,true);feedback(match,isUndo?"undoed":"accepted");render();setCursor({s:match._e,e:match._e});me.currentText=getText();updateText();check();me.emit("afterReplace",match);if(isUndo)return;me.emit("fix",match);me.emit("tracking",{event:"matchAcceptedCard",matches:match})}function undo(match){match=match||this;var value=match.v;match.replace(value,true);match.undoed=true;match.beforeReplace=value;var isRender=matches.removeIntersectedWithReplace(match);if(isRender)render();me.emit("undo");me.emit("tracking",{event:"matchUndo",matches:match})}function addToDict(match){match=match||this;matches.forceRemove(match);api.addToDictionary(match);var similar=matches.removeSimilar(match);similar.push(match);render();me.emit("fix");me.emit("tracking",{event:"matchAddToDict",matches:similar})}function ignore(match){match=match||this;matches.forceRemove(match);api.ignore(match);matches.removeByPID(match);render();me.emit("fix");me.emit("tracking",{event:"matchIgnored",matches:match})}function ignoreAll(match){match=match||this;matches.forceRemove(match);matches.removeSimilar(match);api.ignoreAll(match);var similar=matches.removeSimilar(match);similar.push(match);me.emit("tracking",{event:"matchIgnoredAll",matches:similar});render()}function removeMatch(match){match=match||this;matches.removeDeprecated(match);matches.remove(match,true);dom.remove(match);me.emit("rendered")}function getSelection(){var pos=getCursor(),text=getText();return{value:text.substring(pos.s,pos.e),s:pos.s,e:pos.e,text:text}}function getEl(match){match=match||this;return document.getElementById(match.id)}function selectMatch(noEvent,match){match=match||this;if(match.selected)return;match.selected=true;if(!noEvent){me.emit("selectedMatch",match);feedback(match,"looked")}dom.select(match);me.selectedMatch=match}function deselectMatch(noEvent,match){match=match||this;if(!match.selected)return;match.selected=false;if(!noEvent)me.emit("deselectedMatch",match);dom.deselect(match);me.selectedMatch=null}function feedback(match,type){console.log("FEEDBACK",match.value,type);api.feedback(match,type)}function hardReset(){api.reset();clearData();updateText();check();me.emit("rendered")}function clearData(){matches.clear();render()}function exit(){inputListener.stop();dom.stop();unlisten(el,"click",saveCursor);me.emit("exit")}};try{module.exports=Under}catch(e){}if(typeof module!="undefined")module.exports=require("./lib/editor");var textdiff=require("textdiff").textdiff;var _=require("lodash");var Changesets={op:function(op){op=_.clone(op);op.len=op.text?op.text.length:0;op.toString=function(){return this.type+this.pos+":"+this.text};op.extend=function(mod){op=_.extend(_.clone(this),mod);op.len=op.text.length;return op};op.revision=function(rev){return _.extend(_.clone(this),{accessory:rev})};op.apply=function(text,selection){if(this.type=="+"){if(text.length!=this.tlen)throw new Error("Text length doesn't match expected length. It's most likely you have missed a transformation: expected:"+this.tlen+", actual:"+text.length);if(selection){if(this.pos<selection.b)selection.b+=this.text.length;if(this.pos<selection.e)selection.e+=this.text.length}return text.slice(0,this.pos)+this.text+text.slice(this.pos)}else if(this.type=="-"){if(text.length!=this.tlen)throw new Error("Text length doesn't match expected length. It's most likely you have missed a transformation: expected:"+this.tlen+", actual:"+text.length);if(text.substr(this.pos,this.len)!=this.text)throw new Error("Applying delete operation: Passed context doesn't match assumed context: "+JSON.stringify(op)+', actual context: "'+text.substr(this.pos,this.len)+'"');if(selection){if(this.pos<selection.b)selection.b-=Math.min(this.text.length,selection.b-this.pos);if(this.pos<selection.e)selection.e-=Math.min(this.text.length,selection.e-this.pos)}return text.slice(0,this.pos)+text.slice(this.pos+this.len)}else if(this.type=="="){return text}};op.transformAgainst=function(b){if(this.type=="+"&&b.type=="+"){var tlen=this.tlen+b.len;if(this.pos<b.pos){return this.extend({tlen:tlen})}if(this.pos==b.pos&&this.accessory<b.accessory){return this.extend({tlen:tlen})}if(b.pos<=this.pos){return this.extend({tlen:tlen,pos:this.pos+b.len})}}else if(this.type=="+"&&b.type=="-"){var tlen=this.tlen-b.len;if(this.pos<b.pos){return this.extend({tlen:tlen})}if(this.pos==b.pos){return this.extend({tlen:tlen})}if(b.pos<this.pos){return this.extend({tlen:tlen,pos:Math.max(this.pos-b.len,b.pos)})}}else if(this.type=="-"&&b.type=="-"){var tlen=this.tlen-b.len;if(this.pos<b.pos){var startOfOther=Math.min(b.pos-this.pos,this.len);return this.extend({tlen:tlen,text:this.text.substr(0,startOfOther)+this.text.substr(startOfOther+b.len)})}if(this.pos==b.pos){if(this.len<=b.len)return Changesets.op({type:"="});return this.extend({tlen:tlen,text:this.text.substr(b.len)})}if(b.pos<this.pos){var overlap=b.pos+b.len-this.pos;if(overlap>=this.len)return Changesets.op({type:"="});if(overlap>0)return this.extend({tlen:tlen,pos:b.pos,text:this.text.substr(overlap)});return this.extend({tlen:tlen,pos:this.pos-b.len})}}else if(this.type=="-"&&b.type=="+"){var tlen=this.tlen+b.len;if(this.pos<b.pos){if(this.pos+this.len>b.pos){var firstHalfLength=b.pos-this.pos;return[this.extend({tlen:tlen,text:this.text.substr(0,firstHalfLength)}),this.extend({tlen:tlen,pos:b.pos+b.len,text:this.text.substr(firstHalfLength)})]}return this.extend({tlen:tlen})}if(this.pos==b.pos){return this.extend({tlen:tlen,pos:this.pos+b.len})}if(b.pos<this.pos){return this.extend({tlen:tlen,pos:this.pos+b.len})}}return this};return op},cs:function(cs){cs=_.clone(cs.map(function(op){return _.clone(op)}));cs.toString=function(){return this.map(function(op){return op.toString()}).join(" ")};cs.push=function(op){if(op instanceof Array){op.forEach(function(op){[].push.call(cs,op)})}else{[].push.call(cs,op)}};cs.revision=function(rev){return Changesets.cs(cs.map(function(op){return op.revision(rev)}))};cs.maxRevision=function(){return Math.max(0,Math.max.apply(null,cs.map(function(op){return op.accessory})))};cs.apply=function(text,selection){this.sequencify().forEach(function(op){text=op.apply(text,selection)});return text};cs.transformAgainst=function(b){var newCs=Changesets.cs([]),b=b.sequencify();this.forEach(function(op){b.forEach(function(o){op=op.transformAgainst(o)});newCs.push(op)});return newCs};cs.sequencify=function(cs){var result=Changesets.cs([]);this.forEach(function(op){if(op.type=="=")return;result.forEach(function(o){op=op.transformAgainst(o)});result.push(op)});return result};cs.pack=function(){return this.filter(function(op){return op.type!="="}).map(function(op){var text=op.text.replace(/%/g,"%25").replace(/:/g,"%3A"),pos=op.pos.toString(36),tlen=op.tlen.toString(36),accessory=op.accessory.toString(36);return op.type+pos+":"+tlen+":"+text+":"+accessory}).join("")};return cs},diff:function(oldText,newText,accessory){accessory=accessory||0;var diff=textdiff(oldText,newText),cs=Changesets.cs([]),tlen=oldText.length;if(diff.oldFragment){cs.push(Changesets.op({type:"-",tlen:tlen,pos:diff.from,text:diff.oldFragment,accessory:accessory}))}if(diff.newFragment){cs.push(Changesets.op({type:"+",tlen:tlen,pos:diff.from,text:diff.newFragment,accessory:accessory}))}return cs},unpack:function(packed){if(packed=="")return Changesets.cs([]);var matches=packed.match(/(\+|-)\w+?:\w+?:[^:]+?:\w+/g);if(!matches)throw new Error("Cannot unpack invalid serialized changeset string");return Changesets.cs(matches.map(function(s){var props=s.substr(1).split(":");return Changesets.op({type:s.substr(0,1),pos:parseInt(props[0],36),tlen:parseInt(props[1],36),text:props[2].replace(/%3A/gi,":").replace(/%25/g,"%"),accessory:parseInt(props[3],36)})}))}};try{module.exports=Changesets}catch(e){}if(typeof module!="undefined")module.exports=require("./lib/changesets");var EditorUtil=function(){_f=function(){};function supportsPlaintextEditables(){var div=document.createElement("div");div.setAttribute("contenteditable","PLAINTEXT-ONLY");return div.contentEditable==="plaintext-only"}function getSpaceConstant(exclude,charsQuantity){charsQuantity=charsQuantity||"all";exclude=exclude||[];var spaceChars=[160,10,8,32,8194,8195,8196,8197,8198,8199,8200,8201,8202,8203,8287,12288];if(exclude.length){spaceChars=spaceChars.filter(function(el){return!~exclude.indexOf(el)})}for(var i=0;i<spaceChars.length;i++){spaceChars[i]=String.fromCharCode(spaceChars[i])}var regexpQuantity="";switch(charsQuantity){case"single":break;case"all":default:regexpQuantity="+";break}return new RegExp("["+spaceChars.join("")+"]"+regexpQuantity,"g")}var SPACE_RE=getSpaceConstant([160]);var SPACE_RE_SINGLE=getSpaceConstant([160],"single");var ALL_SPACE_RE=getSpaceConstant();var NBSP_RE=new RegExp(String.fromCharCode(160),"g");var SEPARATORS=',.;:()§&$%!@#?*~+}{[]|/"`-<>…“”\n';var SEP_RE=new RegExp("["+SEPARATORS+"]","g");function containsSeparator(str){return str.match(SEP_RE)||str.match(ALL_SPACE_RE)}var QUOTE_RE=/["'”’‚‛‟„“]/g;function isSep(str){if(!str)return true;str=str.replace(QUOTE_RE,"");return SEPARATORS.indexOf(str)!=-1||str.match(ALL_SPACE_RE)}function wordSeparated(text,s,e){var leftChar=text.substring(s-1,s);var rightChar=text.substring(e,e+1);return isSep(leftChar)&&isSep(rightChar)||s==e}function getNextWord(text,pos,withInc){var part=text.substring(pos,text.length);var inc=0;var word="";if(part.length==0){if(withInc)return{inc:inc,word:""};return""}var sep="";while(part.length>0&&isSep(part[0])){sep+=part.substring(0,1);part=part.substring(1,part.length);inc++}for(var i=0;i<part.length;i++){var letter=part[i];if(isSep(letter)){if(withInc)return{inc:inc,word:word,sep:sep};return word}word+=letter}if(withInc)return{inc:inc,word:word,sep:sep};return word}function getPrevWord(text,pos){var part=text.substring(0,pos);var word="";while(isSep(part[part.length-1])&&part.length>0)part=part.substring(0,part.length-1);pos=part.length-1;while(pos>=0){var letter=part[pos];if(isSep(letter))return word;word=letter+word;pos--}return word}var SENTENCE_SEP=/[!?.]\s|\n/g;function getSentenceByPos(text,pos){var i=pos,part=text.substr(i,2),shiftedPart=text.substr(i-1,2);if(shiftedPart&&shiftedPart.match(SENTENCE_SEP)){pos--;i=pos;part=text.substr(i,2)}while(part&&!part.match(SENTENCE_SEP)){i++;part=text.substr(i,2)}var endPos=i+2,i=pos,part=text.substring(i-2,i);while(part&&i-2>0&&!part.match(SENTENCE_SEP)){i--;part=text.substring(i-2,i)}var startPos=i;if(startPos-2<=0)startPos=0;return{s:startPos,e:endPos}}function getNextSepOffset(text,pos){var result=0;var i=pos;while(!_.isUndefined(text[i])&&!isSep(text[i])){i++;result++}return result}function getPrevSepOffset(text,pos){var result=0;var i=pos;while(!_.isUndefined(text[i])&&!isSep(text[i])){i--;result++}return result}function getPos(elem,parent){if(!elem||elem==parent){return{x:0,y:0}}var xy={x:elem.offsetLeft,y:elem.offsetTop};var par=getPos(elem.offsetParent,parent);for(var key in par){xy[key]+=par[key]}return xy}function wordCount(text){if(!text)return 0;var words=text.replace(/[\W\d]/gi," ").trim().replace(/\s+/gi," ").split(" ");return words.length===1&&words[0]===""?0:words.length}function declension(value,arr){if(arr.length==2)arr.push(arr[1]);var index=2;if(value%10==1&&value%100!=11)index=0;if(value%10>=2&&value%10<=4&&(value%100<10||value%100>=20))index=1;return arr[index]}return{_f:_f,declension:declension,wordCount:wordCount,getPos:getPos,getPrevSepOffset:getPrevSepOffset,getNextSepOffset:getNextSepOffset,getSentenceByPos:getSentenceByPos,getPrevWord:getPrevWord,getNextWord:getNextWord,wordSeparated:wordSeparated,isSep:isSep,QUOTE_RE:QUOTE_RE,ALL_SPACE_RE:ALL_SPACE_RE,getSpaceConstant:getSpaceConstant,supportsPlaintextEditables:supportsPlaintextEditables}}();try{module.exports=EditorUtil}catch(e){}var emitter=require("emitter"),_=require("lodash"),createWs=require("websocket");var capi=emitter({CLIENT_NAME:"web",PROTOCOL_VERSION:"1.0",extDomain:"",token:null,debug:false,setToken:function(token){capi.token=token;capi.emit("ready",capi.token)},onReady:function(cb){if(capi.token)return cb(capi.token);capi.one("ready",cb)}});capi.createClient=function(options){var idleTimeout=15*60*1e3,wsErrorStatus=false,failCount=0,runtimeErrIntervals=[],lastErr,lastErrSended=0;options=_.extend({connectionTimeout:1e3,sid:null,useQueue:30,useStandBy:idleTimeout,resetQueueOnReconnect:true},options);var socket=options.createWs||createWs;var client=emitter({rev:0,messageId:0,options:options,genre:null,ws:socket(options),checkText:function(changedText,start,end,cb){return client.check(changedText,start,end,null,cb)},submitOt:function(changes,rev,data,cb){client.rev=rev;data=data||{};return sendRev("submit_ot",_.extend({ch:changes},data),cb)},checkNoSynonymsText:function(changedText,start,end,cb){return client.check(changedText,start,end,"NOSYNONYMS",cb)},checkGrammar:function(changedText,start,end,cb){return client.check(changedText,start,end,"GRAMMAR",cb)},checkSpell:function(changedText,start,end,cb){return client.check(changedText,start,end,"SPELL",cb)},checkStyle:function(changedText,start,end,cb){return client.check(changedText,start,end,"STYLE",cb)},checkSynonyms:function(changedText,start,end,cb){return client.check(changedText,start,end,"SYNONYMS",cb)},ignore:function(alert){return client.feedback(alert,"ignore")},ignoreAll:function(alert){return client.feedback(alert,"ignore_all")},addToDictionary:function(alert){return send("add_to_dict",{word:alert.value})},feedback:function(alert,type){return send("feedback",{sentenceNo:alert.sentence_no,alertId:alert.sid,text:alert.value,type:type,acceptedPos:null})},check:function(changedText,start,end,checks,cb){return sendRev("submit",{text:changedText,begin:start,end:end,checks:checks},cb)},start:function(){var data={token:capi.token,sid:options.sid,docid:options.docid,client:capi.CLIENT_NAME,protocolVersion:capi.PROTOCOL_VERSION};if(capi.clientVersion)data.clientVersion=capi.clientVersion;if(capi.extDomain)data.extDomain=capi.extDomain;return send("start",data)},plagiarism:function(text,cb){return sendRev("plagiarism",{text:text},cb)},undo:function(alertId,sentenceId){return send("undo",{alertId:alertId,sentenceId:sentenceId})},drop:function(alertId,sentenceId){return send("drop",{alertId:alertId,sentenceId:sentenceId})},synonyms:function(begin){return send("synonyms",{rev:client.rev-1,begin:begin})},stop:function(){return send("stop")},logout:function(){return send("logout")},close:function(){client.ws.close()},wsPause:function(){client.ws.wsPause()},wsPlay:function(){client.ws.wsPlay()}});client.ws.on("message",function(msg){if(!msg.action)return;var action=msg.action.toLowerCase();if(action=="finished"){client.emit([action,msg.rev],msg);return client.emit(action,msg)}if(action=="error"){if(msg.error=="runtime_error"){handleRuntimeError(msg)}return client.emit("capiError",msg)}if(action=="alert"){client.emit([action,msg.rev],msg);return client.emit(action,msg)}else if(msg.id){client.emit([action,msg.id],msg)}client.emit(action,msg)});client.on("start",function(msg){console.log("Got START with sid %s",msg.sid);if(msg.sid){client.options.sid=msg.sid}});client.ws.connect();client.start();client.ws.on("connect",function(){client.emit("socketConnect")});client.ws.on("error",function(e){client.emit("serviceState",{type:"capi",available:false});if(e=="disconnected"){return}client.emit("socketError",e);if(!wsErrorStatus){failCount++;client.emit("socketFailCount",failCount)}wsErrorStatus=true});client.ws.on("reconnect",function(){client.start();client.emit("socketReconnect");client.emit("serviceState",{type:"capi",available:true});if(wsErrorStatus){client.emit("socketReconnectAfterError");wsErrorStatus=false}});client.ws.on("disconnect",function(){client.emit("disconnect")});if(capi.debug){client.revisions={};client.on("alert",function(alert){client.revisions[alert.rev]=client.revisions[alert.rev]||{alerts:[],finish:null};client.revisions[alert.rev].alerts.push(alert)});client.on("finished",function(msg){client.revisions[msg.rev].finish=msg});client.revisionInfo=function(rev){return client.revisions[rev]}}return client;function handleRuntimeError(msg){lastErr=Date.now();runtimeErrIntervals.push(lastErr);if(runtimeErrIntervals.length<10){client.ws.connect();client.start();client.emit("tryToReconnect")}if(runtimeErrIntervals.length>10&&lastErr-runtimeErrIntervals[runtimeErrIntervals.length-11]<6e4&&lastErr-lastErrSended>6e4){client.emit("frequent_runtime_error",{msg:msg,count:runtimeErrIntervals.length,intervals:runtimeErrIntervals});lastErrSended=lastErr}if(runtimeErrIntervals.length>100){client.emit("too_many_runtime_error",{msg:msg,intervals:runtimeErrIntervals});runtimeErrIntervals=[]}}function sendRev(op,msg,cb){msg.rev=client.rev++;_.isFunction(cb)&&client.one(["finished",msg.rev],cb);send(op,msg);return msg.rev}function send(op,msg,cb){msg=msg||{};msg.action=op;msg.id=client.messageId++;var start=+new Date;client.one([msg.action,msg.id],function(){_.isFunction(cb)&&cb(msg);client.emit("stats:timing",{key:"performance:capi_time",value:new Date-start,tags:["op:"+op]})});client.ws.send(msg);return msg.id}};try{module.exports=capi}catch(e){}var textdiff=require("textdiff").textdiff;function diffochka(oldLine,newLine,cls){if(oldLine.length<=4)return newLine;var diff=textdiff(oldLine,newLine);if(!diff.from)return newLine;cls=cls||"b";var startTag='<span class="'+cls+'">',endTag="</span>";if(diff.newFragment.length==1&&diff.from>0&&oldLine[diff.from-1]==diff.newFragment){diff.newFragment=diff.newFragment+diff.newFragment;diff.from-=1}if(diff.oldFragment.length==1&&!diff.newFragment.length&&newLine[diff.from-1]==diff.oldFragment){diff.newFragment=diff.oldFragment;diff.from-=1}if(diff.newFragment.length>3){return newLine}newLine=oldLine.substring(0,diff.from)+startTag+diff.newFragment+endTag+oldLine.substring(diff.to);return newLine}try{module.exports=diffochka}catch(e){}var Under=require("under"),Wrap=require("wrap"),_=require("lodash");GrammarlyEditor.Capi=require("./capi");GrammarlyEditor.Util=require("./editor-util");function GrammarlyEditor(config){GrammarlyEditor.TextApi=require("./text-api");GrammarlyEditor.MatchExtensions=require("./match-extensions");GrammarlyEditor.MatchPositions=require("./match-positions");GrammarlyEditor.Synonyms=require("./synonyms");var Util=GrammarlyEditor.Util;var track=require("./track");var api=GrammarlyEditor.TextApi(config);config.api=api;config.editorType=config.editorType.value;config.isValidNode=isValidNode;config.isValidMatchForNode=isValidMatchForNode;var editor=Under.Editor(config);editor.matchPrefix=config.matchPrefix;var filter=config.filter||function(arr){return arr};var apps=config.apps||{plagiarismActive:_f};var lazyCheckPlagiarism=_.throttle(checkPlagiarism,config.plagiarismCheckDelay||2e3);var matches=editor.matches;var matchExtensions=GrammarlyEditor.MatchExtensions({editor:editor,matches:matches});var matchPos=GrammarlyEditor.MatchPositions({editor:editor,el:editor.el});var SKIP_TAGS=["pre","code","blockquote"];var SKIP_CLASSES=["gmail_quote"];Wrap.skipTag(_.union(Wrap.skipTag(),SKIP_TAGS));Wrap.skipClass(_.union(Wrap.skipClass(),SKIP_CLASSES));updateTextareaHeight=config.updateTextareaHeight||updateTextareaHeight;_.extend(editor,{checkPlagiarism:checkPlagiarism,getSynonyms:getSynonyms,filter:filter,apps:apps,matchFilter:matchFilter,updateTextareaHeight:updateTextareaHeight,synonyms:GrammarlyEditor.Synonyms({editor:editor,canRemove:config.canRemoveSynonym,textareaWrapSelector:config.textareaWrapSelector,animatorContainer:config.animatorContainer,getAnimatorElPos:config.getAnimatorElPos}),getState:getState,setState:setState,run:run,ot_alert_intersection:0,isTextarea:isTextarea},matchExtensions,matchPos);var isTextarea=config.editorType=="textarea";var lazyUpdateTextareaHeight=_.throttle(editor.updateTextareaHeight,60);editor.on("change",onchange);editor.on("input",oninput);editor.on("keydown",oninput);editor.on("exit",onexit);editor.on("fieldEnable",fieldEnable);editor.on("startInvalidateNode",config.api.wsPause);editor.on("endInvalidateNode",config.api.wsPlay);api.delegate(editor,"plagiarismChecked");api.delegate(editor,"capiError");api.delegate(editor,"serviceState");api.delegate(editor,"socketConnect");api.delegate(editor,"socketReconnect");api.delegate(editor,"socketReconnectAfterError");api.delegate(editor,"socketFailCount");api.delegate(editor,"disconnect");api.delegate(editor,"socketError");api.delegate(editor,"frequent_runtime_error");api.delegate(editor,"too_many_runtime_error");api.on("remove",onServerRemove);api.on("tryToReconnect",function(){editor.api.restart()
});api.on("socketReconnect",function(){editor.hardReset()});track(editor);Wrap.error=function(err){editor.emit("track",{type:"increment",key:"wrap_error."+err})};if(!isTextarea&&Util.supportsPlaintextEditables()&&config.asPlainText){}var checkCorruptedUnderlinesTimer;if(!isTextarea)checkCorruptedUnderlines();var reportStats=_.debounce(doReportStats,5e3);if(config.autorun)run();var originalFeedback=editor.api.feedback;editor.api.feedback=function(match,type){originalFeedback(match,type)};return editor;function run(){editor.inputListener.start();editor.dom.start();if(config.value){editor.setText(config.value)}if(config.matches){editor.addMatches(config.matches)}updateTextareaHeight();editor.api.update(editor.currentText);editor.check()}function onServerRemove(sid){sid=sid.id||sid;var m=editor.bySid(sid.toString());editor._removedByServer.push(sid);matches.rmMatchesBufferCache(sid);if(m){editor.emit("serverRemove",m);if(m.cancelServerRemove){delete m.cancelServerRemove;return}}if(m){return matches.forceRemove(m)}var removed=editor.matches.getRemoved()[sid];if(removed){console.log("remove-already-removed-match");matches.forceRemove(removed)}}function matchFilter(matches){var filtered=filter(matches);return filtered}function isValidNode(node){return node.tagName&&SKIP_TAGS.indexOf(node.tagName.toLowerCase())==-1&&node.className!="gmail_quote"}function isValidMatchForNode(node,isValidNode,match){if(match.id=="tmp_id")return true;if(match.syn)return true;return isValidNode}function getState(isText){var result={matches:editor.serializeMatches(editor.matches.get(),true),editorId:editor.id,cursor:editor.latestCursor,socketId:editor.api.ws.socketId,api:editor.api.getState(),selectedMatchId:editor.selectedMatch&&editor.selectedMatch.id};if(editor.getHtml&&!isText){result.html=editor.getHtml();result.whiteSpace=editor.el.__white_space}else{result.text=editor.getText()}return result}function setState(data){editor.clearData();if(data.html){editor.el.__white_space=editor.el.style.whiteSpace=data.whiteSpace||"normal"}editor.one("afterReplace",function(){editor.api.setState(data.api);editor.addMatches(data.matches);if(!data.cursor)data.cursor={s:0,e:0};if(!editor.isHtmlGhost)editor.el.focus();var hasSyn=editor.getMatches().filter(function(m){return m.syn}).length>0;if(hasSyn)editor.synonyms.registerRemove();editor.setCursor(data.cursor);editor.latestCursor=data.cursor;editor.render()});data.html!=undefined?editor.setHtml(data.html):editor.setText(data.text)}function checkPlagiarism(){api.checkPlagiarism(editor.currentText)}function getSynonyms(s){api.synonyms(s)}function onchange(e){if(apps.plagiarismActive())lazyCheckPlagiarism()}function oninput(){if(isTextarea){setTimeout(lazyUpdateTextareaHeight,0)}reportStats()}function updateTextareaHeight(){var clone=editor.dom.cloneVal,txt=editor.el;if(!clone)return;txt.style.height=clone.clientHeight+20+"px";txt.scrollTop=0}function doReportStats(){if(!editor.getText)return;var text=editor.getText(),_wordCount=Util.wordCount(text);var rate=_wordCount>0?editor.getFiltered().length/_wordCount:0;editor.emit("track",{type:"timing",data:{"performance:text_stats.error_rate":Math.round(rate*1e3)/1e3,"performance:text_stats.text_size_chars":text.length,"performance:text_stats.text_size_words":_wordCount}})}function checkCorruptedUnderlines(){var els=editor.el.querySelectorAll(".gr-alert"),len=els.length;for(var i=0;i<len;i++){var matchEl=els[i],sibling=matchEl.nextSibling;if(!sibling||sibling.nodeType!=3)continue;if(matchEl.__sentCorruptedUnderline)continue;if(Under.Util.hasClass(matchEl,"Punctuation"))continue;if(sibling.textContent[0].match(/\w/)){editor.emit("corruptedUnderline",{text:matchEl.textContent,id:matchEl.id,className:matchEl.className,siblingText:sibling.textContent.substring(0,20)});matchEl.__sentCorruptedUnderline=true}}checkCorruptedUnderlinesTimer=setTimeout(checkCorruptedUnderlines,5e3)}function fieldEnable(){editor.synonyms.fieldEnable()}function onexit(){editor.api.close();editor.synonyms.disable();clearTimeout(checkCorruptedUnderlinesTimer)}}GrammarlyEditor.getUpgradeUrlFromMatches=function(config){var grouped=getGrouped(config.matches),urlContainer={},returnUrl=config.returnUrl,appType=config.appType,queryParams=config.queryParams||{},data={};if(returnUrl)urlContainer["return_url"]=encodeURIComponent(returnUrl);if(config.appType)urlContainer["app_type"]=config.appType;data=_.extend(grouped,urlContainer,queryParams);return config.baseUrl+"?"+composeRequest(data);function composeRequest(data){var req="";_.each(data,function(v,k){if(req!="")req+="&";req+=encodeURI(k)+"="+v});return req}function getGrouped(matches){matches=getPro(matches);var grouped={};_.each(matches,function(match){var group=match.group,category=match.category.replace("_",""),key=[group,category].join(":");if(grouped[key]==undefined)grouped[key]=0;grouped[key]+=1});return grouped}function getPro(matches){return _.filter(matches,function(match){return match.hidden})}};try{module.exports=GrammarlyEditor}catch(e){}var MatchExtensions=function(config){var MatchTransformer=require("./match-transformer"),Util=require("./editor-util"),_=require("lodash");var matches=config.matches,editor=config.editor;var removeSepArr=_.map(",.;:",function(v){return v+" "});var me={getMatchClass:getMatchClass,processMatch:processMatch,beforeReplace:beforeReplace,processRemove:processRemove,matchRemoved:matchRemoved,matchesEqual:matchesEqual,extendMatch:extendMatch,canAddRemovedMatch:canAddRemovedMatch,canShiftMatchEnd:canShiftMatchEnd,removeSyn:removeSyn,tryToAdd:tryToAdd,serializeMatches:serializeMatches,addSyn:addSyn,filterBySpelling:filterBySpelling,bySid:bySid};var _remove=matches.remove;matches.remove=remove;return me;function getMatchClass(m,text){var cls=m.syn?" gr-syn":" gr-alert";if(m._e-m._s==1&&text.substring(m._s,m._e).toLowerCase()!="a")cls+=" gr_tiny";if(m.selected)cls+=" sel";cls+=m.gramm?" gr_gramm":" gr_spell";if(m.replaced)cls+=" gr_replaced";if(m.notClickableTitle&&m.group!="ContextualSpelling")cls+=" gr_hide";if(!m.free)cls+=" gr_premium";return cls}function processMatch(match,text){match.skipUpdatePos=match.category=="Plagiarism"||match.type=="syn";MatchTransformer.transform(match,text);if(match.type=="syn"){editor.emit("syn",match);return true}}function bySid(sid){return _.findWhere(matches.get(),{sid:sid})}function filterBySpelling(matches,text){var sentences=[];for(var i=0;i<matches.length;i++){var m=matches[i];if(m.group=="ContextualSpelling")sentences.push(Util.getSentenceByPos(text,m.s))}return matches.filter(function(m){if(m.group=="ContextualSpelling"||m.group=="Plagiarism"||m.syn)return true;for(var i=0;i<sentences.length;i++){var sentence=sentences[i];if(m.s>sentence.s&&m.s<sentence.e)return false}return true})}function isRemoveMatchFromSamePlaceSameCategory(m){var _matches=matches.get();if(m.category=="Plagiarism")return;for(var i=0;i<_matches.length;i++){var existed=_matches[i];if(existed.category!=m.category||existed.category=="Plagiarism")continue;var result=matches.isIntersected(m,existed)&&replacementsEqual(m,existed);if(result)return existed}return false}function isDuplicateMatch(m){var _matches=matches.get();if(m.category=="Plagiarism")return;for(var i=0;i<_matches.length;i++){var existed=_matches[i];if(isSameValue(m,existed)){if(m.priority<existed.priority){return-1}else if(m.priority>existed.priority){return i}}}function isSameValue(m,ex){return m.s==ex.s&&m.e==ex.e||(m.s==ex.s||m.e==ex.e)&&m.value.replace(/\s+/g,"")==ex.value.replace(/\s+/g,"")}}function tryToAdd(match,text){var _matches=matches.get();var duplicate=isDuplicateMatch(match);if(duplicate==-1){console.log("%c skip adding match with lower priority","color:rgba(239, 110, 105, 0.8)",match.value,match);return}else if(duplicate>-1){console.log("%c remove same match with lower priority","color:rgba(239, 110, 105, 0.8)",_matches[duplicate].value,_matches[duplicate]);_matches.splice(duplicate,1)}var existed=isRemoveMatchFromSamePlaceSameCategory(match);if(existed){console.log("%c remove, match of same category is overlaping with","color:rgba(239, 110, 105, 0.8)",match.value,existed);matches.matchUpdater.extendWithoutAdding(_matches,match);return}var containsSpace=match.v.indexOf(" ")!=-1,containsAph=match.v.indexOf("'")!=-1||match.v.indexOf("’")!=-1,isDoubleComas=match.v==",,"||match.v=="..";if(!_.isUndefined(match.rFirst)&&!Util.wordSeparated(text,match.s,match.e)&&!containsSpace&&!Util.isSep(match.v.trim())&&!containsAph&&!isDoubleComas){console.log("%c match is part of word '%s'","color:rgba(239, 110, 105, 0.8)",match.value,match);matches.emit("match_is_part_of_word");return}if(match.category=="IgnoredPatterns"||match.category=="IgnoredWords"){console.log("%c remove ignored","color:rgba(239, 110, 105, 0.8)",match);return}var valInText=text.substring(match.s,match.e);if(match.todo.indexOf("add a comma")!=-1){if(text.substring(match.e,match.e+1)==","||valInText[valInText.length-1]==","){match.removed=true;console.log("%c lost add a comma match, comma is here","color:rgba(239, 110, 105, 0.8)",match);return}}if(match.todo.indexOf("add an article")!=-1){if(valInText==" an"||valInText==" the"||valInText==" a"){console.log("%c lost add an article match","color:rgba(239, 110, 105, 0.8)",match);return}}var withPrev=Util.getPrevWord(text,match.s)+" "+match.value;var fixedArticle=withPrev==match.rFirst||withPrev==match.secondArticle;if(fixedArticle){console.log("%c lost add an article match, article already fixed","color:rgba(239, 110, 105, 0.8)",match);return}if(existsSpellingMatch(match)){console.log("skip AccidentallyConfused match see https://grammarly.atlassian.net/browse/FT-1172");return}var result=matches.tryToAdd(match,text);if(!result)return;return true}function existsSpellingMatch(m1){var _matches=matches.get();for(var i=0;i<_matches.length;i++){var m2=_matches[i];if(m1.s==m2.s&&m1.e==m2.e&&m1.category=="AccidentallyConfused"&&(m2.category=="CommonlyConfused"||m2.category=="Misspelled"))return true}return false}function matchRemoved(m,text,s,e){var value=m.value;var wordJoined=!Util.wordSeparated(text,s,e);var spaceWrapped=value[0]==" "&&value[value.length-1]==" ";var comma=value.indexOf(",")!=-1;var semicolon=value.indexOf(";")!=-1;var removeSepCase=removeSepArr.indexOf(value)!=-1;var manualyFixedSeparator=m.rFirst==text.substring(s,e+1);var withPrev=Util.getPrevWord(text,s)+" "+value;var fixedArticle=withPrev==m.rFirst||withPrev==m.secondArticle;var fixedArticleWord=m.category=="ArticleUse"&&m.todo.indexOf("change")!=-1&&m.next!=Util.getNextWord(text,e);var plagiarism=m.category=="Plagiarism";var closingPunctuation=m.category=="ClosingPunctuation";if(wordJoined&&!spaceWrapped&&!comma&&!removeSepCase&&!semicolon&&!closingPunctuation&&!plagiarism||manualyFixedSeparator||fixedArticle||fixedArticleWord){return true}return false}function addSyn(match){var text=editor.getText();var added=matches.tryToAdd(match,text,text);if(!added)return;editor.addMethodsToMatch(match);editor.saveCursor();editor.render();editor.restoreCursor();editor.emit("addedSynonym",match)}function removeSyn(){editor.saveCursor();matches.get().forEach(function(m){if(m.syn){editor.emit("removeSyn",m)}});removeSynFromMatches();editor.dom.removeBySelector(".gr-syn");editor.restoreCursor()}function removeSynFromMatches(){var _matches=matches.get();for(var i=0;i<_matches.length;i++){_matches[i].deselect();if(_matches[i].syn){matches.remove(_matches[i]);i--}}}function beforeReplace(match,offset,value){if(match.syn){editor.latestCursor.s=editor.latestCursor.e=editor.latestCursor.s-offset+value.length}}function replacementsEqual(m1,m2){return m1.rFirst==m2.rFirst&&JSON.stringify(m1.r)==JSON.stringify(m2.r)}function matchesEqual(o,n,equalPos){if(o.syn||n.syn)return;return equalPos&&o.v.toLowerCase()==n.v.toLowerCase()&&o.category==n.category&&replacementsEqual(o,n)}function extendMatch(o,n){o.sid=n.id;o.sentence_no=n.sentence_no;var attrs="header, cls, details, explanation, todo, notClickableTitle, showTitle",rerenderCard=false;attrs.split(", ").forEach(function(key){if(o[key]!=n[key]){rerenderCard=true}o[key]=n[key]});if(o.card&&rerenderCard){o.card.remove();delete o.card}console.log("updated match with server id",o)}function canShiftMatchEnd(m){return!m.syn}function processRemove(m,text,newS,newE,delta){if(m.category=="Plagiarism")return{next:true};return{remove:false}}function remove(match,withoutEmit){_remove(match,withoutEmit);delete match.selected;if(match.card){match.card.remove()}delete match.card;if(!match.serverRemove)matches.addRemoved(match)}function canAddRemovedMatch(match){return match.addedToDict||match.ignored||match.serverRemove}function serializeMatches(_matches,includeSynonyms){_matches=_matches||matches.get();_matches=_matches.filter(function(m){return!m.replaced});if(!includeSynonyms)_matches=_matches.filter(function(m){return!m.syn});_matches=_matches.map(function(m){var result={};for(var p in m){if(p!="r"&&p!="origReplacements"&&p!="rHtml"&&p!="examples"&&p!="references"&&p!="syn"&&p!="synonyms"&&(_.isFunction(m[p])||_.isObject(m[p])||p=="selected"||p=="inDom"&&!_.isArray(m[p])&&p!="header"))continue;result[p]=m[p]}return result});return _matches}};try{module.exports=MatchExtensions}catch(e){}var MatchPositions=function(config){var _=require("lodash"),Under=require("under"),Util=require("./editor-util");var el=config.el;var editor=config.editor;var parentPos=Util.getPos(el,document.body);var scrollEl=document.querySelector(".main-scroller");var txtContainer=document.querySelector(".textarea-container .textarea-wrap");var lazyGenerateMatchPositions=_.throttle(immediateMatchPositions,50);var me={generateMatchPositions:lazyGenerateMatchPositions};return me;function generateMatchPositions(cb){lazyGenerateMatchPositions(cb)}function immediateMatchPositions(cb){var matches=editor.getFiltered();var syn=_.find(matches,function(m){return m.syn});if(Under.Util.hasClass(txtContainer,"animating")){if(syn&&syn.box)return;if(!syn)return}var scrollTop=scrollEl.scrollTop;var addedTop,addedBottom;var txtContainerTransform=Under.Util.css(txtContainer,"transform")||"";var txtContainerTop=parseInt(txtContainerTransform.split("(")[1],10)-15;if(isNaN(txtContainerTop))txtContainerTop=0;for(var i=0;i<matches.length;i++){var m=matches[i];var alertEl=document.getElementById(m.id);if(!alertEl){continue}var offsetTop=alertEl.offsetTop;var parent=alertEl.parentNode;var multiword=(alertEl.innerText||alertEl.textContent).split(" ").length>1;if(Under.Util.hasClass(parent,"gr_")||parent==alertEl.offsetParent){offsetTop=alertEl.getBoundingClientRect().top+scrollTop-parentPos.y-txtContainerTop}var pos={x:parentPos.x+alertEl.offsetLeft,y:parentPos.y+offsetTop-10};var box={x1:pos.x,x2:pos.x+alertEl.offsetWidth,y1:pos.y,y2:pos.y+alertEl.offsetHeight+5};m.box=box;if(multiword){var rects=alertEl.getClientRects();if(rects.length>1){m.rects=[];for(var j=0;j<rects.length;j++){var r=rects[j],t=r.top+scrollTop-txtContainerTop-10;m.rects.push({x1:r.left,x2:r.right,y1:t,y2:t+r.height})}}}m.calculatedPos=true;m.inViewPort=true}cb&&cb()}};try{module.exports=MatchPositions}catch(e){}var MatchTransformer=function(){var Under=require("under"),diffochka=require("./diffochka"),Util=require("./editor-util");var guid=Under.Util.guid,divEvaluator=document.createElement("div");return{transform:processMatch};function examples(alert){var regexp=/^(?:(Incorrect: )|(Correct: )){1}(.+)$/,result=[];if(!alert.examples)return[];divEvaluator.innerHTML=alert.examples;var groups=divEvaluator.querySelectorAll("p");for(var i=0;i<groups.length;i++){var items=groups[i].querySelectorAll("span"),group=[];for(var j=0;j<items.length;j++){var item=items[j],content=item.innerHTML,match=content.match(regexp),type="Comment";if(!match){if(content=="Exceptions:")type="Exception"}else{content=match[3];type=match[1]=="Incorrect: "?"Incorrect":"Correct"}group.push({type:type,example:content})}if(group.length)result.push(group)}return result}function references(str){var lines=str.split(/\n|<br\/?>/gi);lines.splice(0,4);var result=[];for(var i=0;i<lines.length;i++){var line=lines[i];var m=line.match(/<strong>(.*?)\:<\/strong>(.*?)$/i);var t,d;if(m)t=m[1],d=m[2].replace("_br","");result.push({type:t,descr:d})}return result}function details(match){var d=match.details||"";return d}function explanation(match){var result=match.explanation&&match.explanation.replace(/<\/?p[^>]*>/g,"").trim();return result}function plagiarism(match){if(match.category!="Plagiarism")return;match.references=references(match.details);var domain=match.extra_properties.url.match(/^(?:((?:https?|s?ftp):)\/\/)([^:\/\s]+)(?::(\d*))?(?:\/([^\s?#]+)?([?][^?#]*)?(#.*)?)?/)[2];match.explanation="A part of your paper is matching some text from the Web. Please make sure that this text is properly referenced.";match.header="Unoriginal text: "+Util.wordCount(match.text)+" words";match.href=match.extra_properties.url;match.href_title=match.extra_properties.url.replace("https://","").replace("http://","")}function partsToHTML(parts,match){var result="";var prevDel=false;if(!parts||parts.length==0)return;match.onlyDel=true;for(var i=0;i<parts.length;i++){var t=parts[i];var nextIns=parts[i+1]&&parts[i+1].ins;var nextDel=parts[i+1]&&parts[i+1].del;if(!_.isUndefined(t.sep)){result+="<span class='arr'> → </span>";prevDel=null;continue}if(t.ins){match.onlyDel=false;if(prevDel){result+="<span class='arr'> → </span>"}var cls="";if(".,:;_".indexOf(t.ins)!=-1)cls="thin";var diffed=t.ins;if(prevDel){diffed=diffochka(prevDel,t.ins);match.del=prevDel;prevDel=null}result+="<span class='ins "+cls+"'>"+diffed+"</span>"}if(t.del){if(t.del.length>1){diffed=t.del;if(nextIns)diffed=diffochka(nextIns,t.del);var cls="del ";if(t.del.match(/["'”][.,;]/)){cls+="del-qdot "}if(t.del.match(/,,/)){cls="red sign double-commas"}var words=t.del.replace(/,/g,"").split(" ").filter(Boolean)||[];if(t.del.match(/^,(.*?),$/)&&t.del.length>2&&words.length>1){cls="red";var coma="<span class='sign "+cls+"'>,</span>";result="<span class='"+cls+"'>"+coma+words.shift()+"..."+words.pop()+coma+"</span>";match.onlyDel=false;break}else{result+="<span class='"+cls+"'>"+diffed+"</span>"}}else{var cls=t.del.match(/[a-z]/i)?" del del-letter":" sign";if(t.del=="’")cls+=" apostrophe";console.log(t.del,cls);result+="<span class='red"+cls+"'>"+t.del+"</span>"}prevDel=t.del}var w=t.w;if(w){var cls="word";if(nextDel)cls+=" del-word";if(nextIns)cls+=" ins-word";w="<span class='"+cls+"'>"+w+"</span>"}if(w)result+=w}return result}function orPartsToHTML(r,parts){if(!parts)return;var s=_.template("<span class='replacement'><span class='btn-r' data-value='<%- r %>'><%= title %></span></span>");var title="";if(parts.length==2&&parts[0].del&&parts[1].ins){title=_.template("<span><span class='ins sec'><%= ins %></span></span>")({ins:parts[1].ins})}if(parts.length==3&&parts[0].del&&parts[2].ins){title=_.template("<span><span class='ins sec'><%= ins %></span></span>")({ins:parts[2].ins})}if(parts[0].w){title=_.template("<span><%= w %><span class='ins sec'><%= ins %></span></span>")({w:parts[0].w,ins:parts[1].ins})}if(parts[0].ins){title=_.template("<span><span class='ins sec'><%= ins %></span><%= w %></span>")({ins:parts[0].ins,w:parts[1].w})}return s({r:r,title:title})}function rHTML(transforms,match){var result=[],isSep=transformHasSeparator(transforms[0]);if(!isSep)match.cls+=" replaceWithoutSep";for(var i=1;i<transforms.length;i++){var parts=partsAfterSep(transforms[i],isSep);result.push({label:partsToHTML(parts,match)||match.origReplacements[i],value:match.origReplacements[i]})}return result}function partsAfterSep(transform,isSep){var result=[],sep=false;var prevDel=false;result=transform.filter(function(part){if(!isSep)return part;if(sep)return part;if(part.del)prevDel=true;if(part.sep||prevDel&&part.ins)sep=true});return result}function multiReplacesToHTML(transforms,match){var result="",t=_.template("<span class='replacement replacement-<%= index %>'><span class='btn-r' data-value='<%- r %>'><span><%= parts %></span></span></span>");r=[];var firstParts=[],prevDel,isSep=false,isIns=false;for(var i=0;i<transforms[0].length;i++){var tr=transforms[0][i];firstParts.push(tr);if(tr.ins)isIns=true;if(tr.sep||prevDel&&tr.ins){isSep=true;break}if(tr.del)prevDel=true}var start=0;result=partsToHTML(firstParts,match);if(!isSep){start++;result=t({r:match.origReplacements[0],parts:partsToHTML(firstParts,match),index:0})}if(isSep&&isIns)start++;var del=transforms[0]&&transforms[0][1]&&transforms[0][1].del;if(del&&del.match(/^,(.*?),$/)&&del.length>2){return result}for(var i=start;i<transforms.length;i++){var parts=parts=partsAfterSep(transforms[i],isSep);r.push(t({r:match.origReplacements[i],parts:partsToHTML(parts,match)||match.origReplacements[i],index:i}))}return result+r.join("");return JSON.stringify(data)}function transformHasSeparator(t){if(!t)return;var prevDel=false;for(var i=0;i<t.length;i++){if(t[i].sep||t[i].ins&&prevDel)return true;if(t[i].del)prevDel=true}}function toHtml(transforms,match){if((transforms.length>2||transformHasSeparator(transforms[0]))&&match.category!="Articles"&&!match.showTitle){match.cls+=" multiReplace";if(!transformHasSeparator(transforms[0]))match.cls+=" replaceWithoutSep";match.multiReplace=true;return multiReplacesToHTML(transforms,match)}if(transforms.length==1||match.showTitle){return partsToHTML(transforms[0],match)}if(transforms.length==2||match.category=="Articles"||match.category=="Determiners"){match.cls+=" doubleReplace";match.doubleReplace=true;return orPartsToHTML(match.rFirst,transforms[0])+orPartsToHTML(match.r[0],transforms[1])}}function highlightReplaces(match){var del=match.del;for(var i=0;i<match.r.length;i++){var r=match.r[i];match.r[i]=diffochka(del,r)}}function parseTransform(t){t=t.replace("→","<span class='sep'></span>");var el=Under.Util.createEl("<div>"+t+"</div>");var result=[];for(var i=0;i<el.childNodes.length;i++){var node=el.childNodes[i];if(node.nodeType==3){result.push({w:node.nodeValue});continue}if(node.classList.contains("sep")){result.push({sep:true})}if(node.classList.contains("gr_grammar_ins")){result.push({ins:node.innerHTML})}if(node.classList.contains("gr_grammar_del")){result.push({del:node.innerHTML})}}return result}function transformsToJson(match){if(match.notClickableTitle&&!match.showTitle)return[];if(!match.transforms)return[];t=match.transforms;return t.map(function(tr){return parseTransform(tr)})}function header(match){var result=match.title;var transforms=transformsToJson(match);if(transforms&&transforms[0]&&transforms[0].length==2){var t=transforms[0];if(t[0].w&&t[1].ins||t[1].w&&t[0].ins){match.cls+=" only-ins"}if(t[0].w&&t[1].del||t[1].w&&t[0].del){match.cls+=" only-del"}if(t[0].ins&&t[1].del||t[1].ins&&t[0].del){match.cls+=" ins-del"}}if(transforms&&transforms[0]){var t=transforms[0];var v=t[0].del||t[0].ins||t[0].w;if(v.length>20){match.notClickableTitle=true;match.longTitle=true;match.replacementHint=deHtmlize("Click to "+match.todo);return match.title}}result=toHtml(transforms,match);if(transforms.length)match.rHtml=rHTML(transforms,match);if(!result)result=match.v;if(match.replaceInCard)match.replaceInCard=result;if(match.notClickableTitle)result=match.title;return result}function deleteUnused(match){delete match.text;delete match.rid;delete match.action;delete match.undone;delete match.transforms}function processMatch(match,text){match.id=(match.id||guid()).toString();match.s=match.begin;match.e=match.end;match._s=match.s;match._e=match.e;if(match.group=="Plagiarism"){match.highlightBegin=match.s;match.highlightEnd=match.e}if(match.highlightBegin!=undefined&&match.highlightEnd!=undefined&&match.highlightBegin==match.highlightEnd&&match.text.length>0){match.highlightBegin=match.s;match.highlightEnd=match.e}if(match.category=="Enhancement"){match.group="Enhancement"}if(match.highlightBegin!=undefined)match._s=match.highlightBegin;if(match.highlightEnd!=undefined)match._e=match.highlightEnd;match.sd=match._s-match.s;match.ed=match._e-match.e;match._value=text.substring(match._s,match._e);if(match.group=="Spelling")match.group="ContextualSpelling";match.cls=match.group;match.origReplacements=(match.replacements||[]).concat();match.rFirst=match.replacements&&match.group!="Enhancement"&&match.replacements.splice(0,1)[0];match.rFirst=match.rFirst&&match.rFirst.replace(/\s+/g," ");match.noReplacments=match.rFirst===false||match.rFirst==undefined;match.showTitle=match.noReplacments||match.extra_properties&&match.extra_properties.show_title=="true";match.replaceInCard=!match.noReplacments&&match.extra_properties&&match.extra_properties.show_title=="true";match.didYouMean=!match.noReplacments&&match.extra_properties&&match.extra_properties.did_you_mean=="true";match.enhancement=match.replacements&&match.replacements.length&&match.extra_properties&&match.extra_properties.enhancement=="true";match.notClickableTitle=match.noReplacments||match.showTitle||match.didYouMean;match.priority=parseInt(match.extra_properties&&match.extra_properties.priority||0,10);match.r=match.replacements||[];match.rHtml=match.rHtml||[];match.v=match.text;match.oldVal=match.v;match.sid=match.id;match.header=header(match);match.details=details(match);match.examples=examples(match);match.explanation=explanation(match);plagiarism(match);match.l=match.e-match.s;match.multi=match.r.length>0;match.spell=match.group=="ContextualSpelling";match.gramm=!match.spell;match.showReplacements=match.category=="Misspelled"&&match.r.length;match.showReplacementsInText=true;if(match.multiReplace){match.showReplacements=true;match.showReplacementsInText=false;match.showReplacementsOnTop=true}if(match.cls&&match.cls.indexOf("doubleReplace")!=-1){match.showReplacements=false;match.showReplacementsInText=false}if(match.showTitle){match.showReplacements=false;match.showReplacementsOnTop=false;match.showReplacementsInText=false}if(match.showReplacements&&match.del){highlightReplaces(match)}if(match.enhancement){match.category="_"+match.category;match.title=Util.declension(match.r.length,["Suggested enhancement:","Suggested enhancements:"])}if(match.todo=="spelling"){match.todo="correct"}if(match.todo==""&&!match.rFirst||match.category=="Plagiarism"||match.notClickableTitle)match.todo="expand card";if(match.todo==""&&match.rFirst)match.todo="correct";match.value=match.v;match.todo=deHtmlize("Click to "+match.todo);var m=match;deleteUnused(match)}function deHtmlize(html){var el=document.createElement("div");el.innerHTML=html;return el.textContent}}();try{module.exports=MatchTransformer}catch(e){}var PlagiarismSplitter=function(){var emitter=require("emitter"),diffPos=require("textdiff").diffPos,Util=require("./editor-util");var idIndex=0,me=emitter({splitPlagiarism:splitPlagiarism,tryToJoinPlagiarismMatches:tryToJoinPlagiarismMatches});return me;function splitPlagiarism(m,newValue,text){var d=diffPos(m.value,newValue);if(d.s==-1)return false;if(d.delta==newValue.length-m.value.length&&d.s==0)return false;var limit=8;if(newValue.split(" ").length<7)return false;var s=d.s,e=d.s-Math.min(d.delta,0),v1=m.value.substring(0,s),v2=m.value.substring(e,m.value.length),sep=newValue.substring(Math.min(d.s,d.s+d.delta),Math.max(d.s,d.s+d.delta));var doNotSplit=true;var i=0;while(i<sep.length){if(!Util.isSep(sep[i]))doNotSplit=false;i++}if(Math.abs(d.delta)==1&&Util.isSep(newValue[d.s]))doNotSplit=true;if(doNotSplit){if(newValue.split(Util.ALL_SPACE_RE).length<limit)return[];m.value=m._value=m.v=newValue;m.e=m.s+newValue.length;m._e=m.e;return[m]}var words1=v1.split(Util.ALL_SPACE_RE),words2=v2.split(Util.ALL_SPACE_RE);var result=[];if(words1.length>limit){var m1=$.extend(true,{},m);m1.e=m.s+s;if(!Util.isSep(text[m1.e])&&!Util.isSep(v1[v1.length-1])&&!Util.isSep(text[m1.e+1])){var offset=Util.getPrevSepOffset(v1,v1.length-1)+1;v1=v1.substring(0,v1.length-offset);m1.e-=offset}m1.value=m1.v=v1;result.push(m1);m1._e=m1.e}if(words2.length>limit){var m2=$.extend(true,{},m);m2.s=m.s+d.s+d.delta;m2.e=m.e+d.delta;if(!Util.isSep(v2[0])&&!Util.isSep(text[m2.s-1])){var offset=Util.getNextSepOffset(v2,0)+1;v2=v2.substring(offset,v2.length);if(d.delta<0)offset++;m2.s+=offset}m2._s=m2.s;m2._e=m2.e;m2.value=m2.v=v2;result.push(m2);if(m1){delete m1.card;delete m2.card;delete m1.selected;delete m2.selected;delete m1.inDom;delete m2.inDom;m1.id=m1.id+"024"+idIndex++;m2.id=m2.id+"012"+idIndex++;me.emit("split",{m1:m1,m2:m2})}}return result}function collision(a,b){return Math.min(a.e,b.e)-Math.max(a.s,b.s)}function tryToJoinPlagiarismMatches(matches,text){var removeArr=[];matches.sort(function(a,b){return a.s-b.s||b.e-a.e});return;for(var i=0;i<matches.length;i++){var a=matches[i];if(a.category!="Plagiarism")continue;for(var k=i+1;k<matches.length;k++){var b=matches[k];if(b.category!="Plagiarism"||b.removed)continue;if(collision(a,b)<0){if(a.e<b.s){var j=a.e;var join=true;while(j<b.s){if(!Util.isSep(text[j]))join=false;j++}if(!join)continue}else continue}if(a.header==b.header){a.s=Math.min(a.s,b.s);a.e=Math.max(a.e,b.e);a._s=a.s;a._e=a.e;a.v=a.value=text.substring(a.s,a.e);b.removed=true;removeArr.push(b)}}}if(removeArr.length>0){removeArr.forEach(function(m){m.remove()})}}};try{module.exports=PlagiarismSplitter}catch(e){}var SelectionAnimator=function(config){var Under=require("under"),me={animate:animate,remove:remove,complete:complete},css=Under.Util.css,animEl,cls,endEl;return me;function animate(posEls,sel){remove();if(posEls.length==0)return;var startEl=posEls[0],pos;endEl=posEls[posEls.length-1]||startEl;cls="g-selection-anim "+config.editor.matchPrefix;animEl=Under.Util.createEl('<div class="'+cls+'"></div>',startEl.ownerDocument);if(config.getAnimatorElPos){pos=config.getAnimatorElPos(startEl)}else{if(sel){var posStart=startEl.getBoundingClientRect(),posEnd=endEl.getBoundingClientRect(),par=startEl.ownerDocument.querySelector(sel).getBoundingClientRect();pos={left:posStart.left-par.left,right:posEnd.right-par.right,top:posStart.top-par.top,bottom:posStart.bottom-par.bottom,width:posEnd.right-posStart.left,height:posStart.height}}else{pos=posEl.getBoundingClientRect()}}css(animEl,{top:pos.top+pos.height,left:pos.left,width:0});var width20=Math.ceil(pos.width/8),width80=pos.width-width20;animEl.setAttribute("data-width",pos.width);if(!config.animatorContainer){var parent=document.querySelector(sel||"body");parent.appendChild(animEl)}else{config.animatorContainer.appendChild(animEl)}setTimeout(function(){animEl.style.width=width80+"px"},10);me.el=animEl}function remove(){var doc=config.animatorContainer?config.animatorContainer.ownerDocument:document;var els=doc.querySelectorAll(".g-selection-anim"),len=els.length;for(var i=0;i<len;i++){els[i].parentNode.removeChild(els[i])}}function complete(){if(!animEl)return;if(!animEl.getAttribute("data-width"))return remove();css(animEl,{webkitTransitionDuration:"0.2s",MozTransitionDuration:"0.2s",transitionDuration:"0.2s",width:parseInt(animEl.getAttribute("data-width"))})}};try{module.exports=SelectionAnimator}catch(e){}var Synonyms=function(config){var SelectionAnimator=require("./selection-animator"),Under=require("under"),Wrap=require("wrap"),emitter=require("emitter"),lodash=require("lodash");var editor=config.editor,el=config.editor.el,doc=el.ownerDocument,animator=SelectionAnimator(config);config.canRemove=config.canRemove||function(){};var guid=Under.Util.guid,matchesSelector=Under.Util.matchesSelector;var ANIMATION_POS_SELECTOR=config.textareaWrapSelector||"#editor .svg-wrap";var listen=Under.Util.listen,unlisten=Under.Util.unlisten;listen(el,"dblclick",ondblclick);var currentSelection;editor.on("syn",onsyn);var me=emitter({completeAnimation:completeAnimation,removeUnderline:removeUnderline,registerRemove:registerRemove,disable:disable,fieldEnable:fieldEnable});return me;function fieldEnable(){listen(el,"dblclick",ondblclick)}function disable(){removeUnderline();unlisten(el,"dblclick",ondblclick)}function completeAnimation(match){animator.animate(match.getEl(),ANIMATION_POS_SELECTOR);setTimeout(animator.complete,120)}function removeUnderline(){animator.remove()}function ondblclick(e){if(editor.selectedMatch)editor.selectedMatch.deselect();
var selection=editor.getSelection();var value=selection.value;if(!/^\s?[a-z']+\s?$/i.test(value))return;if(value.length<2)return;if(!editor.isTextarea){var node=editor.el.ownerDocument.getSelection().anchorNode||e.target.parentNode;var cls=Wrap.skipClass(),selectors=Wrap.skipTag();for(var i=0;i<cls.length;i++){selectors.push("."+cls[i])}if(!node.tagName)node=node.parentNode;if(matchesSelector(node,selectors.join(",")))return}editor.getSynonyms(selection.s);setSynMatch(selection);registerRemove();return}function registerRemove(){listen(doc.body,"click",removeSyn);listen(doc.body,"input",removeSyn);listen(doc.body,"keydown",removeSyn);function removeSyn(e){if(e.isTrigger||e.clientX==0)return;if(!config.canRemove(e.target))return;removeUnderline();unlisten(doc.body,"click",removeSyn);unlisten(doc.body,"input",removeSyn);unlisten(doc.body,"keydown",removeSyn);if(!_.findWhere(editor.getMatches(),{syn:true}))return;editor.removeSyn();editor.emit("rendered")}}function setSynMatch(selection){var start=selection.s,end=selection.e,value=selection.value;if(value.indexOf(" ")==value.length-1){end-=1;value=selection.text.substr(start,end-start)}currentSelection=selection;var els=editor.dom.renderRange({s:start,e:end});animator.animate(els,ANIMATION_POS_SELECTOR);var len=els.length;for(var i=0;i<len;i++){Wrap.unwrap(els[i])}editor.setCursor(selection)}function onsyn(match){animator.complete();var start=currentSelection.s,end=currentSelection.e,text=currentSelection.value;if(editor.getSelection().value!=text){console.log("selection changed");return}if(text.indexOf(" ")==text.length-1){end-=1;text=currentSelection.text.substr(start,end-start)}if(match.error)return console.warn("Error occured: ",match.error);_.extend(match,{app:"synonyms",addReplace:true,cls:"Synonyms",syn:true,expanded:true,begin:start,end:end,highlightBegin:start,highlightEnd:end,id:guid(),s:start,e:end,_s:start,_e:end,ed:0,sd:0,l:end-start,auto:false,v:text,serverRemove:true,value:text,oldVal:text,animEl:animator.el,todo:""});editor.removeSyn();editor.addSyn(match)}};try{module.exports=Synonyms}catch(e){}var TextApi=function(config){var emitter=require("emitter"),_=require("lodash"),Changesets=require("changesets"),capi=require("./capi");var Capi=config.capi||capi.createClient;var capiClient=Capi({sid:config.sid,docid:config.docid,createWs:config.createWs,url:config.capiUrl});capiClient.on("alert",onadd.bind(this,"error"));capiClient.on("synonyms",onadd.bind(this,"syn"));capiClient.on("socketReconnect",restart);var me=_.extend({text:"",changes:[],sentRev:0,send:send,update:update,restart:restart,reset:reset,checkPlagiarism:checkPlagiarism,getState:getState,setState:setState,onadd:onadd,onfinish:onfinish},capiClient);return me;function update(text){if(text==me.text)return;var cs=Changesets.diff(me.text,text);me.text=text;if(!cs.length)return;me.changes.push(cs)}function reset(){me.changes=[];me.text="";me.sentRev=0;capiClient.rev=0}function restart(){var text=me.text;reset();update(text);send()}function getState(){return{changes:me.changes.map(function(cs){return cs.pack()}),text:me.text,sentRev:me.sentRev}}function setState(state){me.text=state.text;me.changes=state.changes.map(function(cs){return Changesets.unpack(cs)});me.sentRev=state.sentRev;capiClient.rev=state.sentRev}function onfinish(msg){console.log("MIDDLE LOG: finished: "+JSON.stringify(msg));var removed=msg.removed||[];removed.forEach(function(sid){me.emit("remove",sid)});me.emit("finish",msg)}function onadd(type,match){console.log("MIDDLE LOG: received match: "+JSON.stringify(match),type,me.changes.length);updateMatch(match);match.type=type;me.emit("add",match)}function checkMatchOffset(match){if(me.text.substring(match.highlightBegin,match.highlightEnd)!=match.highlightText){return false}return true}function updateMatch(match){var temp=match.begin;for(var i=match.rev+1;i<me.changes.length;i++){applyCsToMatch(me.changes[i],match)}if(match.begin!=temp){console.log("DIFF",match)}if(match.begin>me.text.length){console.log("match offset error",match);me.emit("match-has-wrong-revision",match)}}function applyCsToMatch(cs,match){cs.sequencify().forEach(function(op){applyMatchOffset(op,match,"begin","end");applyMatchOffset(op,match,"highlightBegin","highlightEnd")})}function applyMatchOffset(op,match,keyBegin,keyEnd){if(op.pos+op.len>=match[keyBegin]&&op.pos+op.len<match[keyEnd]){me.emit("ot_alert_intersection")}if(op.type=="+"){if(match[keyBegin]<0||op.pos<=match[keyBegin]){match[keyBegin]+=op.len;match[keyEnd]+=op.len}}else if(op.type=="-"){if(op.pos<match[keyBegin]){match[keyBegin]-=op.len;match[keyEnd]-=op.len}}}function checkPlagiarism(text){me.emit("sending");capiClient.plagiarism(text,function(){me.emit("plagiarismChecked")})}function send(){var changesForRev=me.changes.slice(me.sentRev).map(function(cs){return cs.pack()});if(!changesForRev.length)return;me.emit("sending");var params={};if(config.extendParams)config.extendParams(params);capiClient.submitOt(changesForRev,me.changes.length-1,params,onfinish);me.sentRev=me.changes.length}};try{module.exports=TextApi}catch(e){}var track=function(editor){var storage={},debug=false;editor.id=editor.id||"";editor.on("rendered",function(){try{renderPerformance()}catch(e){}});editor.api.on("submit_ot",startTimerForRev);editor.api.on("finish",sendAlertPerformance);editor.api.on("alert",alertPerformance);editor.api.on("ot_alert_intersection",function(){editor.ot_alert_intersection++});editor.api.on("stats:timing",function(stat){var send={};send[stat.key]=stat.value;editor.emit("track",{type:"timing",data:send})});editor.matches.on("remove",removePerformance);editor.matches.on("lost_match_value_in_text",function(){editor.emit("track",{type:"increment",key:"lost_match_value_in_text:old"})});editor.matches.on("match_is_part_of_word",function(){editor.emit("track",{type:"increment",key:"match_is_part_of_word:old"})});editor.matches.on("remove",removePerformance);function lookTime(key){if(!key||!storage[key]||!storage[key].request)return 0;return Date.now()-storage[key].request}function startTimerForRev(info){var key=editor.id+info.rev;debug&&console.log("SUBMIT_OT",key);storage[key]={request:Date.now()}}function alertPerformance(info){var key=editor.id+info.rev,matchKey=key+info.id,delay=lookTime(key);debug&&console.log("GET_ALERT",delay);storage[matchKey]={time:Date.now(),type:"first"};if(!storage[key])return;if(!storage[key].first){storage[key].first=delay}else{storage[key].last=delay;storage[matchKey].type="last"}}function sendAlertPerformance(info){var key=editor.id+info.rev,data=storage[key],rev0=info.rev==0?"first.":"",send={},textSize=editor.getState().api.changes&&editor.getState().api.changes[info.rev]&&editor.getState().api.changes[info.rev].length;if(!data||!data.first)return;send["performance:checks."+rev0+"request_to_first_response"]=data.first;if(data.last&&textSize){send["checks."+rev0+"request_to_last_response:performance"]=data.last;send["checks."+rev0+"request_to_last_response_by_changes_size:performance"]=Number((data.last/textSize).toFixed(2))}editor.emit("track",{type:"timing",data:send});debug&&console.log("finish:",info.rev,editor.id,send)}function renderPerformance(){var editorState=editor.getState();var trackData=editor.getMatches().filter(function(match){return!match.tracked&&match.renderTs&&storage[editor.id+match.rev+match.id]&&storage[editor.id+match.rev]}).reduce(function(info,match){var resp=storage[editor.id+match.rev+match.id],type=resp.type,requestToRender=match.renderTs-storage[editor.id+match.rev].request,rev0=match.rev==0?"first.":"",textSize=editorState.api.changes&&editorState.api.changes[match.rev]&&editorState.api.changes[match.rev].length;match.tracked=true;info["performance:checks."+rev0+"request_to_"+type+"_render"]=requestToRender;info["performance:checks."+rev0+"response_to_"+type+"_render"]=match.renderTs-resp.time;if(type=="last"&&textSize){info["checks."+rev0+"request_to_last_render_by_changes_size:performance"]=Number((requestToRender/textSize).toFixed(2))}return info},{});if(!Object.keys(trackData).length)return;editor.emit("track",{type:"timing",data:trackData});debug&&console.log("render times: ",trackData)}function removePerformance(info){var rndr=!!info.renderTs;editor.emit("track",{type:"increment",key:"performance:removed_checks.removed_alerts"+(rndr?"_rendered":"")});debug&&console.log("match:",rndr,info.renderTs)}};try{module.exports=track}catch(e){}if(typeof module!="undefined")module.exports=require("./lib/grammarly-editor");